<!DOCTYPE html>
<html lang="es">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Gesti√≥n de Clientes</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Funci√≥n parseAmount espec√≠fica para clientes.html (maneja formato Float 1.000.000,00)
        function parseAmount(amount) {
            if (!amount) return 0;
            
            // Si ya es un n√∫mero, usarlo directamente
            if (typeof amount === 'number') {
                return amount;
            }
            
            // Convertir a string y limpiar
            const cleanAmount = amount.toString().trim();
            
            // Si est√° vac√≠o, devolver 0
            if (!cleanAmount) return 0;
            
            // Remover caracteres no num√©ricos excepto punto y coma
            const numericOnly = cleanAmount.replace(/[^\d.,]/g, '');
            
            // Si no hay n√∫meros, devolver 0
            if (!numericOnly) return 0;
            
            let result;
            
            if (numericOnly.includes(',')) {
                // Formato: "1.000.000,00" -> 1000000.00
                const normalizedValue = numericOnly.replace(/\./g, '').replace(',', '.');
                result = parseFloat(normalizedValue) || 0;
            } else {
                // Formato: "1000000" o "1.000.000" -> 1000000
                const normalizedValue = numericOnly.replace(/\./g, '');
                result = parseFloat(normalizedValue) || 0;
            }
            
            return result;
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Estilos espec√≠ficos para el modal de b√∫squeda de grupos en m√≥vil */
        @media (max-width: 768px) {
            #groupSearchModal .modal-content {
                width: 95% !important;
                max-width: none !important;
                margin: 20px 10px;
                max-height: 90vh;
            }
            
            #groupSearchModal .modal-body {
                padding: 0 16px 16px 16px;
            }
            
            #groupSearchModal .form-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            #groupSearchModal .form-actions .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                min-height: 44px;
            }
            
            #groupSearchModal #groupsList {
                max-height: 150px;
            }
            
            #groupSearchModal .group-item {
                padding: 16px !important;
                margin-bottom: 12px !important;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            
            #groupSearchModal .group-item div:first-child {
                font-size: 16px !important;
                margin-bottom: 6px !important;
            }
            
            #groupSearchModal .group-item div:last-child {
                font-size: 14px !important;
            }
            
            /* Mejorar bot√≥n de b√∫squeda en m√≥vil */
            .form-group .btn {
                min-height: 44px;
                font-size: 14px;
            }
            
            /* Asegurar que el input tenga altura m√≠nima t√°ctil */
            .form-input {
                min-height: 44px;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            margin-bottom: 60px;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 24px;
            justify-content: flex-start;
        }

        .header-logo {
            max-width: 120px;
            height: auto;
            flex-shrink: 0;
        }

        .header-text {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
            text-align: left;
        }

        .header p {
            font-size: 1.1rem;
            color: #86868b;
            font-weight: 400;
            text-align: left;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 48px;
        }

        .form-section {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f2f2f7;
            width: 100%;
        }

        .form-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 24px;
            text-align: center;
        }

        .clients-section {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .search-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f2f2f7;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007aff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #f2f2f7;
            position: relative;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border-color: #007aff;
        }

        .client-card.editing {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .client-card.billed {
            border-left: 4px solid #34c759;
        }

        .client-card.selected {
            border: 2.5px solid #007aff;
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.10);
            transition: border 0.2s, box-shadow 0.2s;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }

        .client-id {
            color: #86868b;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .client-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .client-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-weight: 500;
            color: #86868b;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.95rem;
        }

        .amount-badge {
            background: #34c759;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            width: fit-content;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            width: fit-content;
        }

        .status-billed { background: #34c759; color: white; }
        .status-pending { background: #ff9500; color: white; }
        .status-overdue { background: #ff3b30; color: white; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056cc;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e8e8ed;
        }

        .btn-danger {
            background: #ff3b30;
            color: white;
        }

        .btn-danger:hover {
            background: #d70015;
        }

        .btn-success {
            background: #34c759;
            color: white;
        }

        .btn-success:hover {
            background: #248a3d;
        }

        .btn-warning {
            background: #ff9500;
            color: white;
        }

        .btn-warning:hover {
            background: #cc7700;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1d1d1f;
            font-size: 0.9rem;
        }

        .required {
            color: #ff3b30;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            min-height: 48px;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-input.valid {
            border-color: #34c759;
            box-shadow: 0 0 0 3px rgba(52, 199, 89, 0.1);
        }

        .form-input.invalid {
            border-color: #ff3b30;
            box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.1);
        }

        .form-input.uppercase {
            text-transform: uppercase;
            font-weight: 500;
        }

        .field-help {
            color: #86868b;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
            line-height: 1.3;
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f2f2f7;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #86868b;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #1d1d1f;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        }

        .toast.success { background: #34c759; }
        .toast.error { background: #ff3b30; }
        .toast.warning { background: #ff9500; }
        .toast.show { transform: translateX(0); }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .stat {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #007aff;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .debug-info {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }

        .billing-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .billing-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 0.85rem;
        }

        .billing-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            .header-logo {
                max-width: 100px;
            }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 1rem; text-align: center; }
            .client-details { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
            .client-actions { flex-direction: column; }
            .clients-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr 1fr; }
        }

        /* ===== ESTILOS PARA ETIQUETAS ===== */
        .tags-container {
            position: relative;
        }

        .tags-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .tags-input-container input {
            flex: 1;
        }

        .tags-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .tags-display {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #007aff;
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .tag-chip:hover {
            background: #0056cc;
            transform: translateY(-1px);
        }

        .tag-remove {
            font-weight: bold;
            font-size: 1.1rem;
            line-height: 1;
        }

        .client-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .client-tag-chip {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #bbdefb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .client-tag-chip:hover {
            background: #bbdefb;
            transform: translateY(-1px);
        }

        .tag-remove-small {
            font-weight: bold;
            font-size: 0.9rem;
            line-height: 1;
            margin-left: 4px;
            opacity: 0.7;
        }

        /* Estilos espec√≠ficos para el modal de etiquetas */
        #editTagsModal .tags-suggestions {
            z-index: 1001;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
        }

        #editTagsModal .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            color: #333;
        }

        #editTagsModal .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        #editTagsModal .suggestion-item:last-child {
            border-bottom: none;
        }

        .client-tag-chip:hover .tag-remove-small {
            opacity: 1;
        }

        .add-tag-placeholder {
            display: inline-block;
            padding: 4px 8px;
            color: #86868b;
            border: 1px dashed #d2d2d7;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-tag-placeholder:hover {
            background: #f8f9fa;
            border-color: #007aff;
            color: #007aff;
        }

        .client-tags {
            cursor: pointer;
            min-height: 28px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
    </style>


    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="./Logotipo EasyCars Fondo Blanco con Slogan - Copy.jpg" alt="EasyCars Logo" class="header-logo">
                <div class="header-text">
                    <h1>Gesti√≥n de Clientes</h1>
                    <p>Sistema completo para administrar clientes y contratos de leasing</p>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n de debug -->
        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>Debug Info:</strong><br>
            API URL: <span id="debugApiUrl"></span><br>
            Response Status: <span id="debugStatus"></span><br>
            Response Data: <span id="debugData"></span>
        </div>

        <div class="main-content">
            <!-- Formulario de Cliente -->
            <div class="form-section">
                <h2 id="formTitle">Nuevo Cliente</h2>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="activeContracts">0</div>
                        <div class="stat-label">Con Contratos</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="billedClients">0</div>
                        <div class="stat-label">Facturados</div>
                    </div>
                    <div class="stat" onclick="window.location.href='capturas.html'" style="cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="stat-value" id="totalPending">‚Ç°0</div>
                        <div class="stat-label">Por Cobrar</div>
                        <div style="font-size: 0.7rem; color: #007aff; margin-top: 4px;">üìä Ver Capturas</div>
                    </div>
                </div>

                <form id="clientForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">ID del Cliente <span class="required">*</span></label>
                            <input type="text" class="form-input" id="ID" required placeholder="Solo n√∫meros (9-15 d√≠gitos)" pattern="[0-9]{9,15}" maxlength="15">
                            <small class="field-help">Solo n√∫meros, entre 9 y 15 d√≠gitos</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre Completo <span class="required">*</span></label>
                            <input type="text" class="form-input uppercase" id="Nombre" required placeholder="NOMBRE DEL CLIENTE (se convierte a may√∫sculas)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de Tel√©fono <span class="required">*</span></label>
                            <input type="tel" class="form-input" id="numeroTelefono" placeholder="50688888888" pattern="506[0-9]{8}" maxlength="11">
                            <small class="field-help">Formato: 506 + 8 d√≠gitos (ej: 50688888888)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Placa del Veh√≠culo <span class="required">*</span></label>
                            <input type="text" class="form-input uppercase" id="Placa" placeholder="ABC123 (se convierte a may√∫sculas)" list="placaList">
                            <datalist id="placaList"></datalist>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ID Grupo WhatsApp</label>
                            <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;">
                                <input type="text" class="form-input" id="idGrupoWhatsapp" placeholder="120363295526322228@g.us" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="openGroupSearchModal()" style="white-space: nowrap; padding: 12px 16px; min-height: 44px;">
                                    üîç Buscar Grupo
                                </button>
                            </div>
                            <small class="field-help">Formato: n√∫meros@g.us (ej: 120363295526322228@g.us)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">D√≠a de Pago Semanal</label>
                            <select class="form-input" id="diaPago">
                                <option value="">-- Seleccionar d√≠a de la semana --</option>
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Mi√©rcoles">Mi√©rcoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="S√°bado">S√°bado</option>
                                <option value="Domingo">Domingo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto Semanal del Contrato (‚Ç°)</label>
                            <input type="number" class="form-input" id="montoContrato" step="1000" placeholder="50000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendedor Asignado <span class="required">*</span></label>
                            <select class="form-input" id="ID_Vendedor">
                                <option value="">-- Seleccionar vendedor --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">üè∑Ô∏è Etiquetas</label>
                            <div class="tags-container">
                                <div class="tags-input-container">
                                    <input type="text" class="form-input" id="tagInput" placeholder="Escribir etiqueta y presionar Enter...">
                                    <button type="button" class="btn btn-secondary" onclick="addTag()" style="white-space: nowrap; padding: 12px 16px; min-height: 44px;">
                                        ‚ûï Agregar
                                    </button>
                                </div>
                                <div class="tags-suggestions" id="tagsSuggestions" style="display: none;">
                                    <div class="suggestions-list" id="suggestionsList"></div>
                                </div>
                                <div class="tags-display" id="tagsDisplay"></div>
                            </div>
                            <small class="field-help">Presiona Enter o el bot√≥n para agregar etiquetas. Haz clic en una etiqueta para eliminarla.</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Inicio del Contrato</label>
                            <input type="date" class="form-input" id="fechaContrato">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duraci√≥n del Contrato (semanas)</label>
                            <input type="number" class="form-input" id="plazoContrato" placeholder="52" min="1" max="520">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 16px; margin-top: 32px; justify-content: center; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary btn-large" id="submitBtn">
                            üíæ Guardar Cliente
                        </button>
                        <button type="button" class="btn btn-danger btn-large" id="liberarBtn" onclick="liberarAuto()" style="display: none;">
                            üîì Liberar auto
                        </button>
                        <button type="button" class="btn btn-secondary btn-large" id="cancelBtn" onclick="cancelEdit()" style="display: none;">
                            ‚ùå Cancelar Edici√≥n
                        </button>
                        <button type="button" class="btn btn-secondary btn-large" onclick="toggleDebug()">
                            üêõ Debug
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Clientes -->
            <div class="clients-section">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="üîç Buscar clientes por nombre, ID, placa o tel√©fono..." id="searchInput">
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Cargando clientes...</p>
                </div>

                <div class="clients-grid" id="clientsGrid"></div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>üìã No hay clientes registrados</h3>
                    <p>Utiliza el formulario de arriba para agregar tu primer cliente al sistema</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL_CLIENTS = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
        const API_URL_INVOICES = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
        const API_URL_FLOTA = 'https://sheetdb.io/api/v1/nrzmoa46446mu?sheet=Flota';
        const API_URL_CEDULAS_KEY = 'ac1OXCfZWZXsyaG'; // GoMeta API key
        
        let clients = [];
        let invoices = [];
        let vendors = [];
        let currentClient = null;
        let isEditing = false;
        let allTags = []; // Array para almacenar todas las etiquetas existentes
        let currentTags = []; // Array para las etiquetas del cliente actual

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticaci√≥n antes de inicializar - DESHABILITADO TEMPORALMENTE
            // checkAuthentication();
            initializeApp();
            setupEventListeners();
        });
        
        // Verificar autenticaci√≥n
        function checkAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const isAdmin = urlParams.get('admin') === 'true';
            const isVendor = urlParams.get('vendor') === 'true';
            
            // Si no hay par√°metros de autenticaci√≥n, verificar sesi√≥n
            if (!isAdmin && !isVendor) {
                const session = localStorage.getItem('vendorSession');
                
                if (session) {
                    const sessionData = JSON.parse(session);
                    const now = new Date();
                    const expiresAt = new Date(sessionData.expiresAt);
                    
                    if (now < expiresAt) {
                        console.log('‚úÖ Sesi√≥n v√°lida encontrada');
                        // Redirigir con par√°metros de sesi√≥n
                        if (sessionData.vendorId === '112220831') {
                            window.location.href = '/clientes.html?admin=true';
                        } else {
                            window.location.href = '/clientes.html?vendor=true';
                        }
                        return;
                    } else {
                        console.log('‚ùå Sesi√≥n expirada');
                        localStorage.removeItem('vendorSession');
                    }
                }
                
                // No hay sesi√≥n v√°lida, redirigir al login
                console.log('üîí No hay sesi√≥n v√°lida, redirigiendo al login');
                window.location.href = '/login.html';
                return;
            }
            
            // Si hay par√°metros de autenticaci√≥n, continuar normalmente
            console.log('‚úÖ Acceso autorizado a clientes');
        }

        async function initializeApp() {
            console.log('=== INICIALIZANDO APLICACI√ìN ===');
            showLoading(true);
            
            try {
                // Cargar clientes, facturas y vendedores EN PARALELO
                console.log('Cargando clientes, facturas y vendedores...');
                await Promise.all([
                    loadClientsData(),
                    loadInvoicesData(),
                    loadVendorsData(),
                    loadFlotaPlates()
                ]);
                
                console.log('‚úÖ Todas las cargas completadas');
                console.log('Clientes cargados:', clients.length);
                console.log('Facturas cargadas:', invoices.length);
                console.log('Vendedores cargados:', vendors.length);
                
                // AHORA renderizar la interfaz con todos los datos
                renderClients(clients);
                console.log('üîÑ Antes de llamar updateStats()');
                updateStats();
                console.log('‚úÖ Despu√©s de llamar updateStats()');
                populateVendorSelect();
                // Actualizar requeridos seg√∫n modo
                if (typeof updateRequiredFields === 'function') {
                    updateRequiredFields();
                }
                
                showToast(`Sistema cargado: ${clients.length} clientes, ${invoices.length} facturas, ${vendors.length} vendedores`, 'success');
                
            } catch (error) {
                console.error('Error al inicializar:', error);
                showToast('Error al cargar datos del sistema', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadClientsData() {
            const apiUrl = `${API_URL_CLIENTS}?sheet=Clientes`;
            console.log('Cargando clientes desde:', apiUrl);
            
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            clients = Array.isArray(data) ? data : [];
            clients = clients.filter(client => client.ID && client.ID.toString().trim() !== '');
            
            console.log('Clientes procesados:', clients.length);
        }

        async function loadInvoicesData() {
            const apiUrl = `${API_URL_INVOICES}?sheet=Facturas`;
            console.log('Cargando facturas desde:', apiUrl);
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                invoices = await response.json();
                console.log('‚úÖ Facturas cargadas:', invoices.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando facturas:', error);
                showToast('Error al cargar facturas', 'error');
                invoices = [];
            }
        }
        
        async function loadVendorsData() {
            const apiUrl = `${API_URL_CLIENTS}?sheet=Usuarios`;
            console.log('Cargando vendedores desde:', apiUrl);
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                vendors = await response.json();
                console.log('‚úÖ Vendedores cargados:', vendors.length);
                
            } catch (error) {
                console.error('‚ùå Error cargando vendedores:', error);
                showToast('Error al cargar vendedores', 'error');
                vendors = [];
            }
        }
        
        // Cargar placas desde Flota y poblar datalist
        async function loadFlotaPlates() {
            try {
                console.log('Cargando placas desde Flota:', API_URL_FLOTA);
                const response = await fetch(API_URL_FLOTA);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                const plates = Array.isArray(data) ? data.map(item => (item.Placa || '').toString().trim()).filter(Boolean) : [];
                const uniquePlates = [...new Set(plates)];
                const datalist = document.getElementById('placaList');
                if (datalist) {
                    datalist.innerHTML = uniquePlates.map(p => `<option value="${p}"></option>`).join('');
                }
                console.log(`‚úÖ Placas cargadas desde Flota: ${uniquePlates.length}`);
            } catch (error) {
                console.error('‚ùå Error cargando placas desde Flota:', error);
                // No bloquear la app si falla esta carga
            }
        }
        
        function populateVendorSelect() {
            const vendorSelect = document.getElementById('ID_Vendedor');
            if (!vendorSelect) return;
            
            // Lista fija de vendedores (guardar nombre en ID_Vendedor)
            const FIXED_VENDORS = [
                'Angie Alejandra Cede√±o Medina',
                'Orlando Jes√∫s Gonz√°lez Jim√©nez',
                'Osmy Josu√© Castillo Balladares',
                'David Josue Bravo Corrales',
                'Fernando Rodr√≠guez Mora',
                'Karla Fonseca Arias',
                'JOHNNY ANDRES MORALES REYES',
                'Jeremy Leiva',
                'Daniel Gonzalez Fallas'
            ];
            
            // Limpiar opciones existentes excepto la primera
            vendorSelect.innerHTML = '<option value="">-- Seleccionar vendedor --</option>';
            
            // Agregar opciones fijas (value y label = nombre)
            FIXED_VENDORS.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                vendorSelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            // B√∫squeda en tiempo real
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function(e) {
                filterClients(e.target.value);
            });
            
            // Navegar al primer resultado al presionar Enter en la b√∫squeda
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Obtener el t√©rmino de b√∫squeda
                    const searchTerm = e.target.value.trim();
                    
                    if (searchTerm) {
                        // Filtrar clientes
                        const filtered = clients.filter(client => 
                            (client.Nombre || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.ID || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.numeroTelefono || '').toString().toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (client.Placa || '').toLowerCase().includes(searchTerm.toLowerCase())
                        );
                        
                        // Si hay resultados, navegar al primero
                        if (filtered.length > 0) {
                            const firstClient = filtered[0];
                            console.log('üöÄ Navegando al primer resultado:', firstClient.Nombre, 'ID:', firstClient.ID);
                            viewInvoices(firstClient.ID);
                        } else {
                            // Si no hay resultados, solo filtrar
                            filterClients(searchTerm);
                        }
                    } else {
                        // Si no hay t√©rmino de b√∫squeda, solo filtrar
                        filterClients(searchTerm);
                    }
                }
            });

            // Formulario de cliente
            document.getElementById('clientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                console.group('ü™≤ DEBUG Guardar Cliente - submit handler');
                try {
                    const idVal = (document.getElementById('ID') || { value: '' }).value;
                    const nameVal = (document.getElementById('Nombre') || { value: '' }).value;
                    console.log('isEditing:', isEditing);
                    console.log('ID ingresado:', idVal);
                    console.log('Nombre ingresado:', nameVal);
                    console.time('validateForm');
                    const isValid = await validateForm();
                    console.timeEnd('validateForm');
                    console.log('Resultado validateForm:', isValid);
                    if (!isValid) {
                        console.groupEnd();
                        return;
                    }
                    console.time('saveClient');
                    await saveClient();
                    console.timeEnd('saveClient');
                } catch (err) {
                    console.error('DEBUG submit error:', err);
                } finally {
                    console.groupEnd();
                }
            });

            // Validaci√≥n en tiempo real del ID
            document.getElementById('ID').addEventListener('input', function(e) {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                validateID(e.target);
            });

            // Blur del ID: mantener verificaci√≥n informativa y autocompletar nombre desde API (sin bloquear)
            document.getElementById('ID').addEventListener('blur', async function(e) {
                const cedula = (e.target.value || '').trim();
                if (!cedula) return;
                console.group('ü™≤ DEBUG Cedula API (blur)');
                try {
                    // Verificaci√≥n informativa (no bloquea)
                    await checkIDExists(e.target);
                    // Autocompletar nombre solo si est√° vac√≠o
                    const nameInput = document.getElementById('Nombre');
                    if (nameInput && !nameInput.value.trim()) {
                        await fetchCedulaNameAndFill(cedula);
                    } else {
                        console.log('Nombre ya presente: se omite autocompletar');
                    }
                } catch (err) {
                    console.warn('DEBUG cedula blur error:', err);
                } finally {
                    console.groupEnd();
                }
            });

            // Validaci√≥n en tiempo real del tel√©fono
            document.getElementById('numeroTelefono').addEventListener('input', function(e) {
                const value = e.target.value;
                e.target.value = value.replace(/[^0-9]/g, '');
                validatePhone(e.target);
            });

            // Validaci√≥n en tiempo real del ID de WhatsApp
            document.getElementById('idGrupoWhatsapp').addEventListener('input', function(e) {
                validateWhatsAppID(e.target);
                // Si el valor queda vac√≠o mientras se edita, actualizar visibilidad del bot√≥n
                const liberarBtn = document.getElementById('liberarBtn');
                if (liberarBtn) {
                    const clientHasGroup = (currentClient && currentClient.idGrupoWhatsapp && currentClient.idGrupoWhatsapp.trim() !== '');
                    const inputHasValue = (e.target.value || '').trim() !== '';
                    liberarBtn.style.display = (isEditing && (clientHasGroup || inputHasValue)) ? 'inline-flex' : 'none';
                }
            });

            // ===== NUEVO: CONVERSI√ìN AUTOM√ÅTICA A MAY√öSCULAS =====
            // Nombre del cliente
            document.getElementById('Nombre').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            // Placa del veh√≠culo
            document.getElementById('Placa').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            // ===== EVENT LISTENERS PARA ETIQUETAS =====
            // Input de etiquetas
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });

            // Autocompletado de etiquetas
            document.getElementById('tagInput').addEventListener('input', function(e) {
                showTagSuggestions();
            });

            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                const suggestions = document.getElementById('tagsSuggestions');
                const tagInput = document.getElementById('tagInput');
                if (!suggestions.contains(e.target) && !tagInput.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        async function loadClients() {
            // Esta funci√≥n ahora solo recarga y re-renderiza
            console.log('=== RECARGANDO CLIENTES ===');
            showLoading(true);
            try {
                await loadClientsData();
                await loadInvoicesData(); // Tambi√©n recargar facturas por si cambiaron
                await loadVendorsData(); // Recargar vendedores por si cambiaron
                loadAllTags(); // Cargar todas las etiquetas
                renderClients(clients);
                updateStats();
            } catch (error) {
                console.error('Error al recargar clientes:', error);
                showToast('Error al recargar clientes: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadInvoices() {
            // Esta funci√≥n ahora solo recarga facturas
            console.log('=== RECARGANDO FACTURAS ===');
            try {
                await loadInvoicesData();
                renderClients(clients); // Re-renderizar para actualizar botones
                updateStats();
            } catch (error) {
                console.error('Error al recargar facturas:', error);
            }
        }

        function updateOverdueFines() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Resetear horas para comparaci√≥n exacta
            
            console.log('\n=== DEBUG FECHAS DE VENCIMIENTO ===');
            console.log('Hoy (objeto Date):', today);
            console.log('Hoy (string):', formatDateForDB(today));
            
            let hasUpdates = false;
            let totalProcessed = 0;
            let totalPending = 0;
            let totalOverdue = 0;
            let debugCount = 0;
            
            invoices.forEach(invoice => {
                if (invoice.Estado === 'Pendiente' || invoice.Estado === 'Vencido') {
                    totalProcessed++;
                    const dueDateStr = invoice.FechaVencimiento;
                    
                    // Debug solo las primeras 5 facturas
                    if (debugCount < 5) {
                        console.log(`\n--- DEBUG FACTURA ${invoice.NumeroFactura} ---`);
                        console.log('Fecha vencimiento (string):', dueDateStr);
                        
                        const dueDate = parseDate(dueDateStr);
                        console.log('Fecha vencimiento (parseada):', dueDate);
                        
                        if (dueDate) {
                            console.log('¬øEs v√°lida?:', dueDate instanceof Date && !isNaN(dueDate));
                            console.log('¬øHoy > Vencimiento?:', today > dueDate);
                            
                            const diffTime = today.getTime() - dueDate.getTime();
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            console.log('Diferencia en d√≠as:', diffDays);
                        }
                        debugCount++;
                    }
                    
                    // Validar que la fecha de vencimiento sea v√°lida
                    if (!dueDateStr || dueDateStr === '' || dueDateStr === 'undefined') {
                        console.warn('Factura con fecha inv√°lida:', invoice.NumeroFactura);
                        return;
                    }
                    
                    let newStatus = 'Pendiente';
                    let newDaysOverdue = 0;
                    let newFines = 0;
                    
                    // Parsear la fecha de vencimiento
                    const dueDate = parseDate(dueDateStr);
                    
                    if (!dueDate || isNaN(dueDate)) {
                        console.warn(`Fecha inv√°lida para factura ${invoice.NumeroFactura}:`, dueDateStr);
                        return; // Saltar esta factura
                    }
                    
                    // Resetear horas para comparaci√≥n exacta
                    dueDate.setHours(0, 0, 0, 0);
                    
                    // Comparaci√≥n directa de fechas (objetos Date)
                    if (today > dueDate) {
                        // Hoy es DESPU√âS del d√≠a de vencimiento = Vencida
                        const diffTime = today.getTime() - dueDate.getTime();
                        newDaysOverdue = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        newFines = newDaysOverdue * 2000;
                        newStatus = 'Vencido';
                        totalOverdue++;
                        
                        if (debugCount <= 5) {
                            console.log(`‚ö†Ô∏è FACTURA VENCIDA: ${invoice.NumeroFactura}, d√≠as: ${newDaysOverdue}`);
                        }
                    } else {
                        // Hoy es el d√≠a de vencimiento o antes = Pendiente
                        newDaysOverdue = 0;
                        newFines = 0;
                        newStatus = 'Pendiente';
                        totalPending++;
                        
                        if (debugCount <= 5) {
                            console.log(`‚úÖ FACTURA PENDIENTE: ${invoice.NumeroFactura}`);
                        }
                    }
                    
                    const newTotal = parseAmount(invoice.MontoBase || 0) + newFines;
                    
                    // Solo actualizar si hay cambios
                    if (invoice.DiasAtraso != newDaysOverdue || 
                        invoice.MontoMultas != newFines || 
                        invoice.Estado !== newStatus) {
                        
                        invoice.DiasAtraso = newDaysOverdue;
                        invoice.MontoMultas = newFines;
                        invoice.MontoTotal = newTotal;
                        invoice.Estado = newStatus;
                        hasUpdates = true;
                    }
                }
            });
            
            console.log(`\n=== RESUMEN FINAL ===`);
            console.log(`Procesadas: ${totalProcessed} | Pendientes: ${totalPending} | Vencidas: ${totalOverdue}`);
            
            if (hasUpdates) {
                console.log('‚úÖ Estados actualizados');
            }
        }

        function updateDebugInfo(key, value) {
            const element = document.getElementById(`debug${key}`);
            if (element) {
                element.textContent = value;
            }
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function getClientBillingInfo(clientId) {
            // Asegurar que clientId sea string para comparaci√≥n
            const searchId = clientId.toString();
            
            const clientInvoices = invoices.filter(inv => {
                const invClientId = inv.ID_Cliente ? inv.ID_Cliente.toString() : '';
                return invClientId === searchId;
            });
            
            if (clientInvoices.length === 0) {
                return { status: 'not_billed', invoices: [], summary: null };
            }

			// Determinar si existen facturas de leasing (excluyendo manuales)
			const isManualInvoice = (inv) => (
				inv.TipoFactura === 'Manual' ||
				(inv.NumeroFactura && inv.NumeroFactura.startsWith('MAN-')) ||
				!!inv.ConceptoManual
			);

			const leasingInvoices = clientInvoices.filter(inv => !isManualInvoice(inv));

			// Si solo existen facturas manuales, considerar NO facturado (permitir tiraje de leasing)
			if (leasingInvoices.length === 0) {
				return { status: 'not_billed', invoices: clientInvoices, summary: null };
			}
			
			// Contar por estado SOLO para facturas de leasing
			const pending = leasingInvoices.filter(inv => inv.Estado === 'Pendiente');
			const overdue = leasingInvoices.filter(inv => inv.Estado === 'Vencido');	
			const paid = leasingInvoices.filter(inv => inv.Estado === 'Pagado');
			
			const totalPending = pending.reduce((sum, inv) => sum + parseAmount(inv.MontoTotal || 0), 0);
			const totalOverdue = overdue.reduce((sum, inv) => sum + parseAmount(inv.MontoTotal || 0), 0);
			const totalFines = leasingInvoices.reduce((sum, inv) => sum + parseAmount(inv.MontoMultas || 0), 0);
			
			return {
				status: 'billed',
				invoices: leasingInvoices,
				summary: {
					total: leasingInvoices.length,
					pending: pending.length,
					overdue: overdue.length,
					paid: paid.length,
					totalPending,
					totalOverdue,
					totalFines
				}
			};
        }

        function renderClients(clientsToRender) {
            console.log('üé® Iniciando renderClients con', clientsToRender?.length, 'clientes');
            
            try {
                const grid = document.getElementById('clientsGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (!clientsToRender || clientsToRender.length === 0) {
                    grid.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';
                
                grid.innerHTML = clientsToRender.map(client => {
                    const hasContract = client.fechaContrato && client.montoContrato && client.plazoContrato;
                    const billingInfo = getClientBillingInfo(client.ID);
                    const isBilled = billingInfo.status === 'billed';
                    // Determinar qu√© bot√≥n mostrar
                    let actionButton = '';
                    if (hasContract) {
                        if (!isBilled) {
                            actionButton = `
                                <button class="btn btn-success" onclick="event.stopPropagation(); billClient('${client.ID}')" id="billBtn-${client.ID}">
                                    üìÑ Facturar
                                </button>
                            `;
                        } else {
                            actionButton = `
                                <button class="btn btn-warning" onclick="event.stopPropagation(); viewInvoices('${client.ID}')">
                                    üìã Ver Facturas
                                </button>
                            `;
                        }
                    } else {
                        actionButton = `
                            <button class="btn btn-secondary" disabled title="Contrato incompleto">
                                üìÑ Sin Contrato
                            </button>
                        `;
                    }
                    let billingStatusHtml = '';
                    if (isBilled && billingInfo.summary) {
                        const s = billingInfo.summary;
                        billingStatusHtml = `
                            <div class="billing-status">
                                <div class="billing-summary">
                                    <div class="billing-item">
                                        <div style="color: #34c759; font-weight: 600;">${s.paid}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Pagadas</div>
                                    </div>
                                    <div class="billing-item">
                                        <div style="color: #ff9500; font-weight: 600;">${s.pending}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Pendientes</div>
                                    </div>
                                    <div class="billing-item">
                                        <div style="color: #ff3b30; font-weight: 600;">${s.overdue}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Vencidas</div>
                                    </div>
                                    <div class="billing-item">
                                        <div style="color: #ff3b30; font-weight: 600;">‚Ç°${s.totalFines.toLocaleString('es-CR')}</div>
                                        <div style="font-size: 0.75rem; color: #86868b;">Multas</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    return `
                        <div class="client-card ${isBilled ? 'billed' : ''}" id="card-${client.ID}" onclick="viewInvoices('${client.ID}')" style="cursor: pointer;">
                            <div class="client-header">
                                <div class="client-info">
                                    <div class="client-name">${client.Nombre || 'Sin nombre'}</div>
                                    <div class="client-id">ID: ${client.ID || 'Sin ID'}${client.idContrato ? ` ¬∑ Contrato #${client.idContrato}` : ''}</div>
                                </div>
                            </div>
                            <div class="client-details">
                                ${client.numeroTelefono ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Tel√©fono</span>
                                        <span class="detail-value">${client.numeroTelefono.toString().replace(/^(506)(\d{4})(\d{4})$/, '$1 $2 $3')}</span>
                                    </div>
                                ` : ''}
                                ${client.Placa ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Placa</span>
                                        <span class="detail-value">${client.Placa}</span>
                                    </div>
                                ` : ''}
                                ${client.idGrupoWhatsapp ? `
                                    <div class="detail-row">
                                        <span class="detail-label">WhatsApp</span>
                                        <span class="detail-value" style="font-size: 0.85rem; word-break: break-all;">${client.idGrupoWhatsapp}</span>
                                    </div>
                                ` : ''}
                                <div class="detail-row" style="grid-column: 1 / -1;">
                                    <span class="detail-label">Etiquetas</span>
                                    <span class="detail-value">
                                        <div class="client-tags" onclick="event.stopPropagation(); editClientTags('${client.ID}')">
                                            ${client.Etiquetas ? parseTags(client.Etiquetas).map(tag => `
                                                <span class="client-tag-chip" onclick="event.stopPropagation(); removeClientTag('${client.ID}', '${tag}')">
                                                    ${tag} <span class="tag-remove-small">√ó</span>
                                                </span>
                                            `).join('') : ''}
                                            <span class="add-tag-placeholder" onclick="event.stopPropagation(); editClientTags('${client.ID}')">+ Agregar etiqueta</span>
                                        </div>
                                    </span>
                                </div>
                                ${client.diaPago ? `
                                    <div class="detail-row">
                                        <span class="detail-label">D√≠a de Pago</span>
                                        <span class="detail-value">${client.diaPago}</span>
                                    </div>
                                ` : ''}
                                ${hasContract ? `
                                    <div class="detail-row">
                                        <span class="detail-label">Monto Semanal</span>
                                        <span class="detail-value amount-badge">‚Ç°${parseAmount(client.montoContrato || 0).toLocaleString('es-CR')}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Fecha Inicio</span>
                                        <span class="detail-value">${formatDateForDisplay(client.fechaContrato)}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Duraci√≥n</span>
                                        <span class="detail-value">${client.plazoContrato} semanas</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Total Contrato</span>
                                        <span class="detail-value amount-badge">‚Ç°${(parseAmount(client.montoContrato || 0) * parseInt(client.plazoContrato || 0)).toLocaleString('es-CR')}</span>
                                    </div>
                                    <div class="detail-row" style="grid-column: 1 / -1;">
                                        <span class="detail-label">Estado Facturaci√≥n</span>
                                        <span class="detail-value">
                                            <span class="status-badge ${isBilled ? 'status-billed' : 'status-pending'}">
                                                ${isBilled ? '‚úÖ Facturado' : '‚è≥ Sin Facturar'}
                                            </span>
                                        </span>
                                    </div>
                                ` : `
                                    <div class="detail-row" style="grid-column: 1 / -1;">
                                        <span class="detail-label">Estado del Contrato</span>
                                        <span class="detail-value" style="color: #ff9500; font-weight: 600;">‚ö†Ô∏è Informaci√≥n de contrato incompleta</span>
                                    </div>
                                `}
                            </div>
                            ${billingStatusHtml}
                            <div class="client-actions" style="margin-top: 18px; justify-content: flex-start;">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); editClient('${client.ID}')">
                                    ‚úèÔ∏è Editar
                                </button>
                                ${actionButton}
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteClient('${client.ID}')">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error en renderClients:', error);
                showToast('Error al renderizar clientes: ' + error.message, 'error');
            }
        }

        function filterClients(searchTerm) {
            if (!searchTerm.trim()) {
                renderClients(clients);
                return;
            }

            const filtered = clients.filter(client => {
                const searchLower = searchTerm.toLowerCase();
                const nameMatch = (client.Nombre || '').toLowerCase().includes(searchLower);
                const idMatch = (client.ID || '').toString().toLowerCase().includes(searchLower);
                const phoneMatch = (client.numeroTelefono || '').toString().toLowerCase().includes(searchLower);
                const plateMatch = (client.Placa || '').toLowerCase().includes(searchLower);
                
                // B√∫squeda por etiquetas
                let tagsMatch = false;
                if (client.Etiquetas) {
                    const clientTags = parseTags(client.Etiquetas);
                    tagsMatch = clientTags.some(tag => tag.toLowerCase().includes(searchLower));
                }
                
                return nameMatch || idMatch || phoneMatch || plateMatch || tagsMatch;
            });
            
            renderClients(filtered);
        }

        function updateStats() {
            console.log('üìä Iniciando updateStats()...');
            console.log('üìä Variables disponibles:', {
                clients: clients.length,
                invoices: invoices.length,
                vendors: vendors.length
            });
            
            try {
                const totalClients = clients.length;
                const activeContracts = clients.filter(client => 
                    client.fechaContrato && client.montoContrato && client.plazoContrato
                ).length;
                const billedClients = clients.filter(client => 
                    getClientBillingInfo(client.ID).status === 'billed'
                ).length;
                
                console.log('üìä Estad√≠sticas calculadas:', {
                    totalClients,
                    activeContracts,
                    billedClients
                });
            
                const totalPending = invoices
                    .filter(inv => {
                        // Incluir facturas con estado "Vencido" O facturas pendientes que ya vencieron
                        if (inv.Estado === 'Vencido') return true;
                        
                        // Verificar si es una factura pendiente que ya venci√≥
                        if (inv.Estado === 'Pendiente' && inv.FechaVencimiento) {
                            const fechaVencimiento = parseDate(inv.FechaVencimiento);
                            const hoy = new Date();
                            return fechaVencimiento < hoy;
                        }
                        
                        return false;
                    })
                    .reduce((sum, inv) => {
                        // Parsear montos como enteros, no decimales
                        // Limpiar formato costarricense: "104.000" -> "104000"
                        const montoBaseRaw = (inv.MontoTotal || '0').toString();
                        const multasRaw = (inv.Multas || '0').toString();
                        
                        // Remover puntos (separadores de miles) y convertir a entero
                        const montoBase = parseInt(montoBaseRaw.replace(/\./g, ''));
                        const multas = parseInt(multasRaw.replace(/\./g, ''));
                        const subtotal = montoBase + multas;
                        
                        // Debug individual
                        if (montoBase > 0 || multas > 0) {
                            console.log(`üîç Factura ${inv.ID_Factura}: Raw="${montoBaseRaw}"->${montoBase}, MultasRaw="${multasRaw}"->${multas}, Subtotal=${subtotal}`);
                        }
                        
                        return sum + subtotal;
                    }, 0);

            // Debug: Mostrar informaci√≥n sobre las facturas
            console.log('üîç DEBUG - C√°lculo POR COBRAR:');
            console.log('Total facturas cargadas:', invoices.length);
            
            // Verificar facturas vencidas por estado
            const facturasVencidasPorEstado = invoices.filter(inv => inv.Estado === 'Vencido');
            console.log('Facturas con estado "Vencido":', facturasVencidasPorEstado.length);
            
            // Verificar facturas pendientes que ya vencieron
            const facturasPendientesVencidas = invoices.filter(inv => {
                if (inv.Estado === 'Pendiente' && inv.FechaVencimiento) {
                    const fechaVencimiento = parseDate(inv.FechaVencimiento);
                    const hoy = new Date();
                    return fechaVencimiento < hoy;
                }
                return false;
            });
            console.log('Facturas pendientes que ya vencieron:', facturasPendientesVencidas.length);
            
            console.log('Facturas por estado:', invoices.reduce((acc, inv) => {
                acc[inv.Estado] = (acc[inv.Estado] || 0) + 1;
                return acc;
            }, {}));
            
            // Mostrar todos los estados √∫nicos para verificar
            const estadosUnicos = [...new Set(invoices.map(inv => inv.Estado))];
            console.log('üìä Estados √∫nicos encontrados:', estadosUnicos);
            
            // Mostrar detalle de facturas vencidas por estado
            if (facturasVencidasPorEstado.length > 0) {
                console.log('üìã Detalle facturas con estado "Vencido":');
                facturasVencidasPorEstado.forEach(inv => {
                    console.log(`- ${inv.ID_Factura}: Monto=${inv.MontoTotal}, Multas=${inv.Multas}, Estado=${inv.Estado}`);
                });
            }
            
            // Mostrar detalle de facturas pendientes que ya vencieron
            if (facturasPendientesVencidas.length > 0) {
                console.log('üìã Detalle facturas pendientes vencidas:');
                facturasPendientesVencidas.slice(0, 5).forEach(inv => {
                    const fechaVencimiento = parseDate(inv.FechaVencimiento);
                    const hoy = new Date();
                    const diasVencida = Math.floor((hoy - fechaVencimiento) / (1000 * 60 * 60 * 24));
                    console.log(`- ${inv.ID_Factura}: MontoRaw="${inv.MontoTotal}", MultasRaw="${inv.Multas}", FechaVencimiento=${inv.FechaVencimiento}, Vencida hace ${diasVencida} d√≠as`);
                });
                if (facturasPendientesVencidas.length > 5) {
                    console.log(`... y ${facturasPendientesVencidas.length - 5} m√°s`);
                }
            }
            
            console.log('üí∞ Total POR COBRAR calculado:', totalPending);

                document.getElementById('totalClients').textContent = totalClients;
                document.getElementById('activeContracts').textContent = activeContracts;
                document.getElementById('billedClients').textContent = billedClients;
                // Formatear n√∫mero manualmente para evitar problemas con toLocaleString
                const formattedAmount = Math.round(totalPending).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                document.getElementById('totalPending').textContent = `‚Ç°${formattedAmount}`;
            } catch (error) {
                console.error('Error en updateStats:', error);
                showToast('Error al actualizar estad√≠sticas', 'error');
            }
        }

        async function billClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }

            // Verificar que el contrato est√© completo
            if (!client.fechaContrato || !client.montoContrato || !client.plazoContrato) {
                showToast('El contrato del cliente est√° incompleto', 'error');
                return;
            }

            // Verificar si ya est√° facturado
            const billingInfo = getClientBillingInfo(clientId);
            if (billingInfo.status === 'billed') {
                showToast('Este cliente ya ha sido facturado', 'warning');
                return;
            }

            // Deshabilitar bot√≥n mientras procesa
            const billBtn = document.getElementById(`billBtn-${clientId}`);
            if (billBtn) {
                billBtn.disabled = true;
                billBtn.textContent = '‚è≥ Facturando...';
            }

            try {
                const invoicesData = generateInvoicesForClient(client);
                
                // Enviar todas las facturas en lote
                const response = await fetch(`${API_URL_INVOICES}?sheet=Facturas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(invoicesData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
                }

                // Recargar facturas y actualizar vista
                await loadInvoices();
                renderClients(clients);
                updateStats();
                
                // ===== NUEVO: REDIRIGIR AUTOM√ÅTICAMENTE A LA P√ÅGINA DE FACTURAS =====
                showToast(`‚úÖ Cliente facturado exitosamente: ${invoicesData.length} facturas generadas. Redirigiendo a facturas...`, 'success');
                
                // Mostrar contador regresivo y redirigir
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        showToast(`üîÑ Redirigiendo a facturas en ${countdown} segundos...`, 'warning');
                    } else {
                        clearInterval(countdownInterval);
                        window.location.href = `https://arrendautos.app/facturas.html?clientId=${clientId}`;
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error al facturar cliente:', error);
                showToast('Error al generar facturas: ' + error.message, 'error');
                
                // Restaurar bot√≥n
                if (billBtn) {
                    billBtn.disabled = false;
                    billBtn.textContent = 'üìÑ Facturar';
                }
            }
        }

        function generateInvoicesForClient(client) {
            const invoicesData = [];
            const signDate = parseDate(client.fechaContrato); // Fecha de firma usando parseDate
            const contractStartDate = new Date(signDate);
            contractStartDate.setDate(signDate.getDate() + 1); // Contrato inicia un d√≠a despu√©s
            
            console.log(`Fecha de firma: ${client.fechaContrato}`);
            console.log(`Fecha de inicio contrato: ${formatDateForDB(contractStartDate)}`);
            
            const weeklyAmount = parseAmount(client.montoContrato);
            const totalWeeks = parseInt(client.plazoContrato);
            const paymentDay = client.diaPago;
            
            // Obtener el √∫ltimo n√∫mero de factura para generar consecutivos
            let lastInvoiceNumber = 0;
            invoices.forEach(inv => {
                if (inv.NumeroFactura && inv.NumeroFactura.startsWith('FAC-')) {
                    const num = parseInt(inv.NumeroFactura.split('-')[1]);
                    if (num > lastInvoiceNumber) {
                        lastInvoiceNumber = num;
                    }
                }
            });

            // MODIFICADO: Solo generar las primeras 26 semanas para mejorar rendimiento
            const weeksToGenerate = Math.min(totalWeeks, 26);
            
            for (let week = 1; week <= weeksToGenerate; week++) {
                // Calcular fecha de inicio de la semana (desde el d√≠a que inicia el contrato)
                const weekStartDate = new Date(contractStartDate);
                weekStartDate.setDate(contractStartDate.getDate() + (week - 1) * 7);
                
                // Calcular fecha de fin de la semana
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setDate(weekStartDate.getDate() + 6);
                
                // Calcular fecha de vencimiento (un d√≠a despu√©s del fin de semana)
                const dueDate = getNextPaymentDate(weekEndDate, paymentDay);
                
                // Generar descripci√≥n de la semana
                const weekDescription = generateWeekDescription(weekStartDate, weekEndDate);
                
                // N√∫mero de factura consecutivo
                lastInvoiceNumber++;
                const invoiceNumber = `FAC-${lastInvoiceNumber.toString().padStart(3, '0')}`;
                
                const invoiceData = {
                    ID_Cliente: client.ID.toString(),
                    NumeroFactura: invoiceNumber,
                    SemanaNumero: week.toString(),
                    SemanaDescripcion: weekDescription,
                    FechaVencimiento: formatDateForStorage(dueDate), // DD/MM/YYYY para Google Sheets
                    MontoBase: weeklyAmount.toString(),
                    DiasAtraso: '0',
                    MontoMultas: '0',
                    MontoTotal: weeklyAmount.toString(),
                    Estado: 'Pendiente',
                    FechaCreacion: formatDateForStorage(new Date()), // DD/MM/YYYY para Google Sheets
                    FechaPago: '',
                    Observaciones: `Factura generada autom√°ticamente para ${client.Nombre} (${weeksToGenerate} de ${totalWeeks} semanas)`
                };
                
                invoicesData.push(invoiceData);
            }
            
            return invoicesData;
        }

        function getNextPaymentDate(weekEndDate, paymentDay) {
            // La fecha de vencimiento es simplemente un d√≠a despu√©s del fin de semana
            const dueDate = new Date(weekEndDate);
            dueDate.setDate(weekEndDate.getDate() + 1);
            return dueDate;
        }

        function generateWeekDescription(startDate, endDate) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const startDay = startDate.getDate();
            const startMonth = months[startDate.getMonth()];
            const startYear = startDate.getFullYear();
            
            const endDay = endDate.getDate();
            const endMonth = months[endDate.getMonth()];
            const endYear = endDate.getFullYear();
            
            if (startMonth === endMonth && startYear === endYear) {
                return `Semana del ${startDay} al ${endDay} de ${startMonth} del ${startYear}`;
            } else if (startYear === endYear) {
                return `Semana del ${startDay} de ${startMonth} al ${endDay} de ${endMonth} del ${startYear}`;
            } else {
                return `Semana del ${startDay} de ${startMonth} del ${startYear} al ${endDay} de ${endMonth} del ${endYear}`;
            }
        }

        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Detectar si es formato DD/MM/YYYY (como viene de Google Sheets)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript usa meses 0-11
                    const year = parseInt(parts[2]);
                    
                    // Validar que los valores sean razonables
                    if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 2025) {
                        return new Date(year, month, day);
                    }
                }
            }
            
            // Si es formato YYYY-MM-DD (como formatDateForDB)
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // JavaScript usa meses 0-11
                    const day = parseInt(parts[2]);
                    
                    if (day >= 1 && day <= 31 && month >= 0 && month <= 11 && year >= 2025) {
                        return new Date(year, month, day);
                    }
                }
            }
            
            console.warn('Fecha no reconocida:', dateString);
            return null;
        }

        function formatDateForDisplay(dateString) {
            const date = parseDate(dateString);
            return date ? date.toLocaleDateString('es-CR') : dateString;
        }

        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`; // YYYY-MM-DD para logging/debugging
        }

        function formatDateForStorage(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`; // DD/MM/YYYY para Google Sheets
        }

        // FUNCI√ìN MODIFICADA: Ahora redirige a URL externa
        async function viewInvoices(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }
            // Redirigir a la URL correcta - siempre permitir navegaci√≥n
            window.location.href = `https://arrendautos.app/facturas.html?clientId=${clientId}`;
        }

        async function markAsPaid(invoiceNumber) {
            try {
                // Usar URLSearchParams para SheetDB PATCH
                const params = new URLSearchParams();
                params.append('sheet', 'Facturas'); // Especificar la hoja
                params.append('Estado', 'Pagado');
                params.append('FechaPago', formatDateForStorage(new Date())); // DD/MM/YYYY para Google Sheets
                
                const response = await fetch(`${API_URL_INVOICES}/NumeroFactura/${invoiceNumber}?${params.toString()}`, {
                    method: 'PATCH'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                await loadInvoices();
                renderClients(clients);
                updateStats();
                
                showToast(`Factura ${invoiceNumber} marcada como pagada`, 'success');
                
            } catch (error) {
                console.error('Error al marcar como pagado:', error);
                showToast('Error al actualizar factura: ' + error.message, 'error');
            }
        }

        function editClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) return;

            currentClient = client;
            isEditing = true;

            document.getElementById('formTitle').textContent = 'Editar Cliente';
            document.getElementById('submitBtn').innerHTML = 'üíæ Actualizar Cliente';
            document.getElementById('cancelBtn').style.display = 'inline-flex';

            fillForm(client);
            document.getElementById('ID').disabled = true;

            // Mostrar/ocultar bot√≥n Liberar seg√∫n exista idGrupoWhatsapp
            const liberarBtn = document.getElementById('liberarBtn');
            if (liberarBtn) {
                if (client.idGrupoWhatsapp && client.idGrupoWhatsapp.trim() !== '') {
                    liberarBtn.style.display = 'inline-flex';
                } else {
                    liberarBtn.style.display = 'none';
                }
            }

            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('editing');
            });
            document.getElementById(`card-${clientId}`).classList.add('editing');

            // En modo edici√≥n, estos campos no son obligatorios
            if (typeof updateRequiredFields === 'function') {
                updateRequiredFields();
            }

            document.querySelector('.form-section').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function cancelEdit() {
            currentClient = null;
            isEditing = false;

            document.getElementById('formTitle').textContent = 'Nuevo Cliente';
            document.getElementById('submitBtn').innerHTML = 'üíæ Guardar Cliente';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('ID').disabled = false;

            clearForm();
            clearValidationStyles();

            // Ocultar el bot√≥n Liberar al salir de edici√≥n
            const liberarBtn = document.getElementById('liberarBtn');
            if (liberarBtn) {
                liberarBtn.style.display = 'none';
            }

            document.querySelectorAll('.client-card').forEach(card => {
                card.classList.remove('editing');
            });

            // En modo agregar, estos campos son obligatorios
            if (typeof updateRequiredFields === 'function') {
                updateRequiredFields();
            }
        }

        function clearValidationStyles() {
            const inputs = ['ID', 'numeroTelefono', 'idGrupoWhatsapp'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                }
            });
        }

        function fillForm(client) {
            document.getElementById('ID').value = client.ID || '';
            document.getElementById('Nombre').value = client.Nombre || '';
            document.getElementById('numeroTelefono').value = client.numeroTelefono || '';
            document.getElementById('idGrupoWhatsapp').value = client.idGrupoWhatsapp || '';
            document.getElementById('Placa').value = client.Placa || '';
            document.getElementById('montoContrato').value = client.montoContrato || '';
            document.getElementById('fechaContrato').value = client.fechaContrato || '';
            document.getElementById('plazoContrato').value = client.plazoContrato || '';
            document.getElementById('diaPago').value = client.diaPago || '';
            document.getElementById('ID_Vendedor').value = client.ID_Vendedor || '';
            
            // Cargar etiquetas
            currentTags = parseTags(client.Etiquetas || '');
            updateTagsDisplay();

            // Sincronizar visibilidad del bot√≥n Liberar al llenar el formulario
            const liberarBtn = document.getElementById('liberarBtn');
            if (liberarBtn) {
                if (client.idGrupoWhatsapp && client.idGrupoWhatsapp.trim() !== '') {
                    liberarBtn.style.display = 'inline-flex';
                } else {
                    liberarBtn.style.display = 'none';
                }
            }
        }

        function clearForm() {
            document.getElementById('clientForm').reset();
            currentTags = [];
            updateTagsDisplay();
        }

        function validateID(input) {
            const value = input.value;
            const isValid = value.length >= 9 && value.length <= 15 && /^[0-9]+$/.test(value);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        // ===== FUNCI√ìN: VERIFICAR SI EL ID YA EXISTE (SOLO INFORMATIVA, NO BLOQUEA) =====
        async function checkIDExists(input) {
            const value = input.value.trim();
            
            // Si no hay valor, no verificar
            if (!value) {
                return false;
            }
            
            // Verificar formato b√°sico primero
            if (!validateID(input)) {
                return false;
            }
            
            try {
                console.log('üîç Verificando si el ID ya existe:', value);
                
                // Buscar en la lista de clientes cargados
                const existingClient = clients.find(client => 
                    client.ID && client.ID.toString() === value.toString()
                );
                
                if (existingClient) {
                    console.log('‚ö†Ô∏è ID ya existe (permitido):', existingClient.Nombre);
                    
                    // Confirmaci√≥n visual no bloqueante
                    input.style.borderColor = '#34c759';
                    input.style.boxShadow = '0 0 0 3px rgba(52, 199, 89, 0.1)';
                    
                    return true; // El ID existe, pero se permite continuar
                } else {
                    console.log('‚úÖ ID disponible:', value);
                    
                    // Mostrar confirmaci√≥n visual
                    input.style.borderColor = '#34c759';
                    input.style.boxShadow = '0 0 0 3px rgba(52, 199, 89, 0.1)';
                    
                    return false; // El ID no existe
                }
                
            } catch (error) {
                console.error('‚ùå Error verificando ID:', error);
                return false;
            }
        }

        function validatePhone(input) {
            const value = input.value;
            const isValid = value === '' || (/^506[0-9]{8}$/.test(value) && value.length === 11);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid && value ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid && value ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        function validateWhatsAppID(input) {
            const value = input.value.trim();
            const isValid = value === '' || /^[0-9]+@g\.us$/.test(value);
            
            if (value && !isValid) {
                input.style.borderColor = '#ff3b30';
                input.style.boxShadow = '0 0 0 3px rgba(255, 59, 48, 0.1)';
            } else {
                input.style.borderColor = isValid && value ? '#34c759' : '#d2d2d7';
                input.style.boxShadow = isValid && value ? '0 0 0 3px rgba(52, 199, 89, 0.1)' : '';
            }
            
            return isValid;
        }

        async function validateForm() {
            const idInput = document.getElementById('ID');
            const phoneInput = document.getElementById('numeroTelefono');
            const whatsappInput = document.getElementById('idGrupoWhatsapp');
            const nameInput = document.getElementById('Nombre');
            const plateInput = document.getElementById('Placa');
            const vendorSelect = document.getElementById('ID_Vendedor');
            console.group('ü™≤ DEBUG validateForm');
            console.log('isEditing:', isEditing);
            console.log('ID:', idInput && idInput.value);
            console.log('Nombre:', nameInput && nameInput.value);
            
            
            if (!idInput.value) {
                showToast('El ID del cliente es obligatorio', 'error');
                idInput.focus();
                console.log('Motivo fallo: ID vac√≠o');
                console.groupEnd();
                return false;
            }
            
            if (!validateID(idInput)) {
                showToast('El ID debe tener entre 9 y 15 d√≠gitos num√©ricos', 'error');
                idInput.focus();
                console.log('Motivo fallo: ID formato inv√°lido');
                console.groupEnd();
                return false;
            }
            
            // Validaci√≥n de ID duplicado ya no bloquea creaci√≥n; solo informativa en blur
            
            if (!nameInput.value.trim()) {
                showToast('El nombre del cliente es obligatorio', 'error');
                nameInput.focus();
                console.log('Motivo fallo: Nombre vac√≠o');
                console.groupEnd();
                return false;
            }
            
            // Reglas de requeridos: solo al agregar (no en edici√≥n)
            if (!isEditing) {
                if (!phoneInput.value.trim()) {
                    showToast('El n√∫mero de tel√©fono es obligatorio', 'error');
                    phoneInput.focus();
                    console.log('Motivo fallo: Tel√©fono vac√≠o');
                    console.groupEnd();
                    return false;
                }
                if (!validatePhone(phoneInput)) {
                    showToast('El tel√©fono debe tener el formato: 506 + 8 d√≠gitos (ej: 50688888888)', 'error');
                    phoneInput.focus();
                    console.log('Motivo fallo: Tel√©fono formato inv√°lido');
                    console.groupEnd();
                    return false;
                }
                if (!plateInput.value.trim()) {
                    showToast('La placa del veh√≠culo es obligatoria', 'error');
                    plateInput.focus();
                    console.log('Motivo fallo: Placa vac√≠a');
                    console.groupEnd();
                    return false;
                }
                // Validar que la placa exista en Flota
                const plateValue = plateInput.value.trim().toUpperCase();
                const datalist = document.getElementById('placaList');
                const options = Array.from(datalist ? datalist.options : []);
                const existsInFlota = options.some(opt => (opt.value || '').toUpperCase() === plateValue);
                if (!existsInFlota) {
                    showToast('La placa no existe en Flota. Seleccione una placa v√°lida.', 'error');
                    plateInput.focus();
                    console.log('Motivo fallo: Placa no existe en Flota');
                    console.groupEnd();
                    return false;
                }
                if (!vendorSelect.value.trim()) {
                    showToast('El vendedor asignado es obligatorio', 'error');
                    vendorSelect.focus();
                    console.log('Motivo fallo: Vendedor vac√≠o');
                    console.groupEnd();
                    return false;
                }
            } else {
                // En edici√≥n, si hay tel√©fono, validar formato
                if (phoneInput.value && !validatePhone(phoneInput)) {
                    showToast('El tel√©fono debe tener el formato: 506 + 8 d√≠gitos (ej: 50688888888)', 'error');
                    phoneInput.focus();
                    console.log('Motivo fallo: Tel√©fono formato inv√°lido (edici√≥n)');
                    console.groupEnd();
                    return false;
                }
            }

            if (whatsappInput.value && !validateWhatsAppID(whatsappInput)) {
                showToast('El ID de WhatsApp debe tener el formato: n√∫meros@g.us (ej: 120363295526322228@g.us)', 'error');
                whatsappInput.focus();
                console.log('Motivo fallo: WhatsApp ID formato inv√°lido');
                console.groupEnd();
                return false;
            }
            console.groupEnd();
            
            return true;
        }

        // Actualiza attributes required seg√∫n modo agregar/editar
        function updateRequiredFields() {
            const phoneInput = document.getElementById('numeroTelefono');
            const plateInput = document.getElementById('Placa');
            const vendorSelect = document.getElementById('ID_Vendedor');
            const required = !isEditing;
            if (phoneInput) phoneInput.required = required;
            if (plateInput) plateInput.required = required;
            if (vendorSelect) vendorSelect.required = required;
        }

        // ===== FUNCIONES DE ETIQUETAS =====
        function addTag() {
            const tagInput = document.getElementById('tagInput');
            const tag = tagInput.value.trim();
            
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                updateTagsDisplay();
                tagInput.value = '';
                
                // Agregar a todas las etiquetas si no existe
                if (!allTags.includes(tag)) {
                    allTags.push(tag);
                }
            }
        }

        function removeTag(tagToRemove) {
            currentTags = currentTags.filter(tag => tag !== tagToRemove);
            updateTagsDisplay();
        }

        function updateTagsDisplay() {
            const tagsDisplay = document.getElementById('tagsDisplay');
            tagsDisplay.innerHTML = currentTags.map(tag => `
                <span class="tag-chip" onclick="removeTag('${tag}')">
                    ${tag} <span class="tag-remove">√ó</span>
                </span>
            `).join('');
        }

        function parseTags(tagsString) {
            if (!tagsString || tagsString.trim() === '') {
                return [];
            }
            return tagsString.split(';').map(tag => tag.trim()).filter(tag => tag !== '');
        }

        function formatTags(tagsArray) {
            return tagsArray.join(';');
        }

        function loadAllTags() {
            // Extraer todas las etiquetas de todos los clientes
            allTags = [];
            console.log('loadAllTags - Total clients:', clients.length);
            
            clients.forEach((client, index) => {
                console.log(`loadAllTags - Client ${index + 1}:`, client.Nombre, 'Etiquetas:', client.Etiquetas);
                if (client.Etiquetas) {
                    const clientTags = parseTags(client.Etiquetas);
                    console.log(`loadAllTags - Parsed tags for ${client.Nombre}:`, clientTags);
                    clientTags.forEach(tag => {
                        if (!allTags.includes(tag)) {
                            allTags.push(tag);
                        }
                    });
                }
            });
            console.log('loadAllTags - Total tags loaded:', allTags.length);
            console.log('loadAllTags - All tags content:', JSON.stringify(allTags));
        }

        function showTagSuggestions() {
            const tagInput = document.getElementById('tagInput');
            const suggestions = document.getElementById('tagsSuggestions');
            const suggestionsList = document.getElementById('suggestionsList');
            const inputValue = tagInput.value.toLowerCase();
            
            if (inputValue.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(inputValue) && 
                !currentTags.includes(tag)
            );
            
            if (filteredTags.length > 0) {
                suggestionsList.innerHTML = filteredTags.map(tag => `
                    <div class="suggestion-item" onclick="selectSuggestion('${tag}')">
                        ${tag}
                    </div>
                `).join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        function selectSuggestion(tag) {
            document.getElementById('tagInput').value = tag;
            document.getElementById('tagsSuggestions').style.display = 'none';
            addTag();
        }

        // Autocompletar nombre desde API de c√©dulas
        async function fetchCedulaNameAndFill(cedula) {
            try {
                if (!cedula) return;
                const url = `https://apis.gometa.org/cedulas/${cedula}&key=${API_URL_CEDULAS_KEY}`;
                console.log('Consultando c√©dula en GoMeta:', url);
                const resp = await fetch(url);
                if (!resp.ok) {
                    // No bloquear flujo si falla
                    console.warn('No se pudo consultar c√©dula:', resp.status, await resp.text());
                    return;
                }
                const data = await resp.json();
                const r = data && Array.isArray(data.results) && data.results[0] ? data.results[0] : {};
                // Construir: firstname1 + firstname2 + lastname1 + lastname2
                let composed = [r.firstname1, r.firstname2, r.lastname1, r.lastname2]
                    .filter(part => part && String(part).trim() !== '')
                    .join(' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                // Fallback: firstname + lastname
                if (!composed) {
                    const alt = [r.firstname, r.lastname]
                        .filter(part => part && String(part).trim() !== '')
                        .join(' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    if (alt) composed = alt;
                }

                // Fallback: nombre del root o fullname del result
                if (!composed) {
                    composed = (data && data.nombre) || (r && r.fullname) || '';
                }

                if (composed) {
                    const nameInput = document.getElementById('Nombre');
                    if (nameInput && !nameInput.value.trim()) {
                        nameInput.value = composed.toUpperCase();
                    }
                }
            } catch (err) {
                console.warn('Error consultando c√©dula:', err);
            }
        }

        // ===== FUNCIONES PARA EDITAR ETIQUETAS DESDE TARJETAS =====
        function editClientTags(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) {
                showToast('Cliente no encontrado', 'error');
                return;
            }

            // Cargar todas las etiquetas antes de abrir el modal
            loadAllTags();
            console.log('editClientTags - All tags after loading:', allTags);

            // Crear modal para editar etiquetas
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'editTagsModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>üè∑Ô∏è Editar Etiquetas - ${client.Nombre}</h3>
                        <button class="modal-close" onclick="closeEditTagsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Etiquetas Actuales</label>
                            <div class="tags-container">
                                <div class="tags-input-container">
                                    <input type="text" class="form-input" id="modalTagInput" placeholder="Escribir etiqueta y presionar Enter...">
                                    <button type="button" class="btn btn-secondary" onclick="addModalTag()" style="white-space: nowrap; padding: 12px 16px; min-height: 44px;">
                                        ‚ûï Agregar
                                    </button>
                                </div>
                                <div class="tags-suggestions" id="modalTagsSuggestions" style="display: none;">
                                    <div class="suggestions-list" id="modalSuggestionsList"></div>
                                </div>
                                <div class="tags-display" id="modalTagsDisplay"></div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeEditTagsModal()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="saveClientTags('${clientId}')">üíæ Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Cargar etiquetas actuales
            const currentClientTags = parseTags(client.Etiquetas || '');
            window.modalCurrentTags = [...currentClientTags];
            updateModalTagsDisplay();
            
            // Mostrar modal primero
            setTimeout(() => {
                modal.classList.add('show');
                
                // Event listeners para el modal (despu√©s de que est√© visible)
                const modalTagInput = document.getElementById('modalTagInput');
                if (modalTagInput) {
                    modalTagInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addModalTag();
                        }
                    });

                    modalTagInput.addEventListener('input', function(e) {
                        showModalTagSuggestions();
                    });
                }
                
                // Cerrar sugerencias al hacer clic fuera del modal
                const modalContent = modal.querySelector('.modal-content');
                const modalTagsSuggestions = document.getElementById('modalTagsSuggestions');
                
                document.addEventListener('click', function closeModalSuggestions(e) {
                    if (!modalContent.contains(e.target) && !modalTagsSuggestions.contains(e.target)) {
                        modalTagsSuggestions.style.display = 'none';
                    }
                });
            }, 10);
        }

        function addModalTag() {
            const tagInput = document.getElementById('modalTagInput');
            const tag = tagInput.value.trim();
            
            if (tag && !window.modalCurrentTags.includes(tag)) {
                window.modalCurrentTags.push(tag);
                updateModalTagsDisplay();
                tagInput.value = '';
                
                // Agregar a todas las etiquetas si no existe
                if (!allTags.includes(tag)) {
                    allTags.push(tag);
                }
            }
        }

        function removeModalTag(tagToRemove) {
            window.modalCurrentTags = window.modalCurrentTags.filter(tag => tag !== tagToRemove);
            updateModalTagsDisplay();
        }

        function updateModalTagsDisplay() {
            const tagsDisplay = document.getElementById('modalTagsDisplay');
            tagsDisplay.innerHTML = window.modalCurrentTags.map(tag => `
                <span class="tag-chip" onclick="removeModalTag('${tag}')">
                    ${tag} <span class="tag-remove">√ó</span>
                </span>
            `).join('');
        }

        function showModalTagSuggestions() {
            const tagInput = document.getElementById('modalTagInput');
            const suggestions = document.getElementById('modalTagsSuggestions');
            const suggestionsList = document.getElementById('modalSuggestionsList');
            const inputValue = tagInput.value.toLowerCase();
            
            console.log('Modal tag suggestions - Input value:', inputValue);
            console.log('Modal tag suggestions - All tags:', allTags);
            console.log('Modal tag suggestions - Current modal tags:', window.modalCurrentTags);
            console.log('Modal tag suggestions - All tags content:', JSON.stringify(allTags));
            console.log('Modal tag suggestions - Current modal tags content:', JSON.stringify(window.modalCurrentTags));
            
            // Verificar si los elementos existen
            console.log('Modal tag suggestions - tagInput exists:', !!tagInput);
            console.log('Modal tag suggestions - suggestions exists:', !!suggestions);
            console.log('Modal tag suggestions - suggestionsList exists:', !!suggestionsList);
            
            if (!tagInput || !suggestions || !suggestionsList) {
                console.error('Modal tag suggestions - Missing DOM elements');
                return;
            }
            
            if (inputValue.length === 0) {
                suggestions.style.display = 'none';
                console.log('Modal tag suggestions - Hiding suggestions (empty input)');
                return;
            }
            
            const filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(inputValue) && 
                !window.modalCurrentTags.includes(tag)
            );
            
            console.log('Modal tag suggestions - Filtered tags:', filteredTags);
            
            if (filteredTags.length > 0) {
                const suggestionsHTML = filteredTags.map(tag => `
                    <div class="suggestion-item" onclick="selectModalSuggestion('${tag}')">
                        ${tag}
                    </div>
                `).join('');
                
                console.log('Modal tag suggestions - Generated HTML:', suggestionsHTML);
                
                suggestionsList.innerHTML = suggestionsHTML;
                suggestions.style.display = 'block';
                
                console.log('Modal tag suggestions - Suggestions displayed, count:', suggestionsList.children.length);
                console.log('Modal tag suggestions - Suggestions style display:', suggestions.style.display);
                console.log('Modal tag suggestions - Suggestions computed style:', window.getComputedStyle(suggestions).display);
            } else {
                suggestions.style.display = 'none';
                console.log('Modal tag suggestions - Hiding suggestions (no matches)');
            }
        }

        function selectModalSuggestion(tag) {
            document.getElementById('modalTagInput').value = tag;
            document.getElementById('modalTagsSuggestions').style.display = 'none';
            addModalTag();
        }

        async function saveClientTags(clientId) {
            try {
                const client = clients.find(c => c.ID.toString() === clientId.toString());
                if (!client) {
                    showToast('Cliente no encontrado', 'error');
                    return;
                }

                const updatedTags = formatTags(window.modalCurrentTags);
                
                // Actualizar en la API
                const response = await fetch(`${API_URL_CLIENTS}/ID/${clientId}?sheet=Clientes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Etiquetas: updatedTags
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Actualizar cliente local
                client.Etiquetas = updatedTags;
                
                // Re-renderizar clientes
                renderClients(clients);
                
                // Cerrar modal
                closeEditTagsModal();
                
                showToast('Etiquetas actualizadas correctamente', 'success');
                
            } catch (error) {
                console.error('Error al guardar etiquetas:', error);
                showToast('Error al actualizar etiquetas: ' + error.message, 'error');
            }
        }

        function closeEditTagsModal() {
            const modal = document.getElementById('editTagsModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
            window.modalCurrentTags = [];
        }

        async function removeClientTag(clientId, tagToRemove) {
            try {
                const client = clients.find(c => c.ID.toString() === clientId.toString());
                if (!client) {
                    showToast('Cliente no encontrado', 'error');
                    return;
                }

                const currentTags = parseTags(client.Etiquetas || '');
                const updatedTags = currentTags.filter(tag => tag !== tagToRemove);
                const updatedTagsString = formatTags(updatedTags);
                
                // Actualizar en la API
                const response = await fetch(`${API_URL_CLIENTS}/ID/${clientId}?sheet=Clientes`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        Etiquetas: updatedTagsString
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Actualizar cliente local
                client.Etiquetas = updatedTagsString;
                
                // Re-renderizar clientes
                renderClients(clients);
                
                showToast(`Etiqueta "${tagToRemove}" eliminada`, 'success');
                
            } catch (error) {
                console.error('Error al eliminar etiqueta:', error);
                showToast('Error al eliminar etiqueta: ' + error.message, 'error');
            }
        }

        // Utilidad: obtener siguiente idContrato √∫nico a partir de la lista actual
        function getNextContractId() {
            const existingIds = Array.isArray(clients)
                ? clients
                    .map(c => {
                        const n = parseInt((c.idContrato || c.ID_Contrato || c.IdContrato || c.id_contrato), 10);
                        return Number.isFinite(n) ? n : null;
                    })
                    .filter(n => n !== null)
                : [];
            return existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
        }

        function isDuplicateContractError(status, text) {
            const t = (text || '').toLowerCase();
            return status === 409 ||
                   t.includes('duplicate') || t.includes('duplicado') || t.includes('ya existe') ||
                   (t.includes('idcontrato') && (t.includes('existe') || t.includes('unique') || t.includes('duplic')));
        }

        async function saveClient() {
            console.group('ü™≤ DEBUG saveClient');
            const formData = {
                ID: document.getElementById('ID').value.trim(),
                Nombre: document.getElementById('Nombre').value.trim().toUpperCase(),
                numeroTelefono: document.getElementById('numeroTelefono').value.trim(),
                idGrupoWhatsapp: document.getElementById('idGrupoWhatsapp').value.trim(),
                Placa: document.getElementById('Placa').value.trim().toUpperCase(),
                montoContrato: document.getElementById('montoContrato').value.trim(),
                fechaContrato: document.getElementById('fechaContrato').value.trim(),
                plazoContrato: document.getElementById('plazoContrato').value.trim(),
                diaPago: document.getElementById('diaPago').value.trim(),
                ID_Vendedor: document.getElementById('ID_Vendedor').value.trim(),
                Etiquetas: formatTags(currentTags)
            };
            console.log('Payload a enviar:', JSON.parse(JSON.stringify(formData)));
            console.log('isEditing:', isEditing);
            console.log('Clientes cargados (para referencia):', Array.isArray(clients) ? clients.length : 'no array');

            if (!formData.ID || !formData.Nombre) {
                showToast('Por favor completa los campos obligatorios (ID y Nombre)', 'error');
                console.log('Motivo cancelaci√≥n: faltan obligatorios');
                console.groupEnd();
                return;
            }

            // Se permite crear con IDs duplicados
            // Generar idContrato secuencial √∫nico solo al crear
            if (!isEditing) {
                formData.idContrato = getNextContractId();
                console.log('Asignando idContrato inicial:', formData.idContrato);
            }
            if (!isEditing) {
                const exists = Array.isArray(clients) && clients.some(c => c.ID && c.ID.toString() === formData.ID.toString());
                console.log('Existe ID en memoria (solo info, permitido):', exists);
            }

            try {
                let response;
                console.time('fetch saveClient');
                
                if (isEditing) {
                    // Para actualizar, usar el formato correcto de SheetDB PATCH
                    const updateUrl = `${API_URL_CLIENTS}/ID/${currentClient.ID}`;
                    
                    // Crear URLSearchParams para los datos de actualizaci√≥n
                    const params = new URLSearchParams();
                    params.append('sheet', 'Clientes'); // Especificar la hoja
                    
                    Object.keys(formData).forEach(key => {
                        if (key !== 'ID') { // No incluir ID en la actualizaci√≥n
                            // Nota: En edici√≥n normal no enviamos vac√≠os (evita borrar accidentalmente campos)
                            if (formData[key] !== '') {
                                params.append(key, formData[key]);
                            }
                        }
                    });
                    
                    response = await fetch(`${updateUrl}?${params.toString()}`, {
                        method: 'PATCH'
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Respuesta HTTP no OK (PATCH):', errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                } else {
                    // Crear con reintentos si idContrato choca
                    let attempt = 0;
                    let lastErrorText = '';
                    while (attempt < 5) {
                        if (attempt > 0) {
                            // Refrescar y asignar siguiente disponible
                            await loadClients();
                            formData.idContrato = getNextContractId();
                            console.log(`Reintento #${attempt}: nuevo idContrato =>`, formData.idContrato);
                        }
                        response = await fetch(`${API_URL_CLIENTS}?sheet=Clientes`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        if (response.ok) {
                            break;
                        }
                        lastErrorText = await response.text();
                        console.warn('POST no OK:', response.status, lastErrorText);
                        if (!isDuplicateContractError(response.status, lastErrorText)) {
                            // Error distinto a duplicado -> abortar
                            throw new Error(`HTTP ${response.status}: ${lastErrorText}`);
                        }
                        attempt++;
                    }
                    if (!response || !response.ok) {
                        throw new Error(`No se pudo asignar un idContrato √∫nico despu√©s de ${attempt} intentos. ${lastErrorText || ''}`);
                    }
                }

                console.timeEnd('fetch saveClient');
                console.log('HTTP status:', response && response.status, response && response.statusText);

                cancelEdit();
                await loadClients();
                console.log('Post-guardado: clientes recargados:', Array.isArray(clients) ? clients.length : 'no array');
                
                // Mejorar experiencia de usuario: filtrar y mostrar solo el cliente reci√©n guardado
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    // Llenar el campo de b√∫squeda con el nombre del cliente
                    searchInput.value = formData.Nombre;
                    // Filtrar la lista para mostrar solo este cliente
                    filterClients(formData.Nombre);
                }
                
                // Hacer scroll hacia la tarjeta del cliente
                setTimeout(() => {
                    const clientCard = document.getElementById(`card-${formData.ID}`);
                    if (clientCard) {
                        clientCard.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 100);
                
                showToast(isEditing ? 'Cliente actualizado correctamente' : 'Cliente creado correctamente', 'success');
            } catch (error) {
                console.error('Error en saveClient:', error);
                showToast('Error al guardar cliente: ' + error.message, 'error');
            } finally {
                console.groupEnd();
            }
        }

        async function deleteClient(clientId) {
            const client = clients.find(c => c.ID.toString() === clientId.toString());
            if (!client) return;

            if (!confirm(`¬øEst√°s seguro de que deseas eliminar al cliente "${client.Nombre}"?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL_CLIENTS}/ID/${clientId}?sheet=Clientes`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Error al eliminar cliente');

                await loadClients();
                showToast('Cliente eliminado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al eliminar cliente: ' + error.message, 'error');
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('clientsGrid');
            
            if (show) {
                loading.style.display = 'block';
                grid.style.display = 'none';
            } else {
                loading.style.display = 'none';
                grid.style.display = 'grid';
            }
        }

        function showToast(message, type) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== LIBERAR AUTO: Limpia idGrupoWhatsapp del cliente actual =====
        async function liberarAuto() {
            try {
                if (!isEditing || !currentClient) {
                    showToast('Primero selecciona un cliente para editar', 'warning');
                    return;
                }

                const confirmMsg = `¬øSeguro que deseas liberar el auto de "${currentClient.Nombre}"?\nEsto borrar√° el ID de Grupo WhatsApp del cliente.`;
                if (!confirm(confirmMsg)) return;

                const clientId = currentClient.ID;
                const updateUrl = `${API_URL_CLIENTS}/ID/${clientId}?sheet=Clientes`;

                const response = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idGrupoWhatsapp: '' })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                // Actualizar estado local
                currentClient.idGrupoWhatsapp = '';
                const formInput = document.getElementById('idGrupoWhatsapp');
                if (formInput) formInput.value = '';

                // Ocultar bot√≥n liberar
                const liberarBtn = document.getElementById('liberarBtn');
                if (liberarBtn) liberarBtn.style.display = 'none';

                // Refrescar lista y estad√≠sticas
                await loadClients();
                renderClients(clients);
                updateStats();

                showToast('Auto liberado: grupo de WhatsApp eliminado', 'success');
            } catch (error) {
                console.error('Error al liberar auto:', error);
                showToast('Error al liberar auto: ' + error.message, 'error');
            }
        }

        // ===== FUNCIONES PARA B√öSQUEDA DE GRUPOS DE WHATSAPP =====
        
        // Configuraci√≥n de la API de UltraMsg
        const ULTRA_MSG_CONFIG = {
            instanceId: "instance112077",
            token: "wp98xs1qrfhqg9ya"
        };

        function openGroupSearchModal() {
            // Primero verificar si hay valor en el campo placa
            const placaValue = document.getElementById('Placa').value.trim();
            
            if (placaValue) {
                // Si hay placa, usar autom√°ticamente para buscar grupos
                document.getElementById('groupNameInput').value = placaValue;
                searchWhatsAppGroups();
            } else {
                // Si no hay placa, mostrar el modal para que el usuario digite
                const modal = document.getElementById('groupSearchModal');
                modal.classList.add('show');
                
                // Limpiar campos anteriores
                document.getElementById('groupNameInput').value = '';
                document.getElementById('searchResults').style.display = 'none';
                document.getElementById('searchLoading').style.display = 'none';
                document.getElementById('groupsList').innerHTML = '';
                
                // Enfocar el campo de entrada
                setTimeout(() => {
                    document.getElementById('groupNameInput').focus();
                }, 100);
            }
        }

        function closeGroupSearchModal() {
            const modal = document.getElementById('groupSearchModal');
            modal.classList.remove('show');
        }

        async function searchWhatsAppGroups() {
            const groupName = document.getElementById('groupNameInput').value.trim();
            
            if (!groupName) {
                showToast('Por favor ingresa el nombre del grupo a buscar', 'warning');
                return;
            }

            // Asegurar que el modal est√© visible para mostrar resultados
            const modal = document.getElementById('groupSearchModal');
            if (!modal.classList.contains('show')) {
                modal.classList.add('show');
            }

            const searchLoading = document.getElementById('searchLoading');
            const searchResults = document.getElementById('searchResults');
            const groupsList = document.getElementById('groupsList');

            try {
                // Mostrar loading
                searchLoading.style.display = 'block';
                searchResults.style.display = 'none';
                groupsList.innerHTML = '';

                // Llamar a la API de UltraMsg
                const url = `https://api.ultramsg.com/${ULTRA_MSG_CONFIG.instanceId}/chats?token=${ULTRA_MSG_CONFIG.token}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // Filtrar solo grupos que contengan el nombre buscado
                const grupos = data.filter(g => 
                    g.isGroup && 
                    g.name && 
                    g.name.toLowerCase().includes(groupName.toLowerCase())
                );

                // Ocultar loading
                searchLoading.style.display = 'none';

                if (grupos.length === 0) {
                    groupsList.innerHTML = '<p style="color: #86868b; text-align: center; padding: 20px;">No se encontraron grupos con ese nombre.</p>';
                    searchResults.style.display = 'block';
                    return;
                }

                // Mostrar resultados
                let html = '';
                grupos.forEach(grupo => {
                    html += `
                        <div class="group-item" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s;" 
                             onmouseover="this.style.backgroundColor='#f8f9fa'" 
                             onmouseout="this.style.backgroundColor='white'"
                             onclick="selectGroup('${grupo.id}', '${grupo.name.replace(/'/g, "\\'")}')">
                            <div style="font-weight: 600; color: #1d1d1f; margin-bottom: 4px;">${grupo.name}</div>
                            <div style="font-size: 0.85rem; color: #86868b;">ID: ${grupo.id}</div>
                        </div>
                    `;
                });

                groupsList.innerHTML = html;
                searchResults.style.display = 'block';

            } catch (error) {
                console.error('Error al buscar grupos:', error);
                searchLoading.style.display = 'none';
                showToast('Error al buscar grupos: ' + error.message, 'error');
            }
        }

        function selectGroup(groupId, groupName) {
            // Rellenar el campo ID del grupo
            document.getElementById('idGrupoWhatsapp').value = groupId;
            
            // Cerrar el modal
            closeGroupSearchModal();
            
            // Mostrar notificaci√≥n de √©xito
            showToast(`Grupo seleccionado: ${groupName}`, 'success');
        }

        // Permitir b√∫squeda con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const groupNameInput = document.getElementById('groupNameInput');
            if (groupNameInput) {
                groupNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchWhatsAppGroups();
                    }
                });
            }
        });
    </script>

    <!-- Modal para buscar grupos de WhatsApp -->
    <div class="modal-overlay" id="groupSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîç Buscar Grupo de WhatsApp</h3>
                <button class="modal-close" onclick="closeGroupSearchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre del Grupo</label>
                    <input type="text" class="form-input" id="groupNameInput" placeholder="Ingresa el nombre del grupo a buscar...">
                    <small class="field-help">Escribe parte del nombre del grupo para buscarlo</small>
                </div>
                
                <div id="searchResults" style="display: none;">
                    <h4 style="margin: 16px 0 8px 0; color: #1d1d1f;">Resultados de b√∫squeda:</h4>
                    <div id="groupsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px;"></div>
                </div>
                
                <div id="searchLoading" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto 10px;"></div>
                    <p>Buscando grupos...</p>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGroupSearchModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="searchWhatsAppGroups()">üîç Buscar Grupos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Volver al Inicio -->
    <a href="index.html" class="home-button" title="Volver al Inicio">
        üè†
    </a>