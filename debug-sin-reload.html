<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Facturaci√≥n Sin Recarga - ERP</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }
        
        .info-box h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        
        .info-box ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn.primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn.success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .btn.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #27ae60; }
        .status-error { background: #e74c3c; }
        .status-warning { background: #f39c12; }
        .status-info { background: #3498db; }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .feature-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .feature-item h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .feature-item p {
            margin: 0;
            color: #7f8c8d;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêõ Debug Facturaci√≥n Sin Recarga</h1>
            <p>Herramienta para diagnosticar problemas de facturaci√≥n sin perder el proceso</p>
        </div>
        
        <div class="content">
            <div class="info-box">
                <h3>üìã Instrucciones de Uso</h3>
                <ul>
                    <li><strong>Paso 1:</strong> Abre la p√°gina de clientes (<code>clientes.html</code>) en otra pesta√±a</li>
                    <li><strong>Paso 2:</strong> Abre la consola del navegador (F12 ‚Üí Console)</li>
                    <li><strong>Paso 3:</strong> Copia y pega el script de debug en la consola</li>
                    <li><strong>Paso 4:</strong> Usa el panel de control que aparecer√° en la esquina superior derecha</li>
                    <li><strong>Paso 5:</strong> Revisa la consola para ver todo el proceso paso a paso</li>
                </ul>
            </div>
            
            <div class="section">
                <h2>üöÄ Script de Debug</h2>
                <p>Copia y pega este script en la consola de la p√°gina de clientes:</p>
                <div class="console" id="scriptContent">
// ===== DEBUG DE FACTURACI√ìN SIN RECARGA =====
// Este script modifica la funci√≥n billClient para prevenir actualizaciones autom√°ticas

console.log('üîß === CARGANDO DEBUG DE FACTURACI√ìN SIN RECARGA ===');

// ===== FUNCI√ìN ORIGINAL DE BILLCLIENT (BACKUP) =====
let originalBillClient = null;

// ===== FUNCI√ìN DE DEBUG MODIFICADA =====
async function billClientDebug(clientId, preventReload = true) {
    console.log('üöÄ === INICIANDO FACTURACI√ìN EN MODO DEBUG ===');
    console.log('üìã Cliente ID:', clientId);
    console.log('üîÑ Prevenir recarga:', preventReload);
    
    const client = clients.find(c => c.ID.toString() === clientId.toString());
    if (!client) {
        console.error('‚ùå Cliente no encontrado');
        showToast('Cliente no encontrado', 'error');
        return;
    }

    console.log('‚úÖ Cliente encontrado:', client.Nombre);

    // Verificar que el contrato est√© completo
    if (!client.fechaContrato || !client.montoContrato || !client.plazoContrato) {
        console.error('‚ùå Contrato incompleto');
        console.log('  - Fecha contrato:', client.fechaContrato);
        console.log('  - Monto contrato:', client.montoContrato);
        console.log('  - Plazo contrato:', client.plazoContrato);
        showToast('El contrato del cliente est√° incompleto', 'error');
        return;
    }

    console.log('‚úÖ Contrato completo verificado');

    // Verificar si ya est√° facturado
    const billingInfo = getClientBillingInfo(clientId);
    console.log('üìä Estado de facturaci√≥n:', billingInfo.status);
    console.log('üìÑ Facturas existentes:', billingInfo.invoices.length);
    
    if (billingInfo.status === 'billed') {
        console.warn('‚ö†Ô∏è Cliente ya facturado');
        showToast('Este cliente ya ha sido facturado', 'warning');
        return;
    }

    // Deshabilitar bot√≥n mientras procesa
    const billBtn = document.getElementById(`billBtn-${clientId}`);
    if (billBtn) {
        billBtn.disabled = true;
        billBtn.textContent = '‚è≥ Facturando...';
        console.log('üîò Bot√≥n deshabilitado');
    }

    try {
        console.log('üîÑ Generando facturas...');
        const invoicesData = generateInvoicesForClient(client);
        console.log(`‚úÖ ${invoicesData.length} facturas generadas`);
        
        // Mostrar las primeras 3 facturas generadas
        invoicesData.slice(0, 3).forEach((factura, index) => {
            console.log(`üìÑ Factura ${index + 1}:`, {
                numero: factura.NumeroFactura,
                cliente: factura.ID_Cliente,
                semana: factura.SemanaNumero,
                vencimiento: factura.FechaVencimiento,
                monto: factura.MontoBase,
                estado: factura.Estado
            });
        });
        
        console.log('üåê Enviando facturas a la API...');
        const apiUrl = `${API_URL_INVOICES}?sheet=Facturas`;
        console.log('üì° URL de API:', apiUrl);
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(invoicesData)
        });

        console.log('üì° Respuesta HTTP:', response.status, response.statusText);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error en la respuesta:', errorText);
            throw new Error(`Error HTTP: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('‚úÖ Facturas enviadas exitosamente:', result);

        // Recargar facturas y actualizar vista
        console.log('üîÑ Recargando datos...');
        await loadInvoices();
        renderClients(clients);
        updateStats();
        
        console.log('‚úÖ Datos actualizados');
        
        // Mostrar resultado final
        const successMessage = `‚úÖ Cliente facturado exitosamente: ${invoicesData.length} facturas generadas`;
        console.log(successMessage);
        showToast(successMessage, 'success');
        
        // Si no prevenir recarga, hacer la redirecci√≥n normal
        if (!preventReload) {
            console.log('üîÑ Redirigiendo a facturas...');
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    showToast(`üîÑ Redirigiendo a facturas en ${countdown} segundos...`, 'warning');
                } else {
                    clearInterval(countdownInterval);
                    window.location.href = `https://arrendautos.app/facturas.html?clientId=${clientId}`;
                }
            }, 1000);
        } else {
            console.log('üõë Modo debug: No se redirige autom√°ticamente');
            showToast('‚úÖ Facturaci√≥n completada en modo debug. Revisa la consola para detalles.', 'success');
        }
        
    } catch (error) {
        console.error('‚ùå Error al facturar cliente:', error);
        showToast('Error al generar facturas: ' + error.message, 'error');
        
        // Restaurar bot√≥n
        if (billBtn) {
            billBtn.disabled = false;
            billBtn.textContent = 'üìÑ Facturar';
        }
    }
}

// ===== FUNCI√ìN PARA REEMPLAZAR LA FUNCI√ìN ORIGINAL =====
function enableDebugMode() {
    console.log('üîß === HABILITANDO MODO DEBUG ===');
    
    // Guardar la funci√≥n original si existe
    if (typeof billClient === 'function') {
        originalBillClient = billClient;
        console.log('üíæ Funci√≥n original guardada');
    }
    
    // Reemplazar con la funci√≥n de debug
    window.billClient = billClientDebug;
    console.log('‚úÖ Funci√≥n billClient reemplazada con versi√≥n de debug');
    
    // Agregar botones de control
    addDebugControls();
}

// ===== FUNCI√ìN PARA RESTAURAR LA FUNCI√ìN ORIGINAL =====
function disableDebugMode() {
    console.log('üîß === DESHABILITANDO MODO DEBUG ===');
    
    if (originalBillClient) {
        window.billClient = originalBillClient;
        console.log('‚úÖ Funci√≥n original restaurada');
    }
    
    // Remover controles de debug
    removeDebugControls();
}

// ===== FUNCI√ìN PARA AGREGAR CONTROLES DE DEBUG =====
function addDebugControls() {
    // Crear panel de control
    const debugPanel = document.createElement('div');
    debugPanel.id = 'debugPanel';
    debugPanel.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: #2c3e50;
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 10000;
        font-family: monospace;
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        min-width: 250px;
    `;
    
    debugPanel.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold; color: #3498db;">
            üêõ MODO DEBUG ACTIVO
        </div>
        <div style="margin-bottom: 8px;">
            <label style="display: block; margin-bottom: 5px;">Modo de facturaci√≥n:</label>
            <select id="debugMode" style="width: 100%; padding: 4px; border-radius: 4px;">
                <option value="debug">üîç Solo Debug (sin recarga)</option>
                <option value="normal">üìÑ Normal (con recarga)</option>
            </select>
        </div>
        <div style="margin-bottom: 8px;">
            <button id="testBilling" style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
                üß™ Probar Facturaci√≥n
            </button>
        </div>
        <div style="margin-bottom: 8px;">
            <button id="disableDebug" style="width: 100%; padding: 6px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ‚ùå Desactivar Debug
            </button>
        </div>
        <div style="font-size: 10px; color: #bdc3c7;">
            Revisa la consola para ver el proceso completo
        </div>
    `;
    
    document.body.appendChild(debugPanel);
    
    // Event listeners
    document.getElementById('testBilling').addEventListener('click', function() {
        const mode = document.getElementById('debugMode').value;
        const preventReload = mode === 'debug';
        
        // Buscar el primer cliente con contrato completo
        const testClient = clients.find(client => 
            client.fechaContrato && client.montoContrato && client.plazoContrato
        );
        
        if (testClient) {
            console.log('üß™ === PRUEBA DE FACTURACI√ìN ===');
            console.log('Cliente de prueba:', testClient.Nombre, '(ID:', testClient.ID, ')');
            billClientDebug(testClient.ID, preventReload);
        } else {
            console.error('‚ùå No hay clientes con contrato completo para probar');
            showToast('No hay clientes con contrato completo para probar', 'error');
        }
    });
    
    document.getElementById('disableDebug').addEventListener('click', function() {
        disableDebugMode();
    });
    
    console.log('üéõÔ∏è Panel de control de debug agregado');
}

// ===== FUNCI√ìN PARA REMOVER CONTROLES DE DEBUG =====
function removeDebugControls() {
    const debugPanel = document.getElementById('debugPanel');
    if (debugPanel) {
        debugPanel.remove();
        console.log('üéõÔ∏è Panel de control de debug removido');
    }
}

// ===== FUNCI√ìN PARA PROBAR CON CLIENTE ESPEC√çFICO =====
function testBillingWithClient(clientId) {
    console.log('üß™ === PRUEBA CON CLIENTE ESPEC√çFICO ===');
    console.log('Cliente ID:', clientId);
    
    const client = clients.find(c => c.ID.toString() === clientId.toString());
    if (!client) {
        console.error('‚ùå Cliente no encontrado');
        return;
    }
    
    console.log('Cliente:', client.Nombre);
    billClientDebug(clientId, true); // Siempre en modo debug
}

// ===== FUNCI√ìN PARA VER ESTADO ACTUAL =====
function showCurrentState() {
    console.log('üìä === ESTADO ACTUAL DEL SISTEMA ===');
    console.log('Clientes cargados:', clients?.length || 0);
    console.log('Facturas cargadas:', invoices?.length || 0);
    console.log('Modo debug activo:', typeof billClient === 'function' && billClient.name === 'billClientDebug');
    
    if (clients && clients.length > 0) {
        console.log('\nüìã Primeros 3 clientes:');
        clients.slice(0, 3).forEach((client, index) => {
            const contratoCompleto = client.fechaContrato && client.montoContrato && client.plazoContrato;
            console.log(`  ${index + 1}. ${client.Nombre} (ID: ${client.ID}) - Contrato: ${contratoCompleto ? '‚úÖ' : '‚ùå'}`);
        });
    }
}

// ===== EXPONER FUNCIONES GLOBALMENTE =====
window.enableDebugMode = enableDebugMode;
window.disableDebugMode = disableDebugMode;
window.billClientDebug = billClientDebug;
window.testBillingWithClient = testBillingWithClient;
window.showCurrentState = showCurrentState;

// ===== AUTO-HABILITAR MODO DEBUG =====
console.log('üöÄ === AUTO-HABILITANDO MODO DEBUG ===');
setTimeout(() => {
    enableDebugMode();
    console.log('‚úÖ Modo debug habilitado autom√°ticamente');
    console.log('üí° Usa el panel de control en la esquina superior derecha');
}, 1000);

console.log('‚úÖ Script de debug sin recarga cargado');
console.log('üí° El modo debug se habilitar√° autom√°ticamente en 1 segundo');
                </div>
                
                <div class="button-grid">
                    <button class="btn primary" onclick="copyScript()">
                        üìã Copiar Script
                    </button>
                    <button class="btn secondary" onclick="clearConsole()">
                        üóëÔ∏è Limpiar Consola
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2>üéØ Funciones Disponibles</h2>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>üîç Modo Debug</h4>
                        <p>Previene la recarga autom√°tica de la p√°gina y muestra todo el proceso paso a paso en la consola.</p>
                    </div>
                    <div class="feature-item">
                        <h4>üß™ Prueba Autom√°tica</h4>
                        <p>Busca autom√°ticamente un cliente con contrato completo y prueba la facturaci√≥n.</p>
                    </div>
                    <div class="feature-item">
                        <h4>üéõÔ∏è Panel de Control</h4>
                        <p>Panel flotante que te permite controlar el modo de facturaci√≥n y ver el estado del sistema.</p>
                    </div>
                    <div class="feature-item">
                        <h4>üìä Estado del Sistema</h4>
                        <p>Muestra informaci√≥n detallada sobre clientes, facturas y el estado actual del sistema.</p>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>üîß Comandos √ötiles</h2>
                <div class="button-grid">
                    <button class="btn success" onclick="showCommand('enableDebugMode()')">
                        üîß Habilitar Debug
                    </button>
                    <button class="btn warning" onclick="showCommand('disableDebugMode()')">
                        ‚ùå Deshabilitar Debug
                    </button>
                    <button class="btn info" onclick="showCommand('showCurrentState()')">
                        üìä Ver Estado
                    </button>
                    <button class="btn danger" onclick="showCommand('testBillingWithClient(\'123456\')')">
                        üß™ Probar Cliente Espec√≠fico
                    </button>
                </div>
                
                <div class="input-group">
                    <label for="clientId">ID del Cliente para Probar:</label>
                    <input type="text" id="clientId" placeholder="Ej: 123456" value="">
                </div>
                
                <button class="btn primary" onclick="testSpecificClient()">
                    üß™ Probar con Cliente Espec√≠fico
                </button>
            </div>
        </div>
    </div>
    
    <script>
        function copyScript() {
            const scriptContent = document.getElementById('scriptContent').textContent;
            navigator.clipboard.writeText(scriptContent).then(() => {
                alert('‚úÖ Script copiado al portapapeles');
            }).catch(() => {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = scriptContent;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ Script copiado al portapapeles');
            });
        }
        
        function clearConsole() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar la consola?')) {
                console.clear();
                alert('‚úÖ Consola limpiada');
            }
        }
        
        function showCommand(command) {
            alert(`Comando: ${command}\n\nCopia este comando y p√©galo en la consola de la p√°gina de clientes.`);
        }
        
        function testSpecificClient() {
            const clientId = document.getElementById('clientId').value.trim();
            if (!clientId) {
                alert('‚ùå Por favor ingresa un ID de cliente');
                return;
            }
            
            const command = `testBillingWithClient('${clientId}')`;
            alert(`Comando: ${command}\n\nCopia este comando y p√©galo en la consola de la p√°gina de clientes.`);
        }
    </script>
</body>
</html> 