<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Facturas Vencidas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="navigation">
        <button class="btn btn-secondary btn-large" onclick="goBackToClients()">
            ‚Üê Volver a Clientes
        </button>
    </div>

    <div class="header">
        <h1>üî¥ Facturas Vencidas</h1>
        <p>Gesti√≥n de facturas vencidas (NO manuales) agrupadas por cliente - Solo clientes con ID de WhatsApp</p>
    </div>

    <div class="search-section">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchOverdue" placeholder="üîç Buscar por cliente, placa, ID o factura..." class="search-input">
            </div>
        </div>
    </div>

    <div class="invoices-section" id="overdueSection">
        <div class="section-header">
            <h3 class="section-title">
                üî¥ Facturas Vencidas por Cliente (NO Manuales + Con WhatsApp)
                <span class="section-count" id="overdueCount">0</span>
            </h3>
            <small style="color: #86868b; font-size: 0.8rem;">Ordenados del que debe m√°s al que debe menos - Solo facturas con saldo pendiente y clientes con ID de WhatsApp</small>
        </div>
        
        <div class="clients-grid" id="clientsGrid"></div>
        
        <div class="empty-section" id="emptyOverdue" style="display: none;">
            <h4>‚úÖ No hay facturas vencidas</h4>
            <p>¬°Excelente! Todas las facturas est√°n al d√≠a</p>
        </div>
    </div>
</div>

<script>
    const API_URL_INVOICES = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
    const API_URL_CLIENTS = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
    
    let allInvoices = [];
    let allClients = [];
    let clientsWithOverdueInvoices = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Iniciando p√°gina de Facturas Vencidas');
        initializePage();
    });

    async function initializePage() {
        try {
            await Promise.all([
                loadInvoices(),
                loadClients()
            ]);
            
            processOverdueInvoices();
            setupEventListeners();
            
        } catch (error) {
            console.error('‚ùå Error al inicializar:', error);
            showToast('Error al cargar datos', 'error');
        }
    }

    async function loadInvoices() {
        const response = await fetch(`${API_URL_INVOICES}?sheet=Facturas`);
        allInvoices = await response.json();
        console.log(`üìÑ Facturas cargadas: ${allInvoices.length}`);
    }

    async function loadClients() {
        const response = await fetch(`${API_URL_CLIENTS}?sheet=Clientes`);
        allClients = await response.json();
        console.log(`üë• Clientes cargados: ${allClients.length}`);
    }

    function processOverdueInvoices() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Filtrar facturas vencidas (EXCLUYENDO facturas manuales)
        const overdueInvoices = allInvoices.filter(invoice => {
            if (!invoice.FechaVencimiento || invoice.Estado === 'Pagado') {
                return false;
            }
            
            // EXCLUIR facturas manuales
            const isManualInvoice = invoice.TipoFactura === 'Manual' ||
                invoice.NumeroFactura?.startsWith('MAN-') ||
                invoice.ConceptoManual;
            
            if (isManualInvoice) {
                return false;
            }
            
            const dueDate = parseDate(invoice.FechaVencimiento);
            if (!dueDate) return false;
            
            return dueDate <= today;
        });
        
        // Agrupar por cliente
        const clientsMap = new Map();
        
        overdueInvoices.forEach(invoice => {
            const clientId = invoice.ID_Cliente;
            if (!clientsMap.has(clientId)) {
                const client = allClients.find(c => c.ID.toString() === clientId.toString());
                if (client) {
                    // DISCRIMINAR clientes sin ID de WhatsApp
                    if (!client.idGrupoWhatsapp || client.idGrupoWhatsapp.trim() === '') {
                        console.log(`‚ö†Ô∏è Cliente ${client.Nombre} (ID: ${client.ID}) sin ID de WhatsApp - EXCLUIDO`);
                        return; // Saltar este cliente
                    }
                    
                    clientsMap.set(clientId, {
                        client: client,
                        invoices: [],
                        totalDebt: 0
                    });
                }
            }
            
            if (clientsMap.has(clientId)) {
                const clientData = clientsMap.get(clientId);
                const balanceInfo = calculateRemainingBalance(invoice);
                
                // Solo incluir facturas con saldo pendiente
                if (balanceInfo.remainingBalance > 0) {
                    clientData.invoices.push({
                        ...invoice,
                        baseAmount: parseAmount(invoice.MontoBase || 0),
                        fineAmount: calculateFine(invoice),
                        totalOwed: balanceInfo.totalOwed,
                        totalPaid: balanceInfo.totalPaid,
                        remainingBalance: balanceInfo.remainingBalance,
                        hasPayments: balanceInfo.hasPayments,
                        daysOverdue: getDaysOverdue(invoice)
                    });
                    
                    clientData.totalDebt += balanceInfo.remainingBalance;
                }
            }
        });
        
        // Convertir a array y ordenar por deuda total (mayor a menor)
        clientsWithOverdueInvoices = Array.from(clientsMap.values())
            .sort((a, b) => b.totalDebt - a.totalDebt);
        
        console.log(`üî¥ Clientes con facturas vencidas: ${clientsWithOverdueInvoices.length}`);
        renderClientsGrid();
    }

    function renderClientsGrid() {
        const container = document.getElementById('clientsGrid');
        const emptySection = document.getElementById('emptyOverdue');
        const countElement = document.getElementById('overdueCount');
        
        if (clientsWithOverdueInvoices.length === 0) {
            container.innerHTML = '';
            emptySection.style.display = 'block';
            countElement.textContent = '0';
            return;
        }
        
        emptySection.style.display = 'none';
        countElement.textContent = clientsWithOverdueInvoices.length;
        
        container.innerHTML = clientsWithOverdueInvoices.map(clientData => {
            const { client, invoices, totalDebt } = clientData;
            
            // Ordenar facturas por d√≠as vencidos (mayor a menor)
            const sortedInvoices = invoices.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            return `
                <div class="client-card">
                    <div class="client-header">
                        <div class="client-info">
                            <h3 class="client-name">${client.Nombre}</h3>
                            <div class="client-details">
                                <span class="client-id">ID: ${client.ID}</span>
                                <span class="client-placa">Placa: ${client.Placa || 'Sin placa'}</span>
                                <span class="client-phone">${client.numeroTelefono || 'Sin tel√©fono'}</span>
                            </div>
                        </div>
                        <div class="client-total">
                            <div class="total-amount">‚Ç°${formatNumber(totalDebt)}</div>
                            <div class="total-label">Total Pendiente</div>
                        </div>
                    </div>
                    
                    <div class="invoices-list">
                        ${sortedInvoices.map(invoice => `
                            <div class="invoice-card overdue-card">
                                <div class="invoice-header">
                                    <div class="invoice-number">${invoice.NumeroFactura}</div>
                                    <div class="invoice-status overdue">${invoice.daysOverdue} d√≠as vencida</div>
                                </div>
                                
                                <div class="invoice-description">
                                    ${invoice.SemanaDescripcion || 'Sin descripci√≥n'}
                                </div>
                                
                                <div class="invoice-dates">
                                    <div class="date-item">
                                        <span class="date-label">Vence:</span>
                                        <span class="date-value">${formatDate(invoice.FechaVencimiento)}</span>
                                    </div>
                                </div>
                                
                                <div class="invoice-amounts">
                                    <div class="amount-item">
                                        <span class="amount-label">Base:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.baseAmount)}</span>
                                    </div>
                                    <div class="amount-item fine">
                                        <span class="amount-label">Multa:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.fineAmount)}</span>
                                    </div>
                                    <div class="amount-item total">
                                        <span class="amount-label">Total Deuda:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.totalOwed)}</span>
                                    </div>
                                    ${invoice.hasPayments ? `
                                        <div class="amount-item paid">
                                            <span class="amount-label">Pagado:</span>
                                            <span class="amount-value">‚Ç°${formatNumber(invoice.totalPaid)}</span>
                                        </div>
                                    ` : ''}
                                    <div class="amount-item remaining">
                                        <span class="amount-label">Pendiente:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.remainingBalance)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function parseAmount(amount) {
        if (!amount) return 0;
        
        // Si es un n√∫mero, usarlo directamente
        if (typeof amount === 'number') {
            return amount;
        } else if (typeof amount === 'string') {
            // Limpiar el string de caracteres no num√©ricos excepto punto y coma
            const cleanAmount = amount.toString().trim().replace(/[^\d.,]/g, '');
            
            if (cleanAmount.includes(',')) {
                // Formato: "1.000.000,00" -> 1000000.00
                const normalizedValue = cleanAmount.replace(/\./g, '').replace(',', '.');
                return parseFloat(normalizedValue) || 0;
            } else {
                // Formato: "1000000" o "1.000.000" -> 1000000
                const normalizedValue = cleanAmount.replace(/\./g, '');
                return parseFloat(normalizedValue) || 0;
            }
        } else {
            // Otros tipos: intentar conversi√≥n directa
            return parseFloat(amount) || 0;
        }
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
        }
        
        return new Date(dateStr);
    }

    function calculateDaysOverdue(dueDateString, referenceDate = new Date()) {
        const dueDate = parseDate(dueDateString);
        if (!dueDate) return 0;

        const today = new Date(referenceDate);
        today.setHours(0, 0, 0, 0);
        dueDate.setHours(0, 0, 0, 0);

        if (today <= dueDate) return 0;

        const diffTime = today.getTime() - dueDate.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    }

    function getDaysOverdue(invoice) {
        return calculateDaysOverdue(invoice.FechaVencimiento);
    }

    function parseInvoicePayments(paymentsString) {
        if (!paymentsString || paymentsString.trim() === '') {
            return [];
        }
        
        try {
            const payments = paymentsString.split(',').map(payment => {
                const parts = payment.trim().split(':');
                if (parts.length >= 2) {
                    const reference = parts[0];
                    const amount = parseFloat(parts[1]) || 0;
                    const date = parts[2] || '';
                    return { reference, amount, date };
                }
                return null;
            }).filter(payment => payment !== null);
            
            return payments;
        } catch (error) {
            console.error('Error parseando pagos de factura:', error);
            return [];
        }
    }

    function calculateFine(invoice) {
        // Solo calcular multas para facturas de arrendamiento (NO manuales)
        const isManualInvoice = invoice.TipoFactura === 'Manual' ||
            invoice.NumeroFactura?.startsWith('MAN-') ||
            invoice.ConceptoManual;

        if (isManualInvoice) return 0;
        
        const daysOverdue = getDaysOverdue(invoice);
        
        if (daysOverdue <= 0) return 0;
        
        // ‚Ç°2,000 por d√≠a de atraso (como en utils.js)
        return daysOverdue * 2000;
    }

    function calculateRemainingBalance(invoice) {
        const baseAmount = parseAmount(invoice.MontoBase || 0);
        const fineAmount = calculateFine(invoice);
        const totalOwed = baseAmount + fineAmount;
        
        // Calcular pagos aplicados
        const previousPayments = parseInvoicePayments(invoice.Pagos || '');
        const totalPreviousPayments = previousPayments.reduce((sum, payment) => sum + payment.amount, 0);
        
        // Saldo pendiente
        const remainingBalance = totalOwed - totalPreviousPayments;
        
        return {
            totalOwed: totalOwed,
            totalPaid: totalPreviousPayments,
            remainingBalance: Math.max(0, remainingBalance),
            hasPayments: totalPreviousPayments > 0
        };
    }

    function setupEventListeners() {
        const searchInput = document.getElementById('searchOverdue');
        searchInput.addEventListener('input', function() {
            filterClients();
        });
    }

    function filterClients() {
        const searchTerm = document.getElementById('searchOverdue').value.toLowerCase();
        
        if (!searchTerm) {
            renderClientsGrid();
            return;
        }
        
        const filteredClients = clientsWithOverdueInvoices.filter(clientData => {
            const { client, invoices } = clientData;
            
            // Buscar en nombre del cliente
            if (client.Nombre.toLowerCase().includes(searchTerm)) {
                return true;
            }
            
            // Buscar en placa del cliente
            if (client.Placa && client.Placa.toLowerCase().includes(searchTerm)) {
                return true;
            }
            
            // Buscar en ID del cliente
            if (client.ID.toString().includes(searchTerm)) {
                return true;
            }
            
            // Buscar en n√∫mero de facturas
            return invoices.some(invoice => 
                invoice.NumeroFactura.toLowerCase().includes(searchTerm) ||
                (invoice.SemanaDescripcion && invoice.SemanaDescripcion.toLowerCase().includes(searchTerm))
            );
        });
        
        renderFilteredClients(filteredClients);
    }

    function renderFilteredClients(filteredClients) {
        const container = document.getElementById('clientsGrid');
        const countElement = document.getElementById('overdueCount');
        
        countElement.textContent = filteredClients.length;
        
        if (filteredClients.length === 0) {
            container.innerHTML = '<div class="empty-section"><h4>üîç No se encontraron clientes</h4><p>Intenta con otros filtros de b√∫squeda</p></div>';
            return;
        }
        
        container.innerHTML = filteredClients.map(clientData => {
            const { client, invoices, totalDebt } = clientData;
            
            // Ordenar facturas por d√≠as vencidos (mayor a menor)
            const sortedInvoices = invoices.sort((a, b) => b.daysOverdue - a.daysOverdue);
            
            return `
                <div class="client-card">
                    <div class="client-header">
                        <div class="client-info">
                            <h3 class="client-name">${client.Nombre}</h3>
                            <div class="client-details">
                                <span class="client-id">ID: ${client.ID}</span>
                                <span class="client-placa">Placa: ${client.Placa || 'Sin placa'}</span>
                                <span class="client-phone">${client.numeroTelefono || 'Sin tel√©fono'}</span>
                            </div>
                        </div>
                        <div class="client-total">
                            <div class="total-amount">‚Ç°${formatNumber(totalDebt)}</div>
                            <div class="total-label">Total Pendiente</div>
                        </div>
                    </div>
                    
                    <div class="invoices-list">
                        ${sortedInvoices.map(invoice => `
                            <div class="invoice-card overdue-card">
                                <div class="invoice-header">
                                    <div class="invoice-number">${invoice.NumeroFactura}</div>
                                    <div class="invoice-status overdue">${invoice.daysOverdue} d√≠as vencida</div>
                                </div>
                                
                                <div class="invoice-description">
                                    ${invoice.SemanaDescripcion || 'Sin descripci√≥n'}
                                </div>
                                
                                <div class="invoice-dates">
                                    <div class="date-item">
                                        <span class="date-label">Vence:</span>
                                        <span class="date-value">${formatDate(invoice.FechaVencimiento)}</span>
                                    </div>
                                </div>
                                
                                <div class="invoice-amounts">
                                    <div class="amount-item">
                                        <span class="amount-label">Base:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.baseAmount)}</span>
                                    </div>
                                    <div class="amount-item fine">
                                        <span class="amount-label">Multa:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.fineAmount)}</span>
                                    </div>
                                    <div class="amount-item total">
                                        <span class="amount-label">Total Deuda:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.totalOwed)}</span>
                                    </div>
                                    ${invoice.hasPayments ? `
                                        <div class="amount-item paid">
                                            <span class="amount-label">Pagado:</span>
                                            <span class="amount-value">‚Ç°${formatNumber(invoice.totalPaid)}</span>
                                        </div>
                                    ` : ''}
                                    <div class="amount-item remaining">
                                        <span class="amount-label">Pendiente:</span>
                                        <span class="amount-value">‚Ç°${formatNumber(invoice.remainingBalance)}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function formatDateForDisplay(dateString) {
        const date = parseDate(dateString);
        if (!date) return dateString;
        
        return date.toLocaleDateString('es-CR');
    }

    function formatDate(dateString) {
        return formatDateForDisplay(dateString);
    }

    function formatNumber(number) {
        const num = parseAmount(number);
        return new Intl.NumberFormat('es-CR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#00c851' : '#2196F3'};
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function goBackToClients() {
        window.location.href = 'clientes.html';
    }


</script>

<style>
    .clients-grid {
        display: flex;
        flex-direction: column;
        gap: 24px;
        margin-top: 24px;
    }

    .client-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        border: 1px solid #e1e5e9;
    }

    .client-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: #f8f9fa;
        color: #333;
        border-bottom: 1px solid #dee2e6;
    }

    .client-info {
        flex: 1;
    }

    .client-name {
        margin: 0 0 8px 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: #333;
    }

    .client-details {
        display: flex;
        gap: 16px;
        font-size: 0.9rem;
        opacity: 0.9;
        flex-wrap: wrap;
        color: #333;
    }

    .client-placa {
        background: #f8f9fa;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        color: #333;
        border: 1px solid #dee2e6;
    }

    .client-id {
        color: #333;
        font-weight: 500;
    }

    .client-phone {
        color: #333;
        font-weight: 500;
    }

    .client-total {
        text-align: right;
    }

    .total-amount {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #dc3545;
    }

    .total-label {
        font-size: 0.8rem;
        opacity: 0.8;
        color: #6c757d;
    }

    .invoices-list {
        padding: 20px 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .invoice-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #dc3545;
    }

    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .invoice-number {
        font-weight: 600;
        color: #495057;
    }

    .invoice-status.overdue {
        background: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .invoice-description {
        color: #6c757d;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }

    .invoice-dates {
        margin-bottom: 12px;
    }

    .date-item {
        display: flex;
        gap: 8px;
        font-size: 0.9rem;
    }

    .date-label {
        color: #6c757d;
        font-weight: 500;
    }

    .date-value {
        color: #495057;
    }

    .invoice-amounts {
        display: flex;
        gap: 16px;
        margin-bottom: 0;
        flex-wrap: wrap;
    }

    .amount-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .amount-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .amount-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #28a745;
    }

    .amount-item.fine .amount-value {
        color: #dc3545;
    }

    .amount-item.total .amount-value {
        color: #007bff;
        font-size: 1.2rem;
    }

    .amount-item.paid .amount-value {
        color: #28a745;
        font-size: 1.1rem;
    }

    .amount-item.remaining .amount-value {
        color: #dc3545;
        font-size: 1.3rem;
        font-weight: 700;
    }



    @media (max-width: 768px) {
        .client-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .client-total {
            text-align: left;
        }

        .invoice-amounts {
            flex-direction: column;
            gap: 8px;
        }


    }
</style>
</body>
</html>
