<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Facturas del Cliente</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Local Stylesheets -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <!-- Navigation -->
    <div class="navigation">
        <button class="btn btn-secondary btn-large" onclick="goBackToClients()">
            ‚Üê Volver a Clientes
        </button>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>Facturas del Cliente</h1>
        <p id="clientName">Cargando informaci√≥n del cliente...</p>
    </div>



    <!-- Loading State -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Cargando facturas y pagos aplicados...</p>
    </div>

    <!-- Bot√≥n Volver al Inicio -->
    <a href="index.html" class="home-button" title="Volver al Inicio">
        üè†
    </a>

    <!-- Error State -->
    <div class="error-state" id="errorState" style="display: none;">
        <h3>‚ùå Error al cargar datos</h3>
        <p id="errorMessage">No se pudieron cargar las facturas del cliente</p>
        <button class="btn btn-primary" onclick="retryLoad()" style="margin-top: 16px;">
            üîÑ Reintentar
        </button>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Client Information -->
        <div class="client-info">
            <div class="client-header">
                <div>
                    <h2 id="clientNameDetail">Cliente</h2>
                    <p id="clientIdDetail" style="color: #86868b;">ID: </p>
                </div>
            </div>
            <div class="client-details" id="clientDetails">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="stats-summary">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value stat-paid" id="statPaid">0</div>
                    <div class="stat-label">Pagadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-pending" id="statPending">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-overdue" id="statOverdue">0</div>
                    <div class="stat-label">Vencidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-fines" id="statFines">‚Ç°0</div>
                    <div class="stat-label">Total Multas</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
            <button class="btn btn-primary btn-large" onclick="openManualInvoiceModal()">
                ‚ûï Crear Factura Manual
            </button>
            <button class="btn btn-warning btn-large" style="margin-left: 12px;" onclick="sendAccountStatement()">
                üìù Estado de Cuenta - Arrendamiento
            </button>
            <button class="btn btn-secondary" style="margin-left: 12px;" onclick="debugPageState()">
                üêõ Debug Estado
            </button>
            <button class="btn btn-warning" style="margin-left: 12px;" onclick="forceDataLoad()">
                üîÑ Forzar Carga
            </button>
            <button class="btn btn-info" style="margin-left: 12px;" onclick="testBasicFunctionality()">
                üß™ Prueba B√°sica
            </button>
        </div>

        <!-- Tab Navigation System -->
        <div class="tab-system">
            <!-- Main Tabs -->
            <div class="main-tabs">
                <button class="main-tab active" data-tab="facturas" onclick="switchMainTab('facturas')">
                    üìÑ Facturas
                </button>
                <button class="main-tab" data-tab="pagos" onclick="switchMainTab('pagos')">
                    üí∞ Pagos
                </button>
            </div>

            <!-- Facturas Sub-tabs -->
            <div class="sub-tabs" id="facturas-sub-tabs">
                <button class="sub-tab active" data-subtab="vencidas" onclick="switchSubTab('vencidas')">
                    üî¥ Vencidas √≥ con Pago Parcial
                    <span class="tab-count" id="vencidasCount">0</span>
                </button>
                <button class="sub-tab" data-subtab="no-vencidas" onclick="switchSubTab('no-vencidas')">
                    üü° No Vencidas
                    <span class="tab-count" id="noVencidasCount">0</span>
                </button>
                <button class="sub-tab" data-subtab="pagadas" onclick="switchSubTab('pagadas')">
                    üü¢ Pagadas
                    <span class="tab-count" id="pagadasCount">0</span>
                </button>
            </div>

            <!-- Pagos Sub-tabs -->
            <div class="sub-tabs" id="pagos-sub-tabs" style="display: none;">
                <button class="sub-tab active" data-subtab="no-asignados" onclick="switchSubTab('no-asignados')">
                    üí∞ No Asignados
                    <span class="tab-count" id="noAsignadosCount">0</span>
                </button>
                <button class="sub-tab" data-subtab="aplicados" onclick="switchSubTab('aplicados')">
                    ‚úÖ Aplicados
                    <span class="tab-count" id="aplicadosCount">0</span>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Facturas Vencidas √≥ con Pago Parcial -->
            <div class="tab-pane active" id="vencidas-pane">
                <div class="section-header">
                    <h3 class="section-title">
                        üî¥ Facturas Vencidas √≥ con Pago Parcial
                    </h3>
                    <small style="color: #86868b; font-size: 0.8rem;">Completamente vencidas y vencidas con pagos parciales - Ordenadas de m√°s vieja a m√°s nueva</small>
                </div>
                <div class="invoices-grid" id="overdueInvoices"></div>
                <div class="empty-section" id="emptyOverdue" style="display: none;">
                    <h4>‚úÖ No hay facturas vencidas</h4>
                    <p>No hay facturas que venzan hoy o ya vencidas</p>
                </div>
            </div>

            <!-- Facturas No Vencidas -->
            <div class="tab-pane" id="no-vencidas-pane">
                <div class="section-header">
                    <h3 class="section-title">
                        üü° Facturas No Vencidas
                    </h3>
                    <small style="color: #86868b; font-size: 0.8rem;">Facturas por vencer en el futuro - Ordenadas de m√°s pr√≥xima a m√°s lejana a vencer</small>
                </div>
                <div class="invoices-grid" id="noVencidasInvoices"></div>
                <div class="empty-section" id="emptyNoVencidas" style="display: none;">
                    <h4>üìÑ No hay facturas no vencidas</h4>
                    <p>Todas las facturas est√°n vencidas o pagadas</p>
                </div>
            </div>

            <!-- Facturas Pagadas -->
            <div class="tab-pane" id="pagadas-pane">
                <div class="section-header">
                    <h3 class="section-title">
                        üü¢ Facturas Pagadas
                    </h3>
                    <small style="color: #86868b; font-size: 0.8rem;">Facturas completamente pagadas - Ordenadas de √∫ltima pagada a m√°s vieja pagada</small>
                </div>
                <div class="invoices-grid" id="paidInvoices"></div>
                <div class="empty-section" id="emptyPaid" style="display: none;">
                    <h4>üìÑ No hay facturas pagadas</h4>
                    <p>A√∫n no se han registrado pagos</p>
                </div>
            </div>

            <!-- Pagos No Asignados -->
            <div class="tab-pane" id="no-asignados-pane">
                <div class="section-header">
                    <h3 class="section-title">
                        üí∞ Pagos Relacionados No Asignados
                    </h3>
                    <small style="color: #86868b; font-size: 0.8rem;">Pagos encontrados por ID_Cliente directo O ID en Observaciones - Ordenados del m√°s viejo al m√°s nuevo</small>
                </div>
                <div class="invoices-grid" id="unassignedPayments"></div>
                <div class="empty-section" id="emptyUnassignedPayments" style="display: none;">
                    <h4>üìã No hay pagos sin asignar</h4>
                    <p>Todos los pagos est√°n correctamente asignados a facturas</p>
                </div>
            </div>

            <!-- Pagos Aplicados -->
            <div class="tab-pane" id="aplicados-pane">
                <div class="section-header">
                    <h3 class="section-title">
                        ‚úÖ Pagos Aplicados
                    </h3>
                    <small style="color: #86868b; font-size: 0.8rem;">Pagos ya asignados a facturas - Ordenados del m√°s reciente aplicado al m√°s viejo</small>
                </div>
                <div class="invoices-grid" id="assignedPayments"></div>
                <div class="empty-section" id="emptyAssignedPayments" style="display: none;">
                    <h4>üìÑ No hay pagos aplicados</h4>
                    <p>A√∫n no se han asignado pagos a facturas</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4 style="margin-bottom: 8px; color: #25d366;">üöÄ Enviando al Grupo de WhatsApp</h4>
        <p style="color: #666; margin: 0;">Generando PDF del recibo y enviando autom√°ticamente...</p>
        <small style="color: #999; margin-top: 8px; display: block;">Powered by ULTRAMSG</small>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal-overlay" id="receiptModal" onclick="closeReceiptModal()">
    <div class="modal-content receipt-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>üßæ Recibo de Pago</h3>
            <button class="modal-close" onclick="closeReceiptModal()">‚úï</button>
        </div>

        <div class="modal-body" style="padding: 0;">
            <div class="receipt-container" id="receiptContent">
                <!-- Receipt content generated dynamically -->
            </div>

            <div class="receipt-modal-actions">
                <div class="receipt-actions-left">
                    <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()">
                        Cerrar
                    </button>
                    <button type="button" class="btn btn-download" onclick="downloadReceiptPDF()">
                        üìÑ Descargar PDF
                    </button>
                    <button type="button" class="btn btn-warning" onclick="sendToWhatsAppManual()">
                        üì± Env√≠o Manual
                    </button>
                </div>
                <div class="receipt-actions-right">
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        üñ®Ô∏è Imprimir
                    </button>
                    <button type="button" class="btn btn-whatsapp" onclick="sendToWhatsApp()">
                        üöÄ Enviar a Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Invoice Modal -->
<div class="modal-overlay" id="editInvoiceModal" onclick="closeEditInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Factura</h3>
            <button class="modal-close" onclick="closeEditInvoiceModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <form id="editInvoiceForm">
                <input type="hidden" id="editInvoiceNumber" />

                <div class="form-group">
                    <label>N√∫mero de Factura</label>
                    <input type="text" id="editInvoiceNumberDisplay" disabled>
                </div>

                <div class="form-group">
                    <label for="editInvoiceConcept">Concepto *</label>
                    <select id="editInvoiceConcept" required>
                        <option value="">Seleccione un concepto</option>
                        <option value="Arrendamiento Semanal">Arrendamiento Semanal</option>
                        <option value="Multa por Retraso">Multa por Retraso</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Combustible">Combustible</option>
                        <option value="Reparaci√≥n">Reparaci√≥n</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Documentos">Tramites de Documentos</option>
                        <option value="Multa de Tr√°nsito">Multa de Tr√°nsito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editInvoiceDescription">Descripci√≥n</label>
                    <textarea id="editInvoiceDescription" placeholder="Descripci√≥n detallada del concepto"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editInvoiceAmount">Monto Base (‚Ç°) *</label>
                        <input type="number" id="editInvoiceAmount" min="1" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="editInvoiceDueDate">Fecha de Vencimiento *</label>
                        <input type="date" id="editInvoiceDueDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editInvoiceStatus">Estado *</label>
                        <select id="editInvoiceStatus" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Vencido">Vencido</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </div>

                    <div class="form-group" id="editPaymentDateGroup" style="display: none;">
                        <label for="editInvoicePaymentDate">Fecha de Pago</label>
                        <input type="date" id="editInvoicePaymentDate">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditInvoiceModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Invoice Modal -->
<div class="modal-overlay" id="deleteInvoiceModal" onclick="closeDeleteInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-header">
            <h3>üóëÔ∏è Eliminar Factura</h3>
            <button class="modal-close" onclick="closeDeleteInvoiceModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <h4 style="margin-bottom: 8px;">¬øEst√° seguro?</h4>
                <p style="color: #86868b; margin-bottom: 16px;">
                    Esta acci√≥n eliminar√° permanentemente la factura:
                </p>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; font-weight: 600;" id="deleteInvoiceInfo">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <div class="form-actions" style="margin-top: 0; border: none; padding: 0;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteInvoiceModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteInvoice()" id="confirmDeleteBtn">
                    üóëÔ∏è Eliminar Factura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Invoice Modal -->
<div class="modal-overlay" id="manualInvoiceModal" onclick="closeManualInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>‚ûï Crear Factura Manual</h3>
            <button class="modal-close" onclick="closeManualInvoiceModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <form id="manualInvoiceForm">
                <div class="form-group">
                    <label for="invoiceConcept">Concepto *</label>
                    <select id="invoiceConcept" required>
                        <option value="">Seleccione un concepto</option>
                        <option value="Arrendamiento Semanal">Arrendamiento Semanal</option>
                        <option value="Multa por Retraso">Multa por Retraso</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Combustible">Combustible</option>
                        <option value="Reparaci√≥n">Reparaci√≥n</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Documentos">Tramites de Documentos</option>
                        <option value="Multa de Tr√°nsito">Multa de Tr√°nsito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoiceDescription">Descripci√≥n</label>
                    <textarea id="invoiceDescription" placeholder="Descripci√≥n detallada del concepto (opcional)"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceAmount">Monto (‚Ç°) *</label>
                        <input type="number" id="invoiceAmount" min="1" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="invoiceDueDate">Fecha de Vencimiento *</label>
                        <input type="date" id="invoiceDueDate" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeManualInvoiceModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úÖ Crear Factura
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Distribution Modal -->
<div class="modal-overlay" id="paymentDistributionModal" onclick="closePaymentDistributionModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
        <div class="modal-header">
            <h3>üí∞ Distribuci√≥n de Pago</h3>
            <button class="modal-close" onclick="closePaymentDistributionModal()">‚úï</button>
        </div>

        <div class="modal-body">
            <div id="paymentDistributionInfo"></div>
            <div id="invoicesDistributionList"></div>
            <div id="distributionSummary"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePaymentDistributionModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirmDistributionBtn" onclick="confirmPaymentDistribution()">
                    ‚úÖ Aplicar Distribuci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="utils.js"></script>
<script src="payment-management.js"></script>
<script src="invoice-crud.js"></script>
<script src="receipt-whatsapp.js"></script>
<script src="main.js"></script>
<script src="client-management.js"></script>
<script src="account-statement.js"></script>
<script>
    // ===== TAB SYSTEM FUNCTIONS =====
    
    // Variables globales para el sistema de pesta√±as
    let currentMainTab = 'facturas';
    let currentSubTab = 'vencidas';
    
    // Funci√≥n para cambiar pesta√±a principal
    function switchMainTab(tabName) {
        console.log('üîÑ Cambiando a pesta√±a principal:', tabName);
        
        // Actualizar variables globales
        currentMainTab = tabName;
        
        // Actualizar pesta√±as principales
        document.querySelectorAll('.main-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Mostrar/ocultar sub-pesta√±as correspondientes
        const facturasSubTabs = document.getElementById('facturas-sub-tabs');
        const pagosSubTabs = document.getElementById('pagos-sub-tabs');
        
        if (tabName === 'facturas') {
            facturasSubTabs.style.display = 'flex';
            pagosSubTabs.style.display = 'none';
            
            // Activar primera sub-pesta√±a de facturas por defecto
            if (currentSubTab === 'no-asignados' || currentSubTab === 'aplicados') {
                switchSubTab('vencidas');
            }
        } else if (tabName === 'pagos') {
            facturasSubTabs.style.display = 'none';
            pagosSubTabs.style.display = 'flex';
            
            // Activar primera sub-pesta√±a de pagos por defecto
            if (currentSubTab === 'vencidas' || currentSubTab === 'no-vencidas' || currentSubTab === 'pagadas') {
                switchSubTab('no-asignados');
            }
        }
        
        // Actualizar contadores si es necesario
        updateTabCounters();
    }
    
    // Funci√≥n para cambiar sub-pesta√±a
    function switchSubTab(subTabName) {
        console.log('üîÑ Cambiando a sub-pesta√±a:', subTabName);
        
        // Actualizar variables globales
        currentSubTab = subTabName;
        
        // Ocultar todos los paneles de contenido
        document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        
        // Mostrar el panel correspondiente
        const targetPane = document.getElementById(`${subTabName}-pane`);
        if (targetPane) {
            targetPane.classList.add('active');
        }
        
        // Actualizar sub-pesta√±as activas
        const currentMainTabElement = document.querySelector('.main-tab.active');
        const subTabsContainer = currentMainTabElement.getAttribute('data-tab') === 'facturas' 
            ? document.getElementById('facturas-sub-tabs') 
            : document.getElementById('pagos-sub-tabs');
        
        subTabsContainer.querySelectorAll('.sub-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const targetSubTab = subTabsContainer.querySelector(`[data-subtab="${subTabName}"]`);
        if (targetSubTab) {
            targetSubTab.classList.add('active');
        }
        
        // Recargar datos espec√≠ficos de la pesta√±a si es necesario
        loadTabSpecificData(subTabName);
    }
    
    // Funci√≥n para actualizar contadores de pesta√±as
    function updateTabCounters() {
        console.log('üîÑ Actualizando contadores de pesta√±as...');
        
        // Calcular contadores directamente desde los datos globales
        let vencidasCount = 0;
        let noVencidasCount = 0;
        let pagadasCount = 0;
        
        // Usar las variables globales directamente
        const invoices = window.clientInvoices || clientInvoices || [];
        const unassigned = window.unassignedPayments || unassignedPayments || [];
        const assigned = window.assignedPayments || assignedPayments || [];
        
        if (invoices.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            invoices.forEach(invoice => {
                const dueDate = new Date(invoice.FechaVencimiento);
                dueDate.setHours(0, 0, 0, 0);
                
                if (invoice.Estado === 'Pagado') {
                    pagadasCount++;
                } else if (invoice.Estado === 'Vencido' || dueDate < today) {
                    vencidasCount++;
                } else if (dueDate >= tomorrow) {
                    noVencidasCount++;
                }
            });
        }
        
        // Contadores de pagos desde datos globales
        const noAsignadosCount = unassigned.length;
        const aplicadosCount = assigned.length;
        
        console.log('üìä Contadores calculados:', {
            vencidas: vencidasCount,
            noVencidas: noVencidasCount,
            pagadas: pagadasCount,
            noAsignados: noAsignadosCount,
            aplicados: aplicadosCount
        });
        
        // Actualizar elementos de contador
        const vencidasElement = document.getElementById('vencidasCount');
        const noVencidasElement = document.getElementById('noVencidasCount');
        const pagadasElement = document.getElementById('pagadasCount');
        const noAsignadosElement = document.getElementById('noAsignadosCount');
        const aplicadosElement = document.getElementById('aplicadosCount');
        
        if (vencidasElement) vencidasElement.textContent = vencidasCount;
        if (noVencidasElement) noVencidasElement.textContent = noVencidasCount;
        if (pagadasElement) pagadasElement.textContent = pagadasCount;
        if (noAsignadosElement) noAsignadosElement.textContent = noAsignadosCount;
        if (aplicadosElement) aplicadosElement.textContent = aplicadosCount;
        
        console.log('‚úÖ Contadores actualizados');
    }
    
    // Funci√≥n para cargar datos espec√≠ficos de cada pesta√±a
    function loadTabSpecificData(subTabName) {
        console.log('üìä Cargando datos para pesta√±a:', subTabName);
        
        switch (subTabName) {
            case 'vencidas':
                // Los datos ya est√°n cargados, solo actualizar contadores
                updateTabCounters();
                break;
                
            case 'no-vencidas':
                // Cargar facturas no vencidas
                loadNoVencidasInvoices();
                break;
                
            case 'pagadas':
                // Los datos ya est√°n cargados, solo actualizar contadores
                updateTabCounters();
                break;
                
            case 'no-asignados':
                // Los datos ya est√°n cargados, solo actualizar contadores
                updateTabCounters();
                break;
                
            case 'aplicados':
                // Los datos ya est√°n cargados, solo actualizar contadores
                updateTabCounters();
                break;
        }
    }
    
    // Funci√≥n para cargar facturas no vencidas
    function loadNoVencidasInvoices() {
        console.log('üü° Cargando facturas no vencidas...');
        
        if (!clientInvoices || clientInvoices.length === 0) {
            console.log('‚ùå No hay facturas disponibles');
            return;
        }
        
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);
        
        // Filtrar facturas no vencidas (fecha de vencimiento >= ma√±ana)
        const noVencidasInvoices = clientInvoices.filter(invoice => {
            const dueDate = new Date(invoice.FechaVencimiento);
            dueDate.setHours(0, 0, 0, 0);
            
            // Solo facturas que vencen desde ma√±ana en adelante
            return dueDate >= tomorrow && invoice.Estado !== 'Pagado';
        });
        
        // Ordenar por proximidad al vencimiento (m√°s pr√≥xima primero)
        noVencidasInvoices.sort((a, b) => {
            const dateA = new Date(a.FechaVencimiento);
            const dateB = new Date(b.FechaVencimiento);
            return dateA - dateB;
        });
        
        console.log(`üü° Encontradas ${noVencidasInvoices.length} facturas no vencidas`);
        
        // Renderizar facturas no vencidas
        renderNoVencidasInvoices(noVencidasInvoices);
        
        // Actualizar contador de pesta√±a
        document.getElementById('noVencidasCount').textContent = noVencidasInvoices.length;
    }
    
    // Funci√≥n para renderizar facturas no vencidas
    function renderNoVencidasInvoices(invoices) {
        console.log(`üé® Renderizando facturas no vencidas: ${invoices.length} facturas`);
        
        const container = document.getElementById('noVencidasInvoices');
        
        if (!container) {
            console.error('‚ùå No se encontr√≥ contenedor para facturas no vencidas (ID: noVencidasInvoices)');
            return;
        }
        
        // Actualizar contador de pesta√±a
        const tabCountElement = document.getElementById('noVencidasCount');
        if (tabCountElement) {
            tabCountElement.textContent = invoices.length;
        }
        
        if (!invoices || invoices.length === 0) {
            container.innerHTML = '<div class="empty-state">No hay facturas no vencidas</div>';
            return;
        }
        
        let html = '';
        invoices.forEach(invoice => {
            const dueDate = new Date(invoice.FechaVencimiento);
            const daysUntilDue = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
            
            let statusLabel = 'Pendiente';
            let statusClass = 'pending';
            
            if (daysUntilDue === 1) {
                statusLabel = 'Vence MA√ëANA';
                statusClass = 'due-tomorrow';
            } else if (daysUntilDue <= 7) {
                statusLabel = `Vence en ${daysUntilDue} d√≠as`;
                statusClass = 'due-soon';
            }
            
            html += `
                <div class="invoice-card ${statusClass}" id="invoice-${invoice.NumeroFactura}">
                    <div class="invoice-header">
                        <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                            <div>
                                <div class="invoice-number">${invoice.NumeroFactura}</div>
                                <div class="invoice-week">${invoice.SemanaDescripcion || 'Semana ' + invoice.Semana}</div>
                            </div>
                            <span class="status-badge status-${statusClass}">${statusLabel}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-details">
                        <div class="invoice-detail">
                            <div class="invoice-detail-label">Fecha Venc.</div>
                            <div class="invoice-detail-value">${formatDateForDisplay(invoice.FechaVencimiento)}</div>
                        </div>
                        <div class="invoice-detail">
                            <div class="invoice-detail-label">Monto Base</div>
                            <div class="invoice-detail-value">‚Ç°${parseFloat(invoice.MontoBase || 0).toLocaleString('es-CR')}</div>
                        </div>
                        <div class="invoice-detail">
                            <div class="invoice-detail-label">Multas</div>
                            <div class="invoice-detail-value">‚Ç°${parseFloat(invoice.MontoMultas || 0).toLocaleString('es-CR')}</div>
                        </div>
                        <div class="invoice-detail">
                            <div class="invoice-detail-label">Total</div>
                            <div class="invoice-detail-value amount-highlight">‚Ç°${parseFloat(invoice.MontoTotal || invoice.MontoBase || 0).toLocaleString('es-CR')}</div>
                        </div>
                        ${daysUntilDue > 0 ? `
                            <div class="invoice-detail">
                                <div class="invoice-detail-label">D√≠as Restantes</div>
                                <div class="invoice-detail-value">${daysUntilDue}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="invoice-actions">
                        <button class="btn btn-primary btn-assign" onclick="assignPaymentToInvoice('', '', '${invoice.NumeroFactura}')">
                            üí∞ Asignar Pago
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        console.log(`‚úÖ Facturas no vencidas renderizadas: ${invoices.length} facturas`);
    }
    
    // Inicializar sistema de pesta√±as despu√©s de que la aplicaci√≥n principal se haya cargado
    function initializeTabSystem() {
        console.log('üéØ Inicializando sistema de pesta√±as...');
        
        // Configurar pesta√±as por defecto
        switchMainTab('facturas');
        switchSubTab('vencidas');
        
        // Actualizar contadores iniciales
        setTimeout(updateTabCounters, 1000);
        
        // Verificar que los datos se hayan cargado y renderizar contenido
        setTimeout(() => {
            console.log('üîç Verificando datos cargados...');
            console.log('üìä clientInvoices:', clientInvoices?.length || 0);
            console.log('üí∞ unassignedPayments:', unassignedPayments?.length || 0);
            console.log('‚úÖ assignedPayments:', assignedPayments?.length || 0);
            
            // Forzar actualizaci√≥n de contadores
            updateTabCounters();
            
            // Verificar que el contenido se est√© mostrando
            const vencidasPane = document.getElementById('vencidas-pane');
            const overdueInvoices = document.getElementById('overdueInvoices');
            if (vencidasPane && overdueInvoices) {
                console.log('üìã Contenido de vencidas-pane:', vencidasPane.innerHTML.substring(0, 200));
                console.log('üìã Contenido de overdueInvoices:', overdueInvoices.innerHTML.substring(0, 200));
            }
        }, 2000);
    }
    
    // Exponer funciones al scope global
    window.initializeTabSystem = initializeTabSystem;
    window.switchMainTab = switchMainTab;
    window.switchSubTab = switchSubTab;
    window.updateTabCounters = updateTabCounters;
    window.loadTabSpecificData = loadTabSpecificData;
    window.loadNoVencidasInvoices = loadNoVencidasInvoices;
    window.renderNoVencidasInvoices = renderNoVencidasInvoices;
    
    // Funci√≥n de debug para verificar el estado de la p√°gina
    function debugPageState() {
        console.log('üêõ === DEBUG DETALLADO DEL ESTADO DE LA P√ÅGINA ===');
        
        // Verificar variables globales
        console.log('üìä Variables globales:');
        console.log('  clientInvoices:', window.clientInvoices?.length || 0);
        console.log('  unassignedPayments:', window.unassignedPayments?.length || 0);
        console.log('  assignedPayments:', window.assignedPayments?.length || 0);
        console.log('  currentClient:', window.currentClient);
        
        // Verificar elementos del DOM
        console.log('üñ•Ô∏è Elementos del DOM:');
        const mainContent = document.getElementById('mainContent');
        const vencidasPane = document.getElementById('vencidas-pane');
        const noVencidasPane = document.getElementById('no-vencidas-pane');
        const pagadasPane = document.getElementById('pagadas-pane');
        const noAsignadosPane = document.getElementById('no-asignados-pane');
        const aplicadosPane = document.getElementById('aplicados-pane');
        
        console.log('  mainContent visible:', mainContent?.style.display !== 'none');
        console.log('  mainContent display:', mainContent?.style.display);
        console.log('  vencidas-pane visible:', vencidasPane?.classList.contains('active'));
        console.log('  no-vencidas-pane visible:', noVencidasPane?.classList.contains('active'));
        console.log('  pagadas-pane visible:', pagadasPane?.classList.contains('active'));
        console.log('  no-asignados-pane visible:', noAsignadosPane?.classList.contains('active'));
        console.log('  aplicados-pane visible:', aplicadosPane?.classList.contains('active'));
        
        // Verificar contenido de los contenedores
        console.log('üìã Contenido de contenedores:');
        console.log('  vencidas-pane contenido:', vencidasPane?.innerHTML?.substring(0, 200));
        console.log('  no-vencidas-pane contenido:', noVencidasPane?.innerHTML?.substring(0, 200));
        console.log('  pagadas-pane contenido:', pagadasPane?.innerHTML?.substring(0, 200));
        console.log('  no-asignados-pane contenido:', noAsignadosPane?.innerHTML?.substring(0, 200));
        console.log('  aplicados-pane contenido:', aplicadosPane?.innerHTML?.substring(0, 200));
        
        // Verificar contadores
        console.log('üìà Contadores:');
        console.log('  vencidasCount:', document.getElementById('vencidasCount')?.textContent);
        console.log('  noVencidasCount:', document.getElementById('noVencidasCount')?.textContent);
        console.log('  pagadasCount:', document.getElementById('pagadasCount')?.textContent);
        console.log('  noAsignadosCount:', document.getElementById('noAsignadosCount')?.textContent);
        console.log('  aplicadosCount:', document.getElementById('aplicadosCount')?.textContent);
        
        // Verificar estado del sistema de pesta√±as
        console.log('üéØ Estado del sistema de pesta√±as:');
        console.log('  currentMainTab:', window.currentMainTab);
        console.log('  currentSubTab:', window.currentSubTab);
        
        // Verificar si las funciones est√°n disponibles
        console.log('üîß Funciones disponibles:');
        console.log('  initializeTabSystem:', typeof window.initializeTabSystem);
        console.log('  renderInvoicesSection:', typeof window.renderInvoicesSection);
        console.log('  renderUnassignedPaymentsSection:', typeof window.renderUnassignedPaymentsSection);
        console.log('  renderAssignedPaymentsSection:', typeof window.renderAssignedPaymentsSection);
        
        // Forzar actualizaci√≥n de contadores
        console.log('üîÑ Forzando actualizaci√≥n de contadores...');
        if (typeof window.updateTabCounters === 'function') {
            window.updateTabCounters();
        }
        
        // Intentar forzar re-renderizado
        console.log('üîÑ Intentando forzar re-renderizado...');
        if (window.clientInvoices && window.clientInvoices.length > 0) {
            const overdueInvoices = window.clientInvoices.filter(inv => inv.Estado === 'Vencido');
            const paidInvoices = window.clientInvoices.filter(inv => inv.Estado === 'Pagado');
            
            if (typeof window.renderInvoicesSection === 'function') {
                console.log('  Renderizando facturas vencidas:', overdueInvoices.length);
                window.renderInvoicesSection('overdue', overdueInvoices);
                console.log('  Renderizando facturas pagadas:', paidInvoices.length);
                window.renderInvoicesSection('paid', paidInvoices);
            }
        }
        
        if (typeof window.renderUnassignedPaymentsSection === 'function') {
            console.log('  Renderizando pagos no asignados');
            window.renderUnassignedPaymentsSection();
        }
        
        if (typeof window.renderAssignedPaymentsSection === 'function') {
            console.log('  Renderizando pagos aplicados');
            window.renderAssignedPaymentsSection();
        }
        
        console.log('üêõ === FIN DEBUG DETALLADO ===');
    }
    
    window.debugPageState = debugPageState;
    
    // Esperar a que la aplicaci√≥n principal se inicialice antes de configurar las pesta√±as
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ DOM cargado en facturas.html');
        // Esperar un poco para que main.js se inicialice primero
        setTimeout(() => {
            console.log('üéØ Inicializando sistema de pesta√±as despu√©s de delay...');
            initializeTabSystem();
        }, 500);
    });
    
    // Verificar autenticaci√≥n al cargar
    function checkAuthentication() {
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';
        const isVendor = urlParams.get('vendor') === 'true';
        const hasClientId = urlParams.get('clientId');
        
        // Si no hay par√°metros de autenticaci√≥n, verificar sesi√≥n
        if (!isAdmin && !isVendor) {
            const session = localStorage.getItem('vendorSession');
            
            if (session) {
                const sessionData = JSON.parse(session);
                const now = new Date();
                const expiresAt = new Date(sessionData.expiresAt);
                
                if (now < expiresAt) {
                    console.log('‚úÖ Sesi√≥n v√°lida encontrada');
                    // Redirigir con par√°metros de sesi√≥n
                    const currentUrl = new URL(window.location);
                    if (sessionData.vendorId === '112220831') {
                        currentUrl.searchParams.set('admin', 'true');
                    } else {
                        currentUrl.searchParams.set('vendor', 'true');
                    }
                    window.location.href = currentUrl.toString();
                    return;
                } else {
                    console.log('‚ùå Sesi√≥n expirada');
                    localStorage.removeItem('vendorSession');
                }
            }
            
            // No hay sesi√≥n v√°lida, redirigir al login
            console.log('üîí No hay sesi√≥n v√°lida, redirigiendo al login');
            window.location.href = '/login.html';
            return;
        }
        
        // Si hay par√°metros de autenticaci√≥n, continuar normalmente
        console.log('‚úÖ Acceso autorizado a facturas');
    }
    
    // Ejecutar verificaci√≥n al cargar - DESHABILITADO TEMPORALMENTE
    // checkAuthentication();
    
    // Para testing: mostrar contenido principal si no hay par√°metros de autenticaci√≥n
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === 'true';
    const isVendor = urlParams.get('vendor') === 'true';
    const clientId = urlParams.get('clientId') || urlParams.get('id') || urlParams.get('cliente');
    
    if (!isAdmin && !isVendor) {
        console.log('üß™ Modo testing: mostrando contenido sin autenticaci√≥n');
        
        // Si no hay clientId, usar uno de prueba para cargar datos reales
        if (!clientId) {
            console.log('üß™ No hay clientId, usando ID de prueba: 115760847');
            // Agregar clientId a la URL para que la aplicaci√≥n funcione
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('clientId', '115760847');
            window.history.replaceState({}, '', newUrl);
            
            // Inicializar la aplicaci√≥n con el ID de prueba
            setTimeout(() => {
                if (typeof initializeApp === 'function') {
                    initializeApp();
                }
            }, 500);
        } else {
            // Si hay clientId, inicializar normalmente
            setTimeout(() => {
                if (typeof initializeApp === 'function') {
                    initializeApp();
                }
            }, 500);
        }
    }
    
    // Funci√≥n para forzar la carga de datos
    function forceDataLoad() {
        console.log('üîÑ === FORZANDO CARGA DE DATOS ===');
        
        // Verificar si las funciones est√°n disponibles
        if (typeof window.initializeApp === 'function') {
            console.log('‚úÖ initializeApp disponible, ejecutando...');
            window.initializeApp();
        } else {
            console.log('‚ùå initializeApp no disponible');
        }
        
        // Verificar si hay datos ya cargados
        if (window.clientInvoices && window.clientInvoices.length > 0) {
            console.log('üìä Datos ya cargados, forzando renderizado...');
            
            const overdueInvoices = window.clientInvoices.filter(inv => inv.Estado === 'Vencido');
            const paidInvoices = window.clientInvoices.filter(inv => inv.Estado === 'Pagado');
            
            console.log('  Facturas vencidas:', overdueInvoices.length);
            console.log('  Facturas pagadas:', paidInvoices.length);
            console.log('  Pagos no asignados:', window.unassignedPayments?.length || 0);
            console.log('  Pagos aplicados:', window.assignedPayments?.length || 0);
            
            // Forzar renderizado
            if (typeof window.renderInvoicesSection === 'function') {
                window.renderInvoicesSection('overdue', overdueInvoices);
                window.renderInvoicesSection('paid', paidInvoices);
            }
            
            if (typeof window.renderUnassignedPaymentsSection === 'function') {
                window.renderUnassignedPaymentsSection();
            }
            
            if (typeof window.renderAssignedPaymentsSection === 'function') {
                window.renderAssignedPaymentsSection();
            }
            
            // Forzar actualizaci√≥n de contadores
            if (typeof window.updateTabCounters === 'function') {
                window.updateTabCounters();
            }
            
            // Mostrar contenido principal
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = 'block';
            }
            
            console.log('‚úÖ Renderizado forzado completado');
        } else {
            console.log('‚ùå No hay datos cargados');
        }
        
        console.log('üîÑ === FIN FORZADO DE CARGA ===');
    }
    
    window.forceDataLoad = forceDataLoad;

    // Funci√≥n para probar la funcionalidad b√°sica
    function testBasicFunctionality() {
        console.log('üß™ Prueba B√°sica de Funcionalidad');
        console.log('  - Elementos del DOM:');
        console.log('    mainContent:', document.getElementById('mainContent') ? 'Presente' : 'Ausente');
        console.log('    vencidasPane:', document.getElementById('vencidas-pane') ? 'Presente' : 'Ausente');
        console.log('    noVencidasPane:', document.getElementById('no-vencidas-pane') ? 'Presente' : 'Ausente');
        console.log('    pagadasPane:', document.getElementById('pagadas-pane') ? 'Presente' : 'Ausente');
        console.log('    noAsignadosPane:', document.getElementById('no-asignados-pane') ? 'Presente' : 'Ausente');
        console.log('    aplicadosPane:', document.getElementById('aplicados-pane') ? 'Presente' : 'Ausente');
        console.log('    loading:', document.getElementById('loading') ? 'Presente' : 'Ausente');
        console.log('    errorState:', document.getElementById('errorState') ? 'Presente' : 'Ausente');
        console.log('    clientNameDetail:', document.getElementById('clientNameDetail') ? 'Presente' : 'Ausente');
        console.log('    clientIdDetail:', document.getElementById('clientIdDetail') ? 'Presente' : 'Ausente');
        console.log('    clientDetails:', document.getElementById('clientDetails') ? 'Presente' : 'Ausente');
        console.log('    statsSummary:', document.querySelector('.stats-summary') ? 'Presente' : 'Ausente');
        console.log('    actionsSection:', document.querySelector('.actions-section') ? 'Presente' : 'Ausente');
        console.log('    tabSystem:', document.querySelector('.tab-system') ? 'Presente' : 'Ausente');
        console.log('    tabContent:', document.querySelector('.tab-content') ? 'Presente' : 'Ausente');
        console.log('    vencidasPaneContent:', document.getElementById('vencidas-pane') ? 'Presente' : 'Ausente');
        console.log('    noVencidasPaneContent:', document.getElementById('no-vencidas-pane') ? 'Presente' : 'Ausente');
        console.log('    pagadasPaneContent:', document.getElementById('pagadas-pane') ? 'Presente' : 'Ausente');
        console.log('    noAsignadosPaneContent:', document.getElementById('no-asignados-pane') ? 'Presente' : 'Ausente');
        console.log('    aplicadosPaneContent:', document.getElementById('aplicados-pane') ? 'Presente' : 'Ausente');
        console.log('    loadingOverlay:', document.getElementById('loadingOverlay') ? 'Presente' : 'Ausente');
        console.log('    receiptModal:', document.getElementById('receiptModal') ? 'Presente' : 'Ausente');
        console.log('    editInvoiceModal:', document.getElementById('editInvoiceModal') ? 'Presente' : 'Ausente');
        console.log('    deleteInvoiceModal:', document.getElementById('deleteInvoiceModal') ? 'Presente' : 'Ausente');
        console.log('    manualInvoiceModal:', document.getElementById('manualInvoiceModal') ? 'Presente' : 'Ausente');
        console.log('    paymentDistributionModal:', document.getElementById('paymentDistributionModal') ? 'Presente' : 'Ausente');
        console.log('  - Funciones disponibles:');
        console.log('    initializeApp:', typeof window.initializeApp);
        console.log('    renderInvoicesSection:', typeof window.renderInvoicesSection);
        console.log('    renderUnassignedPaymentsSection:', typeof window.renderUnassignedPaymentsSection);
        console.log('    renderAssignedPaymentsSection:', typeof window.renderAssignedPaymentsSection);
        console.log('    openManualInvoiceModal:', typeof window.openManualInvoiceModal);
        console.log('    sendAccountStatement:', typeof window.sendAccountStatement);
        console.log('    assignPaymentToInvoice:', typeof window.assignPaymentToInvoice);
        console.log('    updateTabCounters:', typeof window.updateTabCounters);
        console.log('    loadNoVencidasInvoices:', typeof window.loadNoVencidasInvoices);
        console.log('    renderNoVencidasInvoices:', typeof window.renderNoVencidasInvoices);
        console.log('    switchMainTab:', typeof window.switchMainTab);
        console.log('    switchSubTab:', typeof window.switchSubTab);
        console.log('    debugPageState:', typeof window.debugPageState);
        console.log('    checkAuthentication:', typeof window.checkAuthentication);
        console.log('    forceDataLoad:', typeof window.forceDataLoad);
        console.log('    testBasicFunctionality:', typeof window.testBasicFunctionality);
        console.log('üß™ Prueba B√°sica de Funcionalidad Completada');
    }

    window.testBasicFunctionality = testBasicFunctionality;
</script>

<!-- Bot√≥n Volver al Inicio -->
<a href="index.html" class="home-button" title="Volver al Inicio">
    üè†
</a>

</body>
</html> 