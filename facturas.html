<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Facturas del Cliente</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Local Stylesheets -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <!-- Navigation -->
    <div class="navigation">
        <button class="btn btn-secondary btn-large" onclick="goBackToClients()">
            â† Volver a Clientes
        </button>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>Facturas del Cliente</h1>
        <p id="clientName">Cargando informaciÃ³n del cliente...</p>
    </div>

    <!-- Section Controls -->
    <div class="section-controls">
        <div class="controls-header">
            <div class="controls-title">
                ğŸ›ï¸ Control de Vista
            </div>
            <div class="quick-actions">
                <button class="btn-control" onclick="toggleAllSections(true)">
                    ğŸ‘ï¸ Mostrar Todo
                </button>
                <button class="btn-control" onclick="toggleAllSections(false)">
                    ğŸ™ˆ Ocultar Todo
                </button>
                <button class="btn-control" onclick="showOnlyActive()">
                    âš¡ Solo Activos
                </button>
            </div>
        </div>

        <div class="controls-grid">
            <div class="control-item active" id="control-unassigned" onclick="toggleSection('unassigned')">
                <div class="control-info">
                    <div class="control-icon">ğŸ’°</div>
                    <div class="control-text">
                        <div class="control-label">Pagos Sin Asignar</div>
                        <div class="control-count" id="control-count-unassigned">0 pagos pendientes</div>
                    </div>
                </div>
                <div class="control-toggle active" id="toggle-unassigned"></div>
            </div>

            <div class="control-item active" id="control-overdue" onclick="toggleSection('overdue')">
                <div class="control-info">
                    <div class="control-icon">ğŸ”´</div>
                    <div class="control-text">
                        <div class="control-label">Facturas Vencidas</div>
                        <div class="control-count" id="control-count-overdue">0 facturas vencidas</div>
                    </div>
                </div>
                <div class="control-toggle active" id="toggle-overdue"></div>
            </div>

            <div class="control-item active" id="control-pending" onclick="toggleSection('pending')">
                <div class="control-info">
                    <div class="control-icon">ğŸŸ¡</div>
                    <div class="control-text">
                        <div class="control-label">Facturas Pendientes</div>
                        <div class="control-count" id="control-count-pending">0 facturas pendientes</div>
                    </div>
                </div>
                <div class="control-toggle active" id="toggle-pending"></div>
            </div>

            <div class="control-item active" id="control-assigned" onclick="toggleSection('assigned')">
                <div class="control-info">
                    <div class="control-icon">âœ…</div>
                    <div class="control-text">
                        <div class="control-label">Pagos Aplicados</div>
                        <div class="control-count" id="control-count-assigned">0 pagos aplicados</div>
                    </div>
                </div>
                <div class="control-toggle active" id="toggle-assigned"></div>
            </div>

            <div class="control-item active" id="control-paid" onclick="toggleSection('paid')">
                <div class="control-info">
                    <div class="control-icon">ğŸŸ¢</div>
                    <div class="control-text">
                        <div class="control-label">Facturas Pagadas</div>
                        <div class="control-count" id="control-count-paid">0 facturas pagadas</div>
                    </div>
                </div>
                <div class="control-toggle active" id="toggle-paid"></div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Cargando facturas y pagos aplicados...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState" style="display: none;">
        <h3>âŒ Error al cargar datos</h3>
        <p id="errorMessage">No se pudieron cargar las facturas del cliente</p>
        <button class="btn btn-primary" onclick="retryLoad()" style="margin-top: 16px;">
            ğŸ”„ Reintentar
        </button>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Client Information -->
        <div class="client-info">
            <div class="client-header">
                <div>
                    <h2 id="clientNameDetail">Cliente</h2>
                    <p id="clientIdDetail" style="color: #86868b;">ID: </p>
                </div>
            </div>
            <div class="client-details" id="clientDetails">
                <!-- Se llenarÃ¡ dinÃ¡micamente -->
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="stats-summary">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value stat-paid" id="statPaid">0</div>
                    <div class="stat-label">Pagadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-pending" id="statPending">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-overdue" id="statOverdue">0</div>
                    <div class="stat-label">Vencidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-fines" id="statFines">â‚¡0</div>
                    <div class="stat-label">Total Multas</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="actions-section">
            <button class="btn btn-primary btn-large" onclick="openManualInvoiceModal()">
                â• Crear Factura Manual
            </button>
            <button class="btn btn-warning btn-large" style="margin-left: 12px;" onclick="sendAccountStatement()">
                ğŸ“ Estado de Cuenta - Arrendamiento
            </button>
            <button class="btn btn-info btn-large" style="margin-left: 12px;" onclick="syncWithBackend()">
                ğŸ”„ Sincronizar con Backend
            </button>
        </div>

        <!-- Unassigned Payments Section -->
        <div class="invoices-section" id="unassignedPaymentsSection">
            <div class="section-header">
                <h3 class="section-title">
                    ğŸ’° Pagos Relacionados No Asignados
                    <span class="section-count" id="unassignedPaymentsCount">0</span>
                </h3>
                <small style="color: #86868b; font-size: 0.8rem;">Pagos encontrados por ID_Cliente directo O ID en Observaciones</small>
                <button class="btn btn-info btn-sm" style="margin-left: 12px;" onclick="openPaymentAssignmentModal()">
                    ğŸ¦ Ver Transacciones Bancarias
                </button>
                <button class="btn btn-warning btn-sm" style="margin-left: 8px;" onclick="testTransactionSystem()">
                    ğŸ§ª Probar Sistema
                </button>
                <button class="btn btn-info btn-sm" style="margin-left: 8px;" onclick="testCurrencyFormat()">
                    ğŸ’° Probar Moneda
                </button>
                <button class="btn btn-success btn-sm" style="margin-left: 8px;" onclick="testDynamicFiltering()">
                    ğŸ” Probar Filtrado
                </button>
            </div>
            <div class="invoices-grid" id="unassignedPayments"></div>
            <div class="empty-section" id="emptyUnassignedPayments" style="display: none;">
                <h4>ğŸ“‹ No hay pagos sin asignar</h4>
                <p>Todos los pagos estÃ¡n correctamente asignados a facturas</p>
            </div>
        </div>

        <!-- Overdue Invoices Section -->
        <div class="invoices-section section-overdue" id="overdueSection">
            <div class="section-header">
                <h3 class="section-title">
                    ğŸ”´ Facturas Vencidas
                    <span class="section-count" id="overdueCount">0</span>
                </h3>
                <small style="color: #86868b; font-size: 0.8rem;">Incluye facturas que vencen HOY (sin multa) y las ya vencidas (con multa)</small>
            </div>
            <div class="invoices-grid" id="overdueInvoices"></div>
            <div class="empty-section" id="emptyOverdue" style="display: none;">
                <h4>âœ… No hay facturas vencidas</h4>
                <p>No hay facturas que venzan hoy o ya vencidas</p>
            </div>
        </div>

        <!-- Pending Invoices Section -->
        <div class="invoices-section section-pending" id="pendingSection">
            <div class="section-header">
                <h3 class="section-title">
                    ğŸŸ¡ Facturas Pendientes
                    <span class="section-count" id="pendingCount">0</span>
                </h3>
                <small style="color: #86868b; font-size: 0.8rem;">Facturas que aÃºn no han vencido</small>
            </div>
            <div class="invoices-grid" id="pendingInvoices"></div>
            <div class="empty-section" id="emptyPending" style="display: none;">
                <h4>ğŸ“„ No hay facturas pendientes</h4>
                <p>Todas las facturas han vencido o estÃ¡n pagadas</p>
            </div>
        </div>

        <!-- Assigned Payments Section -->
        <div class="invoices-section" id="assignedPaymentsSection">
            <div class="section-header">
                <h3 class="section-title">
                    âœ… Pagos Aplicados
                    <span class="section-count section-paid" id="assignedPaymentsCount">0</span>
                </h3>
                <small style="color: #86868b; font-size: 0.8rem;">Pagos ya asignados a facturas - Ordenados por fecha del comprobante bancario</small>
            </div>
            <div class="invoices-grid" id="assignedPayments"></div>
            <div class="empty-section" id="emptyAssignedPayments" style="display: none;">
                <h4>ğŸ“„ No hay pagos aplicados</h4>
                <p>AÃºn no se han asignado pagos a facturas</p>
            </div>
        </div>

        <!-- Paid Invoices Section -->
        <div class="invoices-section section-paid" id="paidSection">
            <div class="section-header">
                <h3 class="section-title">
                    ğŸŸ¢ Facturas Pagadas
                    <span class="section-count" id="paidCount">0</span>
                </h3>
                <small style="color: #86868b; font-size: 0.8rem;">Ordenadas por fecha de pago (mÃ¡s recientes primero)</small>
            </div>
            <div class="invoices-grid" id="paidInvoices"></div>
            <div class="empty-section" id="emptyPaid" style="display: none;">
                <h4>ğŸ“„ No hay facturas pagadas</h4>
                <p>AÃºn no se han registrado pagos</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h4 style="margin-bottom: 8px; color: #25d366;">ğŸš€ Enviando al Grupo de WhatsApp</h4>
        <p style="color: #666; margin: 0;">Generando PDF del recibo y enviando automÃ¡ticamente...</p>
        <small style="color: #999; margin-top: 8px; display: block;">Powered by ULTRAMSG</small>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal-overlay" id="receiptModal" onclick="closeReceiptModal()">
    <div class="modal-content receipt-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>ğŸ§¾ Recibo de Pago</h3>
            <button class="modal-close" onclick="closeReceiptModal()">âœ•</button>
        </div>

        <div class="modal-body" style="padding: 0;">
            <div class="receipt-container" id="receiptContent">
                <!-- Receipt content generated dynamically -->
            </div>

            <div class="receipt-modal-actions">
                <div class="receipt-actions-left">
                    <button type="button" class="btn btn-secondary" onclick="closeReceiptModal()">
                        Cerrar
                    </button>
                    <button type="button" class="btn btn-download" onclick="downloadReceiptPDF()">
                        ğŸ“„ Descargar PDF
                    </button>
                    <button type="button" class="btn btn-warning" onclick="sendToWhatsAppManual()">
                        ğŸ“± EnvÃ­o Manual
                    </button>
                </div>
                <div class="receipt-actions-right">
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">
                        ğŸ–¨ï¸ Imprimir
                    </button>
                    <button type="button" class="btn btn-whatsapp" onclick="sendToWhatsApp()">
                        ğŸš€ Enviar a Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Invoice Modal -->
<div class="modal-overlay" id="editInvoiceModal" onclick="closeEditInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>âœï¸ Editar Factura</h3>
            <button class="modal-close" onclick="closeEditInvoiceModal()">âœ•</button>
        </div>

        <div class="modal-body">
            <form id="editInvoiceForm">
                <input type="hidden" id="editInvoiceNumber" />

                <div class="form-group">
                    <label>NÃºmero de Factura</label>
                    <input type="text" id="editInvoiceNumberDisplay" disabled>
                </div>

                <div class="form-group">
                    <label for="editInvoiceConcept">Concepto *</label>
                    <select id="editInvoiceConcept" required>
                        <option value="">Seleccione un concepto</option>
                        <option value="Arrendamiento Semanal">Arrendamiento Semanal</option>
                        <option value="Multa por Retraso">Multa por Retraso</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Combustible">Combustible</option>
                        <option value="ReparaciÃ³n">ReparaciÃ³n</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Documentos">Tramites de Documentos</option>
                        <option value="Multa de TrÃ¡nsito">Multa de TrÃ¡nsito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editInvoiceDescription">DescripciÃ³n</label>
                    <textarea id="editInvoiceDescription" placeholder="DescripciÃ³n detallada del concepto"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editInvoiceAmount">Monto Base (â‚¡) *</label>
                        <input type="number" id="editInvoiceAmount" min="1" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="editInvoiceDueDate">Fecha de Vencimiento *</label>
                        <input type="date" id="editInvoiceDueDate" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editInvoiceStatus">Estado *</label>
                        <select id="editInvoiceStatus" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Vencido">Vencido</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </div>

                    <div class="form-group" id="editPaymentDateGroup" style="display: none;">
                        <label for="editInvoicePaymentDate">Fecha de Pago</label>
                        <input type="date" id="editInvoicePaymentDate">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditInvoiceModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Invoice Modal -->
<div class="modal-overlay" id="deleteInvoiceModal" onclick="closeDeleteInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 400px;">
        <div class="modal-header">
            <h3>ğŸ—‘ï¸ Eliminar Factura</h3>
            <button class="modal-close" onclick="closeDeleteInvoiceModal()">âœ•</button>
        </div>

        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="font-size: 3rem; margin-bottom: 16px;">âš ï¸</div>
                <h4 style="margin-bottom: 8px;">Â¿EstÃ¡ seguro?</h4>
                <p style="color: #86868b; margin-bottom: 16px;">
                    Esta acciÃ³n eliminarÃ¡ permanentemente la factura:
                </p>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; font-weight: 600;" id="deleteInvoiceInfo">
                    <!-- Se llenarÃ¡ dinÃ¡micamente -->
                </div>
            </div>

            <div class="form-actions" style="margin-top: 0; border: none; padding: 0;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteInvoiceModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteInvoice()" id="confirmDeleteBtn">
                    ğŸ—‘ï¸ Eliminar Factura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manual Invoice Modal -->
<div class="modal-overlay" id="manualInvoiceModal" onclick="closeManualInvoiceModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>â• Crear Factura Manual</h3>
            <button class="modal-close" onclick="closeManualInvoiceModal()">âœ•</button>
        </div>

        <div class="modal-body">
            <form id="manualInvoiceForm">
                <div class="form-group">
                    <label for="invoiceConcept">Concepto *</label>
                    <select id="invoiceConcept" required>
                        <option value="">Seleccione un concepto</option>
                        <option value="Arrendamiento Semanal">Arrendamiento Semanal</option>
                        <option value="Multa por Retraso">Multa por Retraso</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                        <option value="Seguro">Seguro</option>
                        <option value="Combustible">Combustible</option>
                        <option value="ReparaciÃ³n">ReparaciÃ³n</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Documentos">Tramites de Documentos</option>
                        <option value="Multa de TrÃ¡nsito">Multa de TrÃ¡nsito</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoiceDescription">DescripciÃ³n</label>
                    <textarea id="invoiceDescription" placeholder="DescripciÃ³n detallada del concepto (opcional)"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceAmount">Monto (â‚¡) *</label>
                        <input type="number" id="invoiceAmount" min="1" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="invoiceDueDate">Fecha de Vencimiento *</label>
                        <input type="date" id="invoiceDueDate" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeManualInvoiceModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        âœ… Crear Factura
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Distribution Modal -->
<div class="modal-overlay" id="paymentDistributionModal" onclick="closePaymentDistributionModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 700px;">
        <div class="modal-header">
            <h3>ğŸ’° DistribuciÃ³n de Pago</h3>
            <button class="modal-close" onclick="closePaymentDistributionModal()">âœ•</button>
        </div>

        <div class="modal-body">
            <div id="paymentDistributionInfo"></div>
            <div id="invoicesDistributionList"></div>
            <div id="distributionSummary"></div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePaymentDistributionModal()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="confirmDistributionBtn" onclick="confirmPaymentDistribution()">
                    âœ… Aplicar DistribuciÃ³n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="utils.js"></script>
<script src="payment-management.js"></script>
<script src="invoice-crud.js"></script>
<script src="receipt-whatsapp.js"></script>
<script src="main.js"></script>
<script src="client-management.js"></script>
<script>
const ULTRAMSG_TOKEN = 'wp98xs1qrfhqg9ya';
const ULTRAMSG_INSTANCE_ID = 'instance112077';
const ULTRAMSG_API_URL = `https://api.ultramsg.com/${ULTRAMSG_INSTANCE_ID}/messages/chat?token=${ULTRAMSG_TOKEN}`;
// Enviar estado de cuenta al cliente por UltraMSG
function sendAccountStatement() {
    const fechaHoy = new Date().toLocaleDateString('es-CR');
    const cliente = window.currentClient || { Nombre: 'NOMBRE CLIENTE', Placa: 'PLACA', Cedula: 'CEDULA' };
    const facturas = window.clientInvoices || [];
    const assignedPayments = window.assignedPayments || [];

    // Filtrar solo facturas vencidas (Estado: 'Vencido')
    const vencidas = facturas.filter(f => f.Estado === 'Vencido');
    if (vencidas.length === 0) {
        alert('No hay facturas vencidas para este cliente.');
        return;
    }

    let totalPendiente = 0;
    let totalMultas = 0;
    let totalPagos = 0;
    let detalleFacturas = vencidas.map(f => {
        // Calcular dÃ­as de atraso (consistente con backend)
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const fechaVencimiento = new Date(f.FechaVencimiento);
        fechaVencimiento.setHours(0, 0, 0, 0);
        const diasAtraso = Math.floor((hoy - fechaVencimiento) / (1000 * 60 * 60 * 24));
        
        // Calcular multa (consistente con backend: â‚¡2,000 por dÃ­a)
        const multaCalculada = diasAtraso > 0 ? diasAtraso * 2000 : 0;
        
        const saldo = parseFloat(f.MontoBase || 0);
        
        // Buscar pagos aplicados a esta factura (usando campos normalizados)
        const pagosAplicados = assignedPayments.reduce((sum, p) => {
            if (p.Assignments && Array.isArray(p.Assignments)) {
                return sum + p.Assignments
                    .filter(a => a.invoiceNumber == f.NumeroFactura)
                    .reduce((aSum, a) => aSum + parseFloat(a.amount || 0), 0);
            }
            return sum;
        }, 0);
        
        // Calcular saldo pendiente (consistente con backend)
        const saldoPendiente = saldo - pagosAplicados;
        const totalConMulta = saldoPendiente + multaCalculada;
        
        totalPendiente += totalConMulta;
        totalMultas += multaCalculada;
        totalPagos += pagosAplicados;
        
        return (
            `* ${f.NumeroFactura} (${f.SemanaDescripcion || ''})\n` +
            `â–¶ Fecha: ${f.FechaVencimiento}\n` +
            `â–¶ DÃ­as vencido: ${diasAtraso}\n` +
            `â–¶ Monto original: â‚¡ ${saldo.toLocaleString('es-CR')}\n` +
            (pagosAplicados > 0 ? `â–¶ Pagos aplicados: â‚¡ ${pagosAplicados.toLocaleString('es-CR')}\n` : '') +
            (pagosAplicados > 0 ? `â–¶ Saldo pendiente: â‚¡ ${saldoPendiente.toLocaleString('es-CR')}\n` : '') +
            (multaCalculada > 0 ? `â–¶ Multa: â‚¡ ${multaCalculada.toLocaleString('es-CR')}\n` : '') +
            `âœ… Total a pagar: â‚¡ ${totalConMulta.toLocaleString('es-CR')}\n`
        );
    }).join('\n');

    // Resumen final (consistente con backend)
    let resumenFinal = '';
    if (totalPagos > 0) {
        resumenFinal = `ğŸ“Š *RESUMEN*\n` +
            `ğŸ’° Total pagos recibidos: â‚¡ ${totalPagos.toLocaleString('es-CR')}\n` +
            `ğŸ“Š *Saldo pendiente: â‚¡ ${totalPendiente.toLocaleString('es-CR')}*\n`;
    } else {
        resumenFinal = `ğŸ“Š *Total Pendiente: â‚¡ ${totalPendiente.toLocaleString('es-CR')}*\n`;
    }

    const mensaje = `ğŸ“‹ *Estado de cuenta - Arrendamiento*\n` +
        `ğŸ“… *Fecha:* ${fechaHoy}\n\n` +
        `ğŸ‘¤ ${cliente.Nombre || ''} / ${cliente.Placa || ''} / ${cliente.Cedula || cliente.cedula || ''}\n\n` +
        `${detalleFacturas}\n` +
        `${resumenFinal}` +
        `${'â”€'.repeat(30)}\n\n` +
        `Por favor atender los saldos pendientes. Si ya realizÃ³ el pago omita este mensaje nuestro Departamento Contable lo aplicarÃ¡ pronto. Â¡Gracias! ğŸ™`;

    // Obtener destino WhatsApp (grupo o personal)
    const destino = window.getWhatsAppDestination ? window.getWhatsAppDestination(cliente) : null;
    if (!destino || !destino.id) {
        alert('No se encontrÃ³ grupo de WhatsApp ni nÃºmero personal del cliente.');
        return;
    }

    // Mostrar loading
    document.getElementById('loadingOverlay').style.display = 'flex';

    fetch(ULTRAMSG_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            to: destino.id,
            body: mensaje,
            priority: 10,
            referenceId: 'estado-cuenta',
        })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('loadingOverlay').style.display = 'none';
        if (data.sent || data.status === 'success') {
            alert('Estado de cuenta enviado correctamente al cliente por WhatsApp.');
        } else {
            alert('No se pudo enviar el estado de cuenta.\n' + (data.error || JSON.stringify(data)));
        }
    })
    .catch(err => {
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('Error al enviar el estado de cuenta: ' + err);
    });
}

// FunciÃ³n para sincronizar con backend
async function syncWithBackend() {
    try {
        const clientId = window.currentClient?.ID;
        if (!clientId) {
            alert('No hay cliente seleccionado');
            return;
        }
        
        // Mostrar loading
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Verificar consistencia primero
        const inconsistencies = verifyDataConsistency(clientId);
        
        if (inconsistencies.length > 0) {
            console.log(`âš ï¸ Se encontraron ${inconsistencies.length} inconsistencias, corrigiendo...`);
        }
        
        // Sincronizar con backend
        await syncWithBackendLogic(clientId);
        
        // Ocultar loading
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // Mostrar resultado
        if (inconsistencies.length > 0) {
            showToast(`âœ… SincronizaciÃ³n completada. Se corrigieron ${inconsistencies.length} inconsistencias.`, 'success');
        } else {
            showToast('âœ… SincronizaciÃ³n completada. Los datos estÃ¡n consistentes.', 'success');
        }
        
    } catch (error) {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('Error en sincronizaciÃ³n:', error);
        showToast('âŒ Error durante la sincronizaciÃ³n: ' + error.message, 'error');
    }
}

// FunciÃ³n para probar el filtrado dinÃ¡mico de facturas
function testDynamicFiltering() {
    console.log('ğŸ§ª PROBANDO FILTRADO DINÃMICO DE FACTURAS...');
    
    const clientInvoices = window.clientInvoices || [];
    if (clientInvoices.length === 0) {
        console.log('âŒ No hay facturas para probar');
        return;
    }
    
    console.log(`ğŸ“Š Total de facturas: ${clientInvoices.length}`);
    
    // Verificar que las funciones estÃ©n disponibles
    console.log('ğŸ” Funciones disponibles:');
    console.log('  - calculateInvoiceStatus:', typeof window.calculateInvoiceStatus);
    console.log('  - getOverdueInvoices:', typeof window.getOverdueInvoices);
    console.log('  - getPendingInvoices:', typeof window.getPendingInvoices);
    console.log('  - getPaidInvoices:', typeof window.getPaidInvoices);
    
    // Probar clasificaciÃ³n dinÃ¡mica
    if (typeof window.calculateInvoiceStatus === 'function') {
        console.log('ğŸ“‹ ClasificaciÃ³n individual de facturas:');
        clientInvoices.forEach((invoice, index) => {
            const calculatedStatus = window.calculateInvoiceStatus(invoice);
            const originalStatus = invoice.Estado;
            const dueDate = invoice.FechaVencimiento;
            
            console.log(`  ${index + 1}. ${invoice.NumeroFactura}:`);
            console.log(`     - Estado original: ${originalStatus}`);
            console.log(`     - Estado calculado: ${calculatedStatus}`);
            console.log(`     - Fecha vencimiento: ${dueDate}`);
            
            if (calculatedStatus !== originalStatus) {
                console.log(`     âš ï¸ DIFERENCIA DETECTADA!`);
            }
        });
    }
    
    // Probar filtros
    if (typeof window.getOverdueInvoices === 'function') {
        const overdue = window.getOverdueInvoices(clientInvoices);
        console.log(`ğŸ”´ Facturas vencidas (dinÃ¡mico): ${overdue.length}`);
        overdue.forEach(inv => {
            console.log(`  - ${inv.NumeroFactura} (${inv.FechaVencimiento})`);
        });
    }
    
    if (typeof window.getPendingInvoices === 'function') {
        const pending = window.getPendingInvoices(clientInvoices);
        console.log(`ğŸŸ¡ Facturas pendientes (dinÃ¡mico): ${pending.length}`);
        pending.forEach(inv => {
            console.log(`  - ${inv.NumeroFactura} (${inv.FechaVencimiento})`);
        });
    }
    
    if (typeof window.getPaidInvoices === 'function') {
        const paid = window.getPaidInvoices(clientInvoices);
        console.log(`ğŸŸ¢ Facturas pagadas (dinÃ¡mico): ${paid.length}`);
        paid.forEach(inv => {
            console.log(`  - ${inv.NumeroFactura} (${inv.FechaVencimiento})`);
        });
    }
    
    console.log('âœ… PRUEBA DE FILTRADO DINÃMICO COMPLETADA');
}

// FunciÃ³n para probar el formato de moneda
function testCurrencyFormat() {
    console.log('ğŸ§ª PROBANDO FORMATO DE MONEDA...');
    
    const testAmounts = [115000, 336000, 220000, 214000, 94000, 40000];
    
    console.log('ğŸ’° Montos de prueba:');
    testAmounts.forEach(amount => {
        const formatted = formatCurrency(amount);
        console.log(`  ${amount} â†’ ${formatted}`);
    });
    
    // Verificar que la funciÃ³n estÃ© disponible
    console.log('ğŸ” formatCurrency disponible:', typeof window.formatCurrency);
    
    // Probar con diferentes navegadores
    console.log('ğŸŒ InformaciÃ³n del navegador:');
    console.log('  - User Agent:', navigator.userAgent);
    console.log('  - Language:', navigator.language);
    console.log('  - Languages:', navigator.languages);
    
    // Probar formato nativo
    console.log('ğŸ“Š Formato nativo vs personalizado:');
    testAmounts.forEach(amount => {
        const native = amount.toLocaleString('es-CR');
        const custom = formatCurrency(amount);
        console.log(`  ${amount}: nativo="${native}" | custom="${custom}"`);
    });
}

// FunciÃ³n para probar el sistema de transacciones
async function testTransactionSystem() {
    try {
        console.log('ğŸ§ª INICIANDO PRUEBA DEL SISTEMA DE TRANSACCIONES...');
        
        const clientId = window.currentClient?.ID;
        if (!clientId) {
            console.error('âŒ No hay cliente seleccionado');
            return;
        }
        
        console.log('ğŸ‘¤ Cliente ID:', clientId);
        console.log('ğŸ‘¤ Cliente datos:', window.currentClient);
        
        // Verificar funciones disponibles
        console.log('ğŸ” Verificando funciones...');
        console.log('loadAllUnreconciledTransactions:', typeof window.loadAllUnreconciledTransactions);
        console.log('generateSmartSuggestions:', typeof window.generateSmartSuggestions);
        console.log('switchPaymentTab:', typeof window.switchPaymentTab);
        console.log('loadTransactionsTab:', typeof window.loadTransactionsTab);
        console.log('createPaymentDistributionModal:', typeof window.createPaymentDistributionModal);
        
        // Verificar modales existentes
        console.log('ğŸ” Verificando modales existentes...');
        const modals = ['assignInvoiceModal', 'assignPaymentModal', 'paymentDistributionModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            console.log(`  - ${modalId}:`, modal ? 'EXISTE' : 'NO EXISTE');
        });
        
        // Probar carga de transacciones
        console.log('ğŸ“¥ Probando carga de transacciones...');
        if (typeof window.loadAllUnreconciledTransactions === 'function') {
            const transactions = await window.loadAllUnreconciledTransactions();
            console.log('âœ… Transacciones cargadas:', transactions.length);
            
            if (transactions.length > 0) {
                console.log('ğŸ“‹ Primera transacciÃ³n:', transactions[0]);
                
                // Probar generaciÃ³n de sugerencias
                console.log('ğŸ¯ Probando generaciÃ³n de sugerencias...');
                const clientInvoices = window.clientInvoices || [];
                console.log('ğŸ“„ Facturas del cliente:', clientInvoices.length);
                
                if (typeof window.generateSmartSuggestions === 'function') {
                    const suggestions = window.generateSmartSuggestions(transactions[0], clientInvoices, window.currentClient);
                    console.log('âœ… Sugerencias generadas:', suggestions.length);
                    
                    if (suggestions.length > 0) {
                        console.log('ğŸ† Mejor sugerencia:', suggestions[0]);
                    }
                } else {
                    console.error('âŒ generateSmartSuggestions no estÃ¡ disponible');
                }
            } else {
                console.log('â„¹ï¸ No hay transacciones sin conciliar');
            }
        } else {
            console.error('âŒ loadAllUnreconciledTransactions no estÃ¡ disponible');
        }
        
        // Probar creaciÃ³n de modal
        console.log('ğŸ—ï¸ Probando creaciÃ³n de modal...');
        if (typeof window.createPaymentDistributionModal === 'function') {
            // Limpiar modal existente si existe
            const existingModal = document.getElementById('paymentDistributionModal');
            if (existingModal) {
                existingModal.remove();
                console.log('ğŸ—‘ï¸ Modal existente eliminado');
            }
            
            window.createPaymentDistributionModal();
            console.log('âœ… Modal creado');
            
            // Verificar elementos del modal
            const elements = [
                'paymentDistributionModal',
                'tab-content-transactions',
                'transactionsInfo',
                'transactionsList'
            ];
            
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                console.log(`  - ${elementId}:`, element ? 'EXISTE' : 'NO EXISTE');
            });
        } else {
            console.error('âŒ createPaymentDistributionModal no estÃ¡ disponible');
        }
        
        console.log('âœ… PRUEBA COMPLETADA - Sistema funcionando correctamente');
        
    } catch (error) {
        console.error('âŒ Error en prueba:', error);
        console.error('Stack trace:', error.stack);
    }
}

// FunciÃ³n para limpiar modales existentes
function cleanupExistingModals() {
    console.log('ğŸ§¹ Limpiando modales existentes...');
    
    // Cerrar modales que puedan estar abiertos
    const modals = [
        'assignInvoiceModal',
        'assignPaymentModal',
        'paymentDistributionModal'
    ];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('show');
            console.log(`âœ… Modal ${modalId} cerrado`);
        }
    });
}

// FunciÃ³n para abrir modal de asignaciÃ³n de pagos y transacciones
async function openPaymentAssignmentModal() {
    try {
        const clientId = window.currentClient?.ID;
        if (!clientId) {
            showToast('âŒ No hay cliente seleccionado', 'error');
            return;
        }
        
        console.log('ğŸ”„ Abriendo modal de asignaciÃ³n de pagos y transacciones...');
        console.log('ğŸ‘¤ Cliente ID:', clientId);
        console.log('ğŸ‘¤ Cliente datos:', window.currentClient);
        
        // Limpiar modales existentes
        cleanupExistingModals();
        
        // Verificar que las funciones estÃ©n disponibles
        console.log('ğŸ” Verificando funciones disponibles...');
        console.log('switchPaymentTab disponible:', typeof window.switchPaymentTab);
        console.log('loadTransactionsTab disponible:', typeof window.loadTransactionsTab);
        console.log('loadAllUnreconciledTransactions disponible:', typeof window.loadAllUnreconciledTransactions);
        console.log('createPaymentDistributionModal disponible:', typeof window.createPaymentDistributionModal);
        
        // Verificar si el modal ya existe
        const existingModal = document.getElementById('paymentDistributionModal');
        console.log('ğŸ” Modal existente:', existingModal ? 'SÃ' : 'NO');
        
        // Crear modal si no existe
        if (!existingModal) {
            console.log('ğŸ—ï¸ Creando modal...');
            if (typeof window.createPaymentDistributionModal === 'function') {
                window.createPaymentDistributionModal();
                console.log('âœ… Modal creado');
            } else {
                console.error('âŒ createPaymentDistributionModal no estÃ¡ disponible');
                showToast('âŒ Error: FunciÃ³n de creaciÃ³n de modal no disponible', 'error');
                return;
            }
        } else {
            console.log('âœ… Modal ya existe');
        }
        
        // Verificar que el modal se creÃ³ correctamente
        const modal = document.getElementById('paymentDistributionModal');
        if (!modal) {
            console.error('âŒ Modal no se creÃ³ correctamente');
            showToast('âŒ Error: No se pudo crear el modal', 'error');
            return;
        }
        
        // Mostrar modal
        modal.classList.add('show');
        console.log('ğŸ“± Modal mostrado');
        
        // Verificar que los elementos del modal existen
        const tabContent = document.getElementById('tab-content-transactions');
        const transactionsInfo = document.getElementById('transactionsInfo');
        const transactionsList = document.getElementById('transactionsList');
        
        console.log('ğŸ” Elementos del modal:');
        console.log('  - tab-content-transactions:', tabContent ? 'SÃ' : 'NO');
        console.log('  - transactionsInfo:', transactionsInfo ? 'SÃ' : 'NO');
        console.log('  - transactionsList:', transactionsList ? 'SÃ' : 'NO');
        
        if (!tabContent || !transactionsInfo || !transactionsList) {
            console.error('âŒ Elementos del modal no encontrados');
            showToast('âŒ Error: Estructura del modal incompleta', 'error');
            return;
        }
        
        // Cargar datos iniciales
        console.log('ğŸ“¥ Cargando datos iniciales...');
        await loadUnassignedPayments(clientId);
        await loadAssignedPayments(clientId);
        console.log('âœ… Datos iniciales cargados');
        
        // Cambiar al tab de transacciones bancarias por defecto
        console.log('ğŸ¦ Cambiando al tab de transacciones bancarias...');
        if (typeof window.switchPaymentTab === 'function') {
            window.switchPaymentTab('transactions');
            console.log('âœ… Tab cambiado a transacciones');
        } else {
            console.error('âŒ switchPaymentTab no estÃ¡ disponible');
            showToast('âŒ Error: FunciÃ³n de cambio de tab no disponible', 'error');
            return;
        }
        
        // Cargar transacciones bancarias
        console.log('ğŸ“‹ Cargando transacciones bancarias...');
        if (typeof window.loadTransactionsTab === 'function') {
            await window.loadTransactionsTab();
            console.log('âœ… Transacciones cargadas');
        } else {
            console.error('âŒ loadTransactionsTab no estÃ¡ disponible');
            showToast('âŒ Error: FunciÃ³n de carga de transacciones no disponible', 'error');
            return;
        }
        
        // Habilitar botÃ³n de confirmar
        const confirmBtn = document.getElementById('confirmDistributionBtn');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            console.log('âœ… BotÃ³n de confirmar habilitado');
        }
        
        console.log('âœ… Modal de asignaciÃ³n abierto correctamente');
        
    } catch (error) {
        console.error('âŒ Error abriendo modal de asignaciÃ³n:', error);
        console.error('âŒ Stack trace:', error.stack);
        showToast('âŒ Error abriendo modal: ' + error.message, 'error');
    }
}
</script>
</body>
</html> 