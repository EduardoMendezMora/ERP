<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP - Facturas Vencidas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="navigation">
        <button class="btn btn-secondary btn-large" onclick="goBackToClients()">
            ‚Üê Volver a Clientes
        </button>
    </div>

    <div class="header">
        <h1>üî¥ Facturas Vencidas</h1>
        <p>Gesti√≥n de facturas vencidas y con multas</p>
    </div>

    <div class="search-section">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchOverdue" placeholder="üîç Buscar facturas..." class="search-input">
            </div>
        </div>
    </div>

    <div class="invoices-section" id="overdueSection">
        <div class="section-header">
            <h3 class="section-title">
                üî¥ Facturas Vencidas
                <span class="section-count" id="overdueCount">0</span>
            </h3>
        </div>
        
        <div class="invoices-grid" id="overdueInvoices"></div>
        
        <div class="empty-section" id="emptyOverdue" style="display: none;">
            <h4>‚úÖ No hay facturas vencidas</h4>
            <p>¬°Excelente! Todas las facturas est√°n al d√≠a</p>
        </div>
    </div>
</div>

<script>
    const API_URL_INVOICES = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
    const API_URL_CLIENTS = 'https://sheetdb.io/api/v1/qu62bagiwlgqy';
    
    let allInvoices = [];
    let allClients = [];
    let filteredInvoices = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Iniciando p√°gina de Facturas Vencidas');
        initializePage();
    });

    async function initializePage() {
        try {
            await Promise.all([
                loadInvoices(),
                loadClients()
            ]);
            
            processOverdueInvoices();
            setupEventListeners();
            
        } catch (error) {
            console.error('‚ùå Error al inicializar:', error);
            showToast('Error al cargar datos', 'error');
        }
    }

    async function loadInvoices() {
        const response = await fetch(`${API_URL_INVOICES}?sheet=Facturas`);
        allInvoices = await response.json();
        console.log(`üìÑ Facturas cargadas: ${allInvoices.length}`);
    }

    async function loadClients() {
        const response = await fetch(`${API_URL_CLIENTS}?sheet=Clientes`);
        allClients = await response.json();
        console.log(`üë• Clientes cargados: ${allClients.length}`);
    }

    function processOverdueInvoices() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filteredInvoices = allInvoices.filter(invoice => {
            if (!invoice.FechaVencimiento || invoice.Estado === 'Pagado') {
                return false;
            }
            
            const dueDate = parseDate(invoice.FechaVencimiento);
            if (!dueDate) return false;
            
            return dueDate <= today;
        });
        
        console.log(`üî¥ Facturas vencidas encontradas: ${filteredInvoices.length}`);
        renderOverdueInvoices();
    }

    function renderOverdueInvoices() {
        const container = document.getElementById('overdueInvoices');
        const emptySection = document.getElementById('emptyOverdue');
        const countElement = document.getElementById('overdueCount');
        
        if (filteredInvoices.length === 0) {
            container.innerHTML = '';
            emptySection.style.display = 'block';
            countElement.textContent = '0';
            return;
        }
        
        emptySection.style.display = 'none';
        countElement.textContent = filteredInvoices.length;
        
        const sortedInvoices = filteredInvoices.sort((a, b) => {
            const daysA = getDaysOverdue(a);
            const daysB = getDaysOverdue(b);
            return daysB - daysA;
        });
        
        container.innerHTML = sortedInvoices.map(invoice => {
            const client = allClients.find(c => c.ID.toString() === invoice.ID_Cliente.toString());
            const daysOverdue = getDaysOverdue(invoice);
            const baseAmount = parseAmount(invoice.MontoBase || 0);
            const fineAmount = calculateFine(invoice);
            const totalAmount = baseAmount + fineAmount;
            
            return `
                <div class="invoice-card overdue-card">
                    <div class="invoice-header">
                        <div class="invoice-number">${invoice.NumeroFactura}</div>
                        <div class="invoice-status overdue">${daysOverdue} d√≠as vencida</div>
                    </div>
                    
                    <div class="invoice-client">
                        <strong>${client ? client.Nombre : 'Cliente no encontrado'}</strong>
                    </div>
                    
                    <div class="invoice-description">
                        ${invoice.SemanaDescripcion || 'Sin descripci√≥n'}
                    </div>
                    
                    <div class="invoice-dates">
                        <div class="date-item">
                            <span class="date-label">Vence:</span>
                            <span class="date-value">${formatDate(invoice.FechaVencimiento)}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-amounts">
                        <div class="amount-item">
                            <span class="amount-label">Base:</span>
                            <span class="amount-value">‚Ç°${formatNumber(baseAmount)}</span>
                        </div>
                        <div class="amount-item fine">
                            <span class="amount-label">Multa:</span>
                            <span class="amount-value">‚Ç°${formatNumber(fineAmount)}</span>
                        </div>
                        <div class="amount-item total">
                            <span class="amount-label">Total:</span>
                            <span class="amount-value">‚Ç°${formatNumber(totalAmount)}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-actions">
                        <button class="btn-action" onclick="markAsPaid('${invoice.NumeroFactura}')">
                            ‚úÖ Pagar
                        </button>
                        <button class="btn-action" onclick="editInvoice('${invoice.NumeroFactura}')">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getDaysOverdue(invoice) {
        if (!invoice.FechaVencimiento) return 0;
        
        const dueDate = parseDate(invoice.FechaVencimiento);
        if (!dueDate) return 0;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        dueDate.setHours(0, 0, 0, 0);
        
        const diffTime = today - dueDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return Math.max(0, diffDays);
    }

    function parseAmount(amount) {
        if (!amount) return 0;
        
        // Si ya es un n√∫mero, usarlo directamente
        if (typeof amount === 'number') {
            return amount;
        }
        
        // Convertir a string y limpiar
        const cleanAmount = amount.toString().trim();
        
        // Si est√° vac√≠o, devolver 0
        if (!cleanAmount) return 0;
        
        // Remover caracteres no num√©ricos excepto punto y coma
        const numericOnly = cleanAmount.replace(/[^\d.,]/g, '');
        
        // Si no hay n√∫meros, devolver 0
        if (!numericOnly) return 0;
        
        let result;
        
        if (numericOnly.includes(',')) {
            // Formato: "1.000.000,00" -> 1000000.00
            const normalizedValue = numericOnly.replace(/\./g, '').replace(',', '.');
            result = parseFloat(normalizedValue) || 0;
        } else {
            // Formato: "1000000" o "1.000.000" -> 1000000
            const normalizedValue = numericOnly.replace(/\./g, '');
            result = parseFloat(normalizedValue) || 0;
        }
        
        return result;
    }

    function calculateFine(invoice) {
        const daysOverdue = getDaysOverdue(invoice);
        const baseAmount = parseAmount(invoice.MontoBase || 0);
        
        if (daysOverdue <= 0) return 0;
        
        if (daysOverdue > 30) {
            return baseAmount * 0.10;
        }
        
        if (daysOverdue > 7) {
            return baseAmount * 0.05;
        }
        
        return 0;
    }

    function setupEventListeners() {
        const searchInput = document.getElementById('searchOverdue');
        searchInput.addEventListener('input', function() {
            filterInvoices();
        });
    }

    function filterInvoices() {
        const searchTerm = document.getElementById('searchOverdue').value.toLowerCase();
        
        let filtered = filteredInvoices.filter(invoice => {
            if (searchTerm) {
                const searchText = `${invoice.NumeroFactura} ${invoice.SemanaDescripcion}`.toLowerCase();
                if (!searchText.includes(searchTerm)) return false;
            }
            return true;
        });
        
        renderFilteredInvoices(filtered);
    }

    function renderFilteredInvoices(invoices) {
        const container = document.getElementById('overdueInvoices');
        const countElement = document.getElementById('overdueCount');
        
        countElement.textContent = invoices.length;
        
        if (invoices.length === 0) {
            container.innerHTML = '<div class="empty-section"><h4>üîç No se encontraron facturas</h4><p>Intenta con otros filtros de b√∫squeda</p></div>';
            return;
        }
        
        const sortedInvoices = invoices.sort((a, b) => {
            const daysA = getDaysOverdue(a);
            const daysB = getDaysOverdue(b);
            return daysB - daysA;
        });
        
        container.innerHTML = sortedInvoices.map(invoice => {
            const client = allClients.find(c => c.ID.toString() === invoice.ID_Cliente.toString());
            const daysOverdue = getDaysOverdue(invoice);
            const baseAmount = parseAmount(invoice.MontoBase || 0);
            const fineAmount = calculateFine(invoice);
            const totalAmount = baseAmount + fineAmount;
            
            return `
                <div class="invoice-card overdue-card">
                    <div class="invoice-header">
                        <div class="invoice-number">${invoice.NumeroFactura}</div>
                        <div class="invoice-status overdue">${daysOverdue} d√≠as vencida</div>
                    </div>
                    
                    <div class="invoice-client">
                        <strong>${client ? client.Nombre : 'Cliente no encontrado'}</strong>
                    </div>
                    
                    <div class="invoice-description">
                        ${invoice.SemanaDescripcion || 'Sin descripci√≥n'}
                    </div>
                    
                    <div class="invoice-dates">
                        <div class="date-item">
                            <span class="date-label">Vence:</span>
                            <span class="date-value">${formatDate(invoice.FechaVencimiento)}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-amounts">
                        <div class="amount-item">
                            <span class="amount-label">Base:</span>
                            <span class="amount-value">‚Ç°${formatNumber(baseAmount)}</span>
                        </div>
                        <div class="amount-item fine">
                            <span class="amount-label">Multa:</span>
                            <span class="amount-value">‚Ç°${formatNumber(fineAmount)}</span>
                        </div>
                        <div class="amount-item total">
                            <span class="amount-label">Total:</span>
                            <span class="amount-value">‚Ç°${formatNumber(totalAmount)}</span>
                        </div>
                    </div>
                    
                    <div class="invoice-actions">
                        <button class="btn-action" onclick="markAsPaid('${invoice.NumeroFactura}')">
                            ‚úÖ Pagar
                        </button>
                        <button class="btn-action" onclick="editInvoice('${invoice.NumeroFactura}')">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function parseDate(dateString) {
        if (!dateString) return null;
        
        if (dateString.includes('/')) {
            const parts = dateString.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                return new Date(year, month, day);
            }
        }
        
        return new Date(dateString);
    }

    function formatDate(dateString) {
        const date = parseDate(dateString);
        if (!date) return dateString;
        
        return date.toLocaleDateString('es-CR');
    }

    function formatNumber(number) {
        if (number === null || number === undefined || isNaN(number)) {
            return '0';
        }
        
        // Convertir a n√∫mero si es string
        const num = typeof number === 'string' ? parseFloat(number.replace(/[^\d.,]/g, '').replace(',', '.')) : parseFloat(number);
        
        if (isNaN(num)) {
            return '0';
        }
        
        return new Intl.NumberFormat('es-CR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            background: ${type === 'error' ? '#ff4444' : type === 'success' ? '#00c851' : '#2196F3'};
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function goBackToClients() {
        window.location.href = 'clientes.html';
    }

    async function markAsPaid(invoiceNumber) {
        try {
            const params = new URLSearchParams();
            params.append('sheet', 'Facturas');
            params.append('Estado', 'Pagado');
            params.append('FechaPago', new Date().toLocaleDateString('es-CR'));
            
            const response = await fetch(`${API_URL_INVOICES}/NumeroFactura/${invoiceNumber}?${params.toString()}`, {
                method: 'PATCH'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            showToast('Factura marcada como pagada', 'success');
            
            await loadInvoices();
            processOverdueInvoices();
            
        } catch (error) {
            console.error('‚ùå Error al marcar como pagada:', error);
            showToast('Error al actualizar factura', 'error');
        }
    }

    function editInvoice(invoiceNumber) {
        showToast('Funci√≥n de edici√≥n en desarrollo', 'info');
    }
</script>
</body>
</html>
