// ===== PRUEBA ESPEC√çFICA: FACTURAS NO VENCIDAS =====
// Este archivo prueba espec√≠ficamente la carga de facturas no vencidas

console.log('üß™ INICIANDO PRUEBA ESPEC√çFICA: FACTURAS NO VENCIDAS');

// ===== 1. PRUEBA DE FUNCI√ìN GETUPCOMINGINVOICES =====
function probarGetUpcomingInvoices() {
    console.log('\nüìÖ 1. PRUEBA DE FUNCI√ìN GETUPCOMINGINVOICES');
    
    try {
        // Verificar si la funci√≥n existe
        if (typeof getUpcomingInvoices !== 'function') {
            console.error('‚ùå Funci√≥n getUpcomingInvoices no encontrada');
            return;
        }
        
        console.log('‚úÖ Funci√≥n getUpcomingInvoices encontrada');
        
        // Obtener facturas actuales
        const invoices = clientInvoices || window.clientInvoices || [];
        console.log(`üìã Total facturas disponibles: ${invoices.length}`);
        
        // Probar la funci√≥n
        const upcoming = getUpcomingInvoices(invoices, 2);
        console.log(`üìÖ Facturas pr√≥ximas obtenidas: ${upcoming.length}`);
        
        if (upcoming.length > 0) {
            console.log('üìã Ejemplos de facturas pr√≥ximas:');
            upcoming.forEach((inv, index) => {
                console.log(`  ${index + 1}. ${inv.NumeroFactura}: ${inv.FechaVencimiento} (${inv.Estado})`);
            });
        } else {
            console.log('‚ö†Ô∏è No se encontraron facturas pr√≥ximas');
        }
        
    } catch (error) {
        console.error('‚ùå Error probando getUpcomingInvoices:', error);
    }
}

// ===== 2. PRUEBA DE FILTRADO MANUAL =====
function probarFiltradoManual() {
    console.log('\nüîç 2. PRUEBA DE FILTRADO MANUAL');
    
    try {
        const invoices = clientInvoices || window.clientInvoices || [];
        console.log(`üìã Total facturas: ${invoices.length}`);
        
        if (invoices.length === 0) {
            console.log('‚ö†Ô∏è No hay facturas para filtrar');
            return;
        }
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        console.log(`üìÖ Fecha de referencia (hoy): ${today.toISOString().split('T')[0]}`);
        
        // Filtrar facturas pendientes
        const pendientes = invoices.filter(inv => inv.Estado === 'Pendiente');
        console.log(`üìã Facturas con estado "Pendiente": ${pendientes.length}`);
        
        // Filtrar facturas que vencen en el futuro
        const futuras = invoices.filter(inv => {
            if (!inv.FechaVencimiento) return false;
            const fecha = parseDate(inv.FechaVencimiento);
            if (!fecha) return false;
            return fecha > today;
        });
        console.log(`üìÖ Facturas que vencen en el futuro: ${futuras.length}`);
        
        // Filtrar facturas no vencidas (pendientes + futuras)
        const noVencidas = invoices.filter(inv => {
            if (inv.Estado === 'Pendiente') return true;
            if (!inv.FechaVencimiento) return false;
            const fecha = parseDate(inv.FechaVencimiento);
            if (!fecha) return false;
            return fecha > today;
        });
        console.log(`üìã Facturas no vencidas (combinado): ${noVencidas.length}`);
        
        // Mostrar ejemplos
        if (noVencidas.length > 0) {
            console.log('üìã Ejemplos de facturas no vencidas:');
            noVencidas.slice(0, 5).forEach((inv, index) => {
                const fecha = parseDate(inv.FechaVencimiento);
                const diasHastaVencimiento = fecha ? Math.ceil((fecha - today) / (1000 * 60 * 60 * 24)) : 'N/A';
                console.log(`  ${index + 1}. ${inv.NumeroFactura}: ${inv.FechaVencimiento} (${inv.Estado}) - ${diasHastaVencimiento} d√≠as`);
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error en filtrado manual:', error);
    }
}

// ===== 3. PRUEBA DE PARSEO DE FECHAS =====
function probarParseoFechas() {
    console.log('\nüìÖ 3. PRUEBA DE PARSEO DE FECHAS');
    
    try {
        const invoices = clientInvoices || window.clientInvoices || [];
        
        if (invoices.length === 0) {
            console.log('‚ö†Ô∏è No hay facturas para probar fechas');
            return;
        }
        
        // Verificar funci√≥n parseDate
        if (typeof parseDate !== 'function') {
            console.error('‚ùå Funci√≥n parseDate no encontrada');
            return;
        }
        
        console.log('‚úÖ Funci√≥n parseDate encontrada');
        
        // Probar con algunas fechas
        const fechasPrueba = [
            '05/08/2025',
            '2025-08-05',
            '05-08-2025',
            'invalid-date',
            '',
            null
        ];
        
        console.log('üß™ Probando parseo de fechas:');
        fechasPrueba.forEach(fecha => {
            const resultado = parseDate(fecha);
            console.log(`  "${fecha}" -> ${resultado ? resultado.toISOString().split('T')[0] : 'null'}`);
        });
        
        // Verificar fechas problem√°ticas en las facturas
        const fechasProblematicas = invoices.filter(inv => {
            if (!inv.FechaVencimiento) return true;
            const fecha = parseDate(inv.FechaVencimiento);
            return !fecha || isNaN(fecha.getTime());
        });
        
        if (fechasProblematicas.length > 0) {
            console.warn(`‚ö†Ô∏è Facturas con fechas problem√°ticas: ${fechasProblematicas.length}`);
            fechasProblematicas.slice(0, 3).forEach(inv => {
                console.log(`  - ${inv.NumeroFactura}: "${inv.FechaVencimiento}"`);
            });
        } else {
            console.log('‚úÖ Todas las fechas se parsean correctamente');
        }
        
    } catch (error) {
        console.error('‚ùå Error probando parseo de fechas:', error);
    }
}

// ===== 4. PRUEBA DE RENDERIZADO DE SECCI√ìN =====
function probarRenderizadoSeccion() {
    console.log('\nüé® 4. PRUEBA DE RENDERIZADO DE SECCI√ìN');
    
    try {
        // Verificar si la funci√≥n existe
        if (typeof renderInvoicesSection !== 'function') {
            console.error('‚ùå Funci√≥n renderInvoicesSection no encontrada');
            return;
        }
        
        console.log('‚úÖ Funci√≥n renderInvoicesSection encontrada');
        
        // Verificar elementos del DOM
        const elementos = [
            'upcomingInvoices',
            'upcomingCount',
            'emptyUpcoming'
        ];
        
        console.log('üîç Verificando elementos del DOM:');
        elementos.forEach(elementId => {
            const elemento = document.getElementById(elementId);
            console.log(`  ${elementId}: ${elemento ? '‚úÖ Encontrado' : '‚ùå No encontrado'}`);
        });
        
        // Obtener facturas pr√≥ximas
        const invoices = clientInvoices || window.clientInvoices || [];
        const upcoming = getUpcomingInvoices(invoices, 2);
        
        console.log(`üìã Facturas pr√≥ximas para renderizar: ${upcoming.length}`);
        
        // Intentar renderizar (si los elementos existen)
        const container = document.getElementById('upcomingInvoices');
        if (container) {
            console.log('üé® Intentando renderizar secci√≥n...');
            try {
                renderInvoicesSection('upcoming', upcoming);
                console.log('‚úÖ Renderizado completado');
                console.log(`üìä Contenido del contenedor: ${container.innerHTML.length} caracteres`);
            } catch (error) {
                console.error('‚ùå Error durante el renderizado:', error);
            }
        } else {
            console.log('‚ö†Ô∏è Contenedor no encontrado, no se puede renderizar');
        }
        
    } catch (error) {
        console.error('‚ùå Error probando renderizado:', error);
    }
}

// ===== 5. PRUEBA DE CARGA COMPLETA =====
async function probarCargaCompleta() {
    console.log('\nüîÑ 5. PRUEBA DE CARGA COMPLETA');
    
    try {
        const clientId = currentClientId || window.currentClientId;
        if (!clientId) {
            console.error('‚ùå No hay ID de cliente disponible');
            return;
        }
        
        console.log(`üÜî Cliente ID: ${clientId}`);
        
        // Verificar funci√≥n de carga
        if (typeof loadClientAndInvoices !== 'function') {
            console.error('‚ùå Funci√≥n loadClientAndInvoices no encontrada');
            return;
        }
        
        console.log('‚úÖ Funci√≥n loadClientAndInvoices encontrada');
        
        // Probar recarga
        console.log('üîÑ Iniciando recarga de datos...');
        const startTime = Date.now();
        
        await loadClientAndInvoices(clientId);
        
        const endTime = Date.now();
        const loadTime = endTime - startTime;
        
        console.log(`‚úÖ Recarga completada en ${loadTime}ms`);
        
        // Verificar resultados
        const invoices = clientInvoices || window.clientInvoices || [];
        const upcoming = getUpcomingInvoices(invoices, 2);
        
        console.log(`üìä Resultados despu√©s de la recarga:`);
        console.log(`  - Total facturas: ${invoices.length}`);
        console.log(`  - Facturas pr√≥ximas: ${upcoming.length}`);
        
        if (upcoming.length > 0) {
            console.log('üìã Facturas pr√≥ximas encontradas:');
            upcoming.forEach((inv, index) => {
                console.log(`  ${index + 1}. ${inv.NumeroFactura}: ${inv.FechaVencimiento}`);
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error en carga completa:', error);
    }
}

// ===== 6. PRUEBA DE OPTIMIZACI√ìN =====
function probarOptimizacion() {
    console.log('\n‚ö° 6. PRUEBA DE OPTIMIZACI√ìN');
    
    try {
        // Verificar funciones de optimizaci√≥n
        const funciones = [
            'filterInvoicesOptimized',
            'loadInvoicesOptimized'
        ];
        
        console.log('üîç Verificando funciones de optimizaci√≥n:');
        funciones.forEach(funcName => {
            const func = eval(funcName);
            console.log(`  ${funcName}: ${typeof func === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible'}`);
        });
        
        // Verificar si se est√° aplicando el filtrado
        if (typeof filterInvoicesOptimized === 'function') {
            console.log('‚úÖ Funci√≥n de optimizaci√≥n disponible');
            
            // Simular datos para probar
            const mockInvoices = [
                { NumeroFactura: 'TEST-001', FechaVencimiento: '05/08/2025', Estado: 'Pendiente' },
                { NumeroFactura: 'TEST-002', FechaVencimiento: '15/08/2025', Estado: 'Pendiente' },
                { NumeroFactura: 'TEST-003', FechaVencimiento: '25/08/2025', Estado: 'Pendiente' }
            ];
            
            console.log('üß™ Probando filtrado optimizado con datos de prueba...');
            const filtered = filterInvoicesOptimized(mockInvoices);
            console.log(`üìä Resultado: ${filtered.length} de ${mockInvoices.length} facturas filtradas`);
            
        } else {
            console.log('‚ö†Ô∏è Funci√≥n de optimizaci√≥n no disponible');
        }
        
    } catch (error) {
        console.error('‚ùå Error probando optimizaci√≥n:', error);
    }
}

// ===== FUNCI√ìN PRINCIPAL DE PRUEBA =====
async function ejecutarPruebaCompleta() {
    console.log('üöÄ EJECUTANDO PRUEBA COMPLETA DE FACTURAS NO VENCIDAS');
    console.log('=' .repeat(80));
    
    try {
        // Ejecutar todas las pruebas
        probarGetUpcomingInvoices();
        probarFiltradoManual();
        probarParseoFechas();
        probarRenderizadoSeccion();
        await probarCargaCompleta();
        probarOptimizacion();
        
        console.log('\n' + '=' .repeat(80));
        console.log('‚úÖ PRUEBA COMPLETADA');
        console.log('üìã Revisa los resultados arriba para identificar problemas espec√≠ficos');
        
    } catch (error) {
        console.error('‚ùå Error durante la prueba:', error);
    }
}

// ===== FUNCI√ìN DE PRUEBA R√ÅPIDA =====
function pruebaRapida() {
    console.log('‚ö° PRUEBA R√ÅPIDA DE FACTURAS NO VENCIDAS');
    
    const invoices = clientInvoices || window.clientInvoices || [];
    const noVencidas = invoices.filter(inv => inv.Estado === 'Pendiente');
    const upcoming = getUpcomingInvoices(invoices, 2);
    
    console.log(`üìä Resultados r√°pidos:`);
    console.log(`  - Total facturas: ${invoices.length}`);
    console.log(`  - Pendientes: ${noVencidas.length}`);
    console.log(`  - Pr√≥ximas (getUpcomingInvoices): ${upcoming.length}`);
    
    if (upcoming.length === 0 && noVencidas.length > 0) {
        console.log('‚ö†Ô∏è POSIBLE PROBLEMA: Hay facturas pendientes pero getUpcomingInvoices no las encuentra');
        console.log('üìã Ejemplos de facturas pendientes:');
        noVencidas.slice(0, 3).forEach(inv => {
            console.log(`  - ${inv.NumeroFactura}: ${inv.FechaVencimiento}`);
        });
    }
}

// ===== EXPONER FUNCIONES GLOBALMENTE =====
window.ejecutarPruebaCompleta = ejecutarPruebaCompleta;
window.pruebaRapida = pruebaRapida;

console.log('‚úÖ Prueba de facturas no vencidas cargada - Usa ejecutarPruebaCompleta() o pruebaRapida()');
